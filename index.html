<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ScoutPro AI v4.0 - FBA Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', -apple-system, sans-serif;
  }
  .font-mono {
    font-family: 'JetBrains Mono', monospace;
  }
  .decision-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }
  .dot-green { background: #10b981; }
  .dot-yellow { background: #fbbf24; }
  .dot-red { background: #ef4444; }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  .animate-slide-in {
    animation: slideIn 0.3s ease-out;
  }
</style>
</head>
<body class="bg-gray-950 text-white min-h-screen">

<!-- ============================================ -->
<!-- MAIN SCAN PAGE -->
<!-- ============================================ -->
<div id="mainPage" class="max-w-md mx-auto pb-32">
  
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-gray-950 border-b border-gray-800 p-3">
    <div class="flex items-center justify-between mb-3">
      <div class="text-lg font-bold">ScoutPro AI</div>
      <div class="flex items-center gap-2">
        <button id="settingsBtn" class="p-2 hover:bg-gray-800 rounded-lg transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          </svg>
        </button>
        <div class="px-3 py-1 bg-blue-500/10 border border-blue-500/30 rounded-full text-xs font-semibold text-blue-400">
          v4.0
        </div>
      </div>
    </div>
    
    <!-- Scanner Input -->
    <div class="grid grid-cols-[1fr_auto_auto] gap-2">
      <input 
        type="text" 
        id="isbnInput" 
        placeholder="Scan or enter ISBN/ASIN"
        autocomplete="off"
        class="px-4 py-3 rounded-xl bg-gray-900 border border-gray-800 text-white font-mono text-sm focus:outline-none focus:border-blue-500 transition"
      />
      <button id="scanBtn" class="px-4 py-3 bg-gray-900 border border-gray-800 rounded-xl hover:bg-gray-800 transition">
        üì∑
      </button>
      <button id="lookupBtn" class="px-6 py-3 bg-blue-600 rounded-xl font-semibold hover:bg-blue-700 transition">
        GO
      </button>
    </div>
  </header>

  <!-- Status Bar -->
  <div class="mx-3 mt-3 px-4 py-2 bg-gray-900 rounded-lg font-mono text-xs text-gray-400 flex justify-between items-center">
    <div class="flex items-center gap-2">
      <span id="statusText">Ready to scan</span>
      <span id="keepaModeIndicator" class="hidden px-2 py-0.5 rounded text-[10px] font-bold"></span>
    </div>
    <span id="profitTally" class="text-blue-400">
      <span class="font-semibold">Queue:</span> 0 | <span class="font-semibold">Profit:</span> $0
    </span>
  </div>

  <!-- Duplicate Warning -->
  <div id="dupeWarning" class="hidden mx-3 mt-3 px-4 py-2 bg-yellow-500/10 border border-yellow-500/50 rounded-lg text-yellow-400 text-sm">
    ‚ö†Ô∏è Already scanned this item
  </div>

  <!-- Processing -->
  <div id="processing" class="hidden mx-3 mt-3 p-6 bg-gray-900 rounded-2xl border border-gray-800 text-center">
    <div class="w-10 h-10 mx-auto mb-4 border-3 border-gray-800 border-t-blue-500 rounded-full animate-spin"></div>
    <div class="text-sm text-gray-400">Analyzing with Keepa...</div>
  </div>

  <!-- Sliders (Always Visible) -->
  <div class="mx-3 mt-3 p-4 bg-gray-900 rounded-xl border border-gray-800 space-y-4">
    <div>
      <label class="flex justify-between text-xs font-semibold text-gray-400 mb-2">
        <span>Buy Cost</span>
        <span id="buyCostValue" class="text-white font-mono">$1.00</span>
      </label>
      <input type="range" id="buyCostSlider" min="0.25" max="10" step="0.25" value="1.00" class="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer slider">
    </div>
    <div>
      <label class="flex justify-between text-xs font-semibold text-gray-400 mb-2">
        <span>Profit Floor</span>
        <span id="profitFloorValue" class="text-white font-mono">$5.00</span>
      </label>
      <input type="range" id="profitFloorSlider" min="1" max="15" step="0.50" value="5.00" class="w-full h-2 bg-gray-800 rounded-lg appearance-none cursor-pointer slider">
    </div>
  </div>

  <!-- Result Card -->
  <div id="resultCard" class="hidden mx-3 mt-3 bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
    
    <!-- Decision Banner -->
    <div id="banner" class="p-6 text-center border-b border-gray-800">
      <div id="gemBadge" class="hidden inline-flex items-center gap-2 px-3 py-1 bg-gradient-to-r from-yellow-500 to-orange-500 rounded-full text-xs font-bold text-black mb-2">
        <span>‚ú®</span>
        HIDDEN GEM
      </div>
      <div id="decisionText" class="text-3xl font-bold mb-2 flex items-center justify-center">
        <!-- Decision word goes here -->
      </div>
      <div id="confidence" class="text-sm text-gray-400 font-mono mb-3">Confidence: --</div>
      <div id="bookTitle" class="text-sm text-gray-300 leading-relaxed">--</div>
    </div>

    <!-- Key Metrics -->
    <div class="p-4 border-b border-gray-800 space-y-2 text-sm">
      <div class="flex justify-between">
        <span class="text-gray-400">Avg Sale Price (6 mo)</span>
        <span id="avgPrice" class="font-mono font-semibold">--</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-400">6-Month Sales</span>
        <span id="salesVolume" class="font-mono font-semibold">--</span>
      </div>
      <div class="flex justify-between">
        <span class="text-gray-400">Est. Profit</span>
        <span id="profitValue" class="font-mono font-semibold text-green-400">--</span>
      </div>
    </div>

    <!-- Gemini Section -->
    <div id="geminiSection" class="hidden p-4 border-b border-gray-800">
      <button id="askGeminiBtn" class="w-full px-4 py-3 bg-purple-600/20 border border-purple-500/50 rounded-xl text-purple-300 font-semibold hover:bg-purple-600/30 transition">
        Ask Gemini for more detail
      </button>
      <div id="geminiResult" class="hidden mt-4"></div>
    </div>

    <!-- Explanation/Reasoning -->
    <div id="explanation" class="p-4 text-sm text-gray-300 leading-relaxed">
      <!-- Reasoning text goes here -->
    </div>

    <!-- Hidden Gems Details -->
    <div id="gemDetails" class="hidden p-4 bg-yellow-500/5 border-t border-yellow-500/20">
      <details class="text-sm" open>
        <summary class="font-semibold text-yellow-400 cursor-pointer mb-2">‚ú® Why This is a Hidden Gem</summary>
        <div id="gemReasons" class="space-y-1 text-gray-300 ml-4">
          <!-- Gem reasons go here -->
        </div>
      </details>
    </div>
  </div>

</div>

<!-- ============================================ -->
<!-- HISTORY PAGE -->
<!-- ============================================ -->
<div id="historyPage" class="hidden max-w-md mx-auto pb-32">
  <div class="sticky top-0 z-50 bg-gray-950 border-b border-gray-800 p-4 flex items-center gap-3">
    <button id="backBtn" class="p-2 hover:bg-gray-800 rounded-lg transition">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
      </svg>
    </button>
    <div class="text-lg font-bold flex-1">Scan History</div>
  </div>
  
  <div id="historyList" class="p-3 space-y-3">
    <!-- History items go here -->
  </div>
</div>

<!-- ============================================ -->
<!-- SETTINGS MODAL -->
<!-- ============================================ -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
  <div class="bg-gray-900 rounded-2xl border border-gray-800 max-w-md w-full p-6 space-y-4">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-bold">Settings</h2>
      <button id="closeSettingsBtn" class="p-2 hover:bg-gray-800 rounded-lg transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-400 mb-2">Keepa API Key</label>
      <input type="password" id="keepaKeyInput" placeholder="Enter Keepa API key" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm focus:outline-none focus:border-blue-500">
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-400 mb-2">Gemini API Key</label>
      <input type="password" id="geminiKeyInput" placeholder="Enter Gemini API key" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm focus:outline-none focus:border-blue-500">
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-400 mb-2">Token Budget (per session)</label>
      <input type="number" id="tokenBudgetInput" value="500" min="100" max="5000" step="100" class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-sm focus:outline-none focus:border-blue-500">
    </div>

    <div class="pt-4 border-t border-gray-800">
      <div class="text-xs text-gray-400 mb-2">Keepa Tokens</div>
      <div id="tokenStatus" class="font-mono text-sm text-green-400">Available: Unknown</div>
    </div>

    <button id="saveSettingsBtn" class="w-full px-4 py-3 bg-blue-600 rounded-xl font-semibold hover:bg-blue-700 transition">
      Save Settings
    </button>
  </div>
</div>

<!-- ============================================ -->
<!-- BOTTOM NAV -->
<!-- ============================================ -->
<div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 p-3 z-40">
  <div class="max-w-md mx-auto grid grid-cols-3 gap-2">
    <button id="historyBtn" class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl font-semibold text-sm hover:bg-gray-700 transition">
      History
    </button>
    <button id="downloadBtn" class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl font-semibold text-sm hover:bg-gray-700 transition">
      Export CSV
    </button>
    <button id="clearBtn" class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-xl font-semibold text-sm hover:bg-gray-700 transition">
      Clear
    </button>
  </div>
</div>

<script>
/* =====================================================
   SCOUTPRO AI v4.0 - CLEAN REBUILD (FBA EDITION)
   
   Architecture:
   1. CONFIG - Settings and constants
   2. STATE - Centralized app state
   3. SCANNER - Bluetooth scanner (FROZEN - DO NOT MODIFY)
   4. KEEPA - API client with token management
   5. GEMINI - Optional AI advisor
   6. DECISION ENGINE - FBA-first buy/reject logic
   7. UI RENDERERS - Display functions
   8. EVENT HANDLERS - User interactions
   ===================================================== */

// =====================================================
// 1. CONFIG
// =====================================================
const CONFIG = {
  KEEPA_DOMAIN: 'api.keepa.com',
  // CORS proxies - try these in order if direct call fails
  CORS_PROXIES: [
    'https://api.allorigins.win/raw?url=',
    'https://corsproxy.io/?',
    'https://cors-anywhere.herokuapp.com/',
    '' // Empty string = direct call (no proxy)
  ],
  BUY_COST_DEFAULT: 1.00,
  PROFIT_FLOOR_DEFAULT: 5.00,
  SHIPPING_TO_AMAZON: 0.75,
  TOKEN_BUDGET_DEFAULT: 500,
  BORDERLINE_CONFIDENCE_RANGE: [45, 65],
  BORDERLINE_PROFIT_BUFFER: 1.50,
  RESTRICTED_BRANDS: ['Apple', 'Sony', 'Samsung', 'Microsoft', 'Nintendo', 'LEGO', 'Hasbro']
};

// =====================================================
// 2. STATE
// =====================================================
const AppState = {
  settings: {
    buyCost: parseFloat(localStorage.getItem('buyCost')) || CONFIG.BUY_COST_DEFAULT,
    profitFloor: parseFloat(localStorage.getItem('profitFloor')) || CONFIG.PROFIT_FLOOR_DEFAULT,
    keepaKey: localStorage.getItem('keepaKey') || '',
    geminiKey: localStorage.getItem('geminiKey') || '',
    tokenBudget: parseInt(localStorage.getItem('tokenBudget')) || CONFIG.TOKEN_BUDGET_DEFAULT
  },
  runtime: {
    lastScanData: null,
    history: [],
    buyQueue: [],
    scannedIdentifiers: new Set(),
    tokensUsed: 0,
    geminiCache: new Map()
  },
  keepa: {
    mode: 'LIVE', // or 'SIMULATED'
    tokensRemaining: null
  }
};

// Initialize sliders from saved state
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('buyCostSlider').value = AppState.settings.buyCost;
  document.getElementById('profitFloorSlider').value = AppState.settings.profitFloor;
  document.getElementById('buyCostValue').textContent = `$${AppState.settings.buyCost.toFixed(2)}`;
  document.getElementById('profitFloorValue').textContent = `$${AppState.settings.profitFloor.toFixed(2)}`;
  updateProfitTally();
});

// =====================================================
// 3. SCANNER (FROZEN - EXACT COPY FROM WORKING VERSION)
// =====================================================
let scanBuffer = '';
let scanTimeout = null;
const SCAN_COMPLETE_DELAY = 100;

document.getElementById('isbnInput').addEventListener('input', function(e) {
  const currentValue = e.target.value;
  
  // Scanner detection: rapid input without user typing
  const now = Date.now();
  if (!this.lastInputTime || (now - this.lastInputTime) < 50) {
    clearTimeout(scanTimeout);
    scanBuffer = currentValue;
    
    scanTimeout = setTimeout(() => {
      if (scanBuffer && scanBuffer.length >= 10) {
        handleScannedIdentifier(scanBuffer.trim());
        scanBuffer = '';
        this.value = '';
      }
    }, SCAN_COMPLETE_DELAY);
  }
  
  this.lastInputTime = now;
});

document.getElementById('isbnInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const value = this.value.trim();
    if (value) {
      handleScannedIdentifier(value);
      this.value = '';
    }
  }
});

document.getElementById('lookupBtn').addEventListener('click', () => {
  const value = document.getElementById('isbnInput').value.trim();
  if (value) {
    handleScannedIdentifier(value);
    document.getElementById('isbnInput').value = '';
  }
});

document.getElementById('scanBtn').addEventListener('click', () => {
  document.getElementById('isbnInput').focus();
});

// =====================================================
// 4. KEEPA CLIENT
// =====================================================
const KeepaClient = {
  detectIdentifierType(input) {
    const cleaned = input.replace(/[^0-9XB]/gi, '').toUpperCase();
    
    // ASIN format (B + 9 characters)
    if (/^B[0-9A-Z]{9}$/i.test(input)) {
      return { type: 'asin', value: input.toUpperCase() };
    }
    
    // ISBN-10 or ISBN-13 or UPC
    if (cleaned.length === 10 || cleaned.length === 13 || (cleaned.length >= 12 && cleaned.length <= 14)) {
      return { type: 'code', value: cleaned };
    }
    
    // Default to treating as ASIN/code
    return { type: 'code', value: input };
  },

  async fetchProduct(identifier) {
    const key = AppState.settings.keepaKey;
    
    if (!key) {
      console.log('No Keepa key - using simulated data');
      AppState.keepa.mode = 'SIMULATED';
      return this.generateSimulatedData(identifier);
    }

    // Detect what type of identifier this is
    const detected = this.detectIdentifierType(identifier);
    console.log(`Detected identifier type: ${detected.type} = ${detected.value}`);

    try {
      AppState.keepa.mode = 'LIVE';
      
      // Build Keepa URL with proper parameter (asin= or code=)
      const queryParam = detected.type === 'asin' 
        ? `asin=${encodeURIComponent(detected.value)}`
        : `code=${encodeURIComponent(detected.value)}`;
      
      const keepaUrl = `https://api.keepa.com/product?key=${key}&domain=1&${queryParam}&stats=180&history=1`;
      
      // Use CORS proxy (same as old app)
      const corsProxy = 'https://corsproxy.io/?';
      const url = corsProxy + encodeURIComponent(keepaUrl);
      
      console.log('Keepa API call:', keepaUrl.replace(key, 'HIDDEN'));
      console.log('Full proxy URL:', url.substring(0, 50) + '...');
      
      const response = await fetch(url);
      
      if (!response.ok) {
        if (response.status === 429) {
          throw new Error('Rate limit reached');
        }
        throw new Error(`Keepa API error: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('Keepa response received:', data);
      
      // Check for errors
      if (data.error) {
        const errorMsg = data.error.message || data.error;
        console.error('Keepa error:', errorMsg);
        throw new Error(errorMsg);
      }
      
      // Check if product found
      if (!data.products || data.products.length === 0) {
        console.log('Product not found in Keepa database');
        AppState.keepa.mode = 'SIMULATED';
        UI.setStatus('‚ö†Ô∏è Not in Keepa - using estimated data');
        return this.generateSimulatedData(detected.value);
      }
      
      const product = data.products[0];
      AppState.runtime.tokensUsed += (data.tokensConsumed || 1);
      AppState.keepa.tokensRemaining = data.tokensLeft;
      
      console.log(`‚úì Keepa success! Product: ${product.title}`);
      console.log(`‚úì Tokens left: ${data.tokensLeft}`);
      
      return this.parseKeepaProduct(product);
      
    } catch (error) {
      console.error('Keepa fetch error:', error);
      
      // If it's a "not found" error, use simulated quietly
      if (error.message.includes('not found') || error.message.includes('Invalid product identifier')) {
        AppState.keepa.mode = 'SIMULATED';
        UI.setStatus('‚ö†Ô∏è Not in Keepa - using estimated data');
        return this.generateSimulatedData(detected.value);
      }
      
      // For other errors, alert and fallback
      console.log(`Keepa error: ${error.message} - falling back to simulated`);
      AppState.keepa.mode = 'SIMULATED';
      UI.setStatus('Keepa unavailable - using estimated data');
      return this.generateSimulatedData(detected.value);
    }
  },

  parseKeepaProduct(product) {
    const stats = product.stats || {};
    const current = stats.current || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    
    // Extract FBA price (index 7 = FBA offers)
    const fbaPrice = current[7] > 0 ? current[7] / 100 : null;
    const buyBoxPrice = current[18] > 0 ? current[18] / 100 : null;
    const amazonPrice = current[0] > 0 ? current[0] / 100 : null;
    
    // Sales rank
    const salesRank = current[3] || 0;
    const drops30 = stats.salesRankDrops30 || 0;
    const drops90 = stats.salesRankDrops90 || 0;
    const drops180 = stats.salesRankDrops180 || 0;
    
    return {
      asin: product.asin,
      title: product.title || 'Unknown Title',
      brand: product.brand || null,
      salesRank,
      salesRankDrops30: drops30,
      salesRankDrops90: drops90,
      salesRankDrops180: drops180,
      fbaPrice,
      buyBoxPrice,
      amazonPrice,
      buyBoxWinner: fbaPrice && Math.abs(fbaPrice - (buyBoxPrice || 0)) < 0.50 ? 'FBA' : 'Other',
      weight: product.packageWeight || 500,
      category: product.categoryTree ? product.categoryTree[0]?.name : 'Books',
      restrictionWarning: this.checkRestrictions(product)
    };
  },

  checkRestrictions(product) {
    if (product.brand && CONFIG.RESTRICTED_BRANDS.some(b => 
      product.brand.toLowerCase().includes(b.toLowerCase())
    )) {
      return `‚ö†Ô∏è Restricted brand: ${product.brand}`;
    }
    return null;
  },

  generateSimulatedData(asin) {
    // Simulated data for testing
    const simulatedRank = Math.floor(Math.random() * 1000000) + 100000;
    const simulatedPrice = (Math.random() * 20 + 10).toFixed(2);
    
    return {
      asin,
      title: `Simulated Book - ${asin}`,
      brand: null,
      salesRank: simulatedRank,
      salesRankDrops30: Math.floor(Math.random() * 50) + 10,
      salesRankDrops90: Math.floor(Math.random() * 150) + 30,
      salesRankDrops180: Math.floor(Math.random() * 300) + 60,
      fbaPrice: parseFloat(simulatedPrice),
      buyBoxPrice: parseFloat(simulatedPrice),
      amazonPrice: parseFloat((parseFloat(simulatedPrice) * 1.1).toFixed(2)),
      buyBoxWinner: 'FBA',
      weight: 500,
      category: 'Books',
      restrictionWarning: null,
      _simulated: true
    };
  }
};

// =====================================================
// 5. GEMINI CLIENT
// =====================================================
const GeminiClient = {
  async analyze(keepaData, decision) {
    const key = AppState.settings.geminiKey;
    
    if (!key) {
      return {
        analysis: 'Gemini API key not configured. Add your key in Settings to use AI analysis.',
        recommendation: null
      };
    }

    // Check cache
    const cacheKey = `${keepaData.asin}-${decision.targetPrice}-${decision.profit}`;
    if (AppState.runtime.geminiCache.has(cacheKey)) {
      return AppState.runtime.geminiCache.get(cacheKey);
    }

    try {
      const prompt = this.buildPrompt(keepaData, decision);
      
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: prompt }]
          }]
        })
      });

      const data = await response.json();
      const text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No response';
      
      const result = this.parseResponse(text);
      AppState.runtime.geminiCache.set(cacheKey, result);
      
      return result;
    } catch (error) {
      console.error('Gemini error:', error);
      return {
        analysis: `Error: ${error.message}`,
        recommendation: null
      };
    }
  },

  buildPrompt(keepaData, decision) {
    return `You are advising an experienced Amazon FBA bookseller. Your job is to evaluate whether this book is worth buying for FBA resale ONLY. Ignore FBM strategies.

BOOK DETAILS:
- Title: ${keepaData.title}
- ASIN: ${keepaData.asin}
- Sales Rank: ${keepaData.salesRank.toLocaleString()}
- Rank Drops (30/90/180 days): ${keepaData.salesRankDrops30}/${keepaData.salesRankDrops90}/${keepaData.salesRankDrops180}
- Current FBA Price: $${keepaData.fbaPrice || 'N/A'}
- Buy Box: ${keepaData.buyBoxWinner}
${keepaData.brand ? `- Brand: ${keepaData.brand}` : ''}

DECISION MATH:
- Target FBA Price: $${decision.targetPrice.toFixed(2)}
- Est. Profit: $${decision.profit.toFixed(2)}
- ROI: ${decision.roi}%
- Confidence: ${decision.confidence}%

Focus on:
1. FBA demand outlook
2. FBA competition risk
3. Price stability
4. Storage/long-tail risk
5. Any book-specific red flags

Format your response as:
‚Ä¢ [Point about demand]
‚Ä¢ [Point about competition]
‚Ä¢ [Point about risks]

Then end with EXACTLY this format:
Recommendation: BUY
or
Recommendation: REJECT`;
  },

  parseResponse(text) {
    const lines = text.split('\n').filter(l => l.trim());
    const recommendation = lines.find(l => l.toLowerCase().includes('recommendation:'));
    
    let rec = null;
    if (recommendation) {
      if (recommendation.toLowerCase().includes('buy')) rec = 'BUY';
      else if (recommendation.toLowerCase().includes('reject')) rec = 'REJECT';
    }

    return {
      analysis: text,
      recommendation: rec
    };
  }
};

// =====================================================
// 6. DECISION ENGINE (FBA-FIRST)
// =====================================================
const DecisionEngine = {
  analyze(keepaData) {
    const buyCost = AppState.settings.buyCost;
    const profitFloor = AppState.settings.profitFloor;
    
    // Target price: FBA-first
    const targetPrice = this.calculateTargetPrice(keepaData);
    
    // Fees
    const fees = this.estimateFBAFees(targetPrice, keepaData.weight);
    const totalCOGS = buyCost + CONFIG.SHIPPING_TO_AMAZON;
    
    // Profit calc
    const profit = targetPrice - totalCOGS - fees.total;
    const roi = Math.round((profit / Math.max(0.01, totalCOGS)) * 100);
    
    // Velocity signals
    const velocity = this.computeVelocity(keepaData);
    
    // Effective floor (adjusted for velocity)
    const effectiveFloor = this.getEffectiveFloor(profitFloor, velocity);
    
    // Slow mover check
    const slowMover = keepaData.salesRank >= 900000 && velocity.drops30 < 5;
    
    // Decision logic
    let verdict, reasoning;
    
    if (profit < 0) {
      verdict = 'REJECT';
      reasoning = `‚úó Not profitable<br>‚úó Est. loss: $${Math.abs(profit).toFixed(2)}<br>‚úó Fees: $${fees.total.toFixed(2)}`;
    } else if (slowMover && profit < (profitFloor * 1.25)) {
      verdict = 'REJECT';
      reasoning = `‚úó Slow mover (rank ${keepaData.salesRank.toLocaleString()}, ${keepaData.salesRankDrops30} drops/30d)<br>‚úó Profit $${profit.toFixed(2)} too low for storage risk`;
    } else if (profit < effectiveFloor) {
      verdict = 'REJECT';
      reasoning = `‚úó Profit $${profit.toFixed(2)} below floor ($${effectiveFloor.toFixed(2)})<br>‚úó ROI: ${roi}%<br>‚úó Target: $${targetPrice.toFixed(2)}`;
    } else {
      verdict = 'BUY';
      const velocityTag = velocity.band === 'FAST' ? '‚úì Good velocity' : '‚úì Acceptable velocity';
      reasoning = `‚úì Profit: $${profit.toFixed(2)} (${roi}% ROI)<br>${velocityTag}<br>‚úì Target: $${targetPrice.toFixed(2)} ‚Ä¢ BB: ${keepaData.buyBoxWinner}`;
    }
    
    // Confidence
    const confidence = this.computeConfidence(keepaData, velocity, { verdict }, profit, effectiveFloor);
    
    // Check if low confidence should reject
    if (verdict === 'BUY' && confidence < 50) {
      verdict = 'REJECT';
      reasoning = `‚úó Low confidence (${confidence}%)<br>‚úó Profit exists but signals weak<br>‚úó Rank: ${keepaData.salesRank.toLocaleString()} ‚Ä¢ Drops: ${keepaData.salesRankDrops30}`;
    }
    
    return {
      verdict,
      targetPrice,
      profit,
      roi,
      reasoning,
      confidence,
      velocity,
      fees,
      isBorderline: this.isBorderline(confidence, profit, profitFloor)
    };
  },

  calculateTargetPrice(keepaData) {
    // Priority: FBA > BuyBox (if FBA) > Amazon
    if (keepaData.fbaPrice && keepaData.fbaPrice > 5) {
      return keepaData.fbaPrice;
    }
    if (keepaData.buyBoxPrice && keepaData.buyBoxWinner === 'FBA' && keepaData.buyBoxPrice > 5) {
      return keepaData.buyBoxPrice;
    }
    if (keepaData.amazonPrice && keepaData.amazonPrice > 5) {
      return keepaData.amazonPrice * 0.95; // Slight discount
    }
    return 15.00; // Fallback
  },

  estimateFBAFees(price, weight) {
    const referral = price * 0.15;
    const closing = price < 10 ? 0 : 0;
    
    let fulfillment = 3.22; // Standard book
    if (weight > 1000) fulfillment = 4.75;
    if (weight > 2000) fulfillment = 6.50;
    
    return {
      referral,
      closing,
      fulfillment,
      total: referral + closing + fulfillment
    };
  },

  computeVelocity(keepaData) {
    const drops30 = keepaData.salesRankDrops30 || 0;
    const drops90 = keepaData.salesRankDrops90 || 0;
    
    let band = 'SLOW';
    if (drops30 >= 20) band = 'FAST';
    else if (drops30 >= 10) band = 'MODERATE';
    
    const acceleration = drops90 > 0 ? (drops30 / (drops90 / 3)) : 1;
    
    return { drops30, drops90, band, acceleration };
  },

  getEffectiveFloor(baseFloor, velocity) {
    if (velocity.band === 'FAST') return baseFloor * 0.8;
    if (velocity.band === 'SLOW') return baseFloor * 1.2;
    return baseFloor;
  },

  computeConfidence(keepaData, velocity, decision, profit, effectiveFloor) {
    let score = 50;
    
    // Profit margin
    const margin = profit - effectiveFloor;
    if (margin > 3) score += 20;
    else if (margin > 1.5) score += 10;
    else if (margin < 0) score -= 20;
    
    // Velocity
    if (velocity.band === 'FAST') score += 15;
    else if (velocity.band === 'SLOW') score -= 10;
    
    // Rank
    if (keepaData.salesRank < 100000) score += 10;
    else if (keepaData.salesRank < 500000) score += 5;
    else if (keepaData.salesRank > 900000) score -= 10;
    
    // Buy Box
    if (keepaData.buyBoxWinner === 'FBA') score += 5;
    
    return Math.max(0, Math.min(100, score));
  },

  isBorderline(confidence, profit, profitFloor) {
    const [minConf, maxConf] = CONFIG.BORDERLINE_CONFIDENCE_RANGE;
    const confBorderline = confidence >= minConf && confidence <= maxConf;
    const profitBorderline = Math.abs(profit - profitFloor) <= CONFIG.BORDERLINE_PROFIT_BUFFER;
    
    return confBorderline || profitBorderline;
  },

  detectHiddenGems(keepaData, decision) {
    const gems = [];
    
    // High ROI
    if (decision.roi > 150) {
      gems.push({
        label: 'High ROI',
        icon: 'üí∞',
        details: `${decision.roi}% return on investment`
      });
    }
    
    // Fast mover + profit
    if (decision.velocity.band === 'FAST' && decision.profit > 7) {
      gems.push({
        label: 'Fast Seller',
        icon: '‚ö°',
        details: `${decision.velocity.drops30} rank drops in 30 days`
      });
    }
    
    // Low rank + profit
    if (keepaData.salesRank < 50000 && decision.profit > 5) {
      gems.push({
        label: 'Top Seller',
        icon: 'üèÜ',
        details: `Rank: ${keepaData.salesRank.toLocaleString()}`
      });
    }
    
    return gems;
  }
};

// =====================================================
// 7. UI RENDERERS
// =====================================================
const UI = {
  showProcessing(show) {
    document.getElementById('processing').classList.toggle('hidden', !show);
  },

  showDuplicateWarning(show) {
    document.getElementById('dupeWarning').classList.toggle('hidden', !show);
  },

  setStatus(text) {
    document.getElementById('statusText').textContent = text;
    
    // Update Keepa mode indicator
    const indicator = document.getElementById('keepaModeIndicator');
    if (AppState.keepa.mode === 'LIVE') {
      indicator.classList.remove('hidden', 'bg-yellow-500/20', 'text-yellow-400');
      indicator.classList.add('bg-green-500/20', 'text-green-400');
      indicator.textContent = 'LIVE';
    } else if (AppState.keepa.mode === 'SIMULATED') {
      indicator.classList.remove('hidden', 'bg-green-500/20', 'text-green-400');
      indicator.classList.add('bg-yellow-500/20', 'text-yellow-400');
      indicator.textContent = 'SIMULATED';
    }
  },

  renderDecision(decision, keepaData) {
    AppState.runtime.lastScanData = { decision, keepaData };
    
    const card = document.getElementById('resultCard');
    const banner = document.getElementById('banner');
    const decisionText = document.getElementById('decisionText');
    
    // Decision text + dot
    let dotClass, displayText;
    if (decision.verdict === 'BUY') {
      dotClass = 'dot-green';
      displayText = decision.isBorderline ? 'BORDERLINE BUY' : 'BUY';
    } else {
      dotClass = 'dot-red';
      displayText = 'REJECT';
    }
    
    decisionText.innerHTML = `<span class="decision-dot ${dotClass}"></span>${displayText}`;
    
    // Confidence
    document.getElementById('confidence').textContent = `Confidence: ${decision.confidence}`;
    
    // Title
    document.getElementById('bookTitle').textContent = keepaData.title;
    
    // Metrics
    const avgPrice = keepaData.fbaPrice || keepaData.buyBoxPrice || keepaData.amazonPrice || 0;
    document.getElementById('avgPrice').textContent = `$${avgPrice.toFixed(2)}`;
    document.getElementById('salesVolume').textContent = `${keepaData.salesRankDrops180} drops`;
    document.getElementById('profitValue').textContent = `$${decision.profit.toFixed(2)}`;
    
    // Explanation
    let explanation = decision.reasoning;
    if (keepaData.restrictionWarning) {
      explanation += `<br><br><div class="mt-2 p-2 bg-yellow-500/10 border border-yellow-500/50 rounded text-yellow-400 text-xs">${keepaData.restrictionWarning}</div>`;
    }
    document.getElementById('explanation').innerHTML = explanation;
    
    // Hidden gems
    const gems = DecisionEngine.detectHiddenGems(keepaData, decision);
    if (gems.length > 0) {
      document.getElementById('gemBadge').classList.remove('hidden');
      document.getElementById('gemDetails').classList.remove('hidden');
      
      const gemReasons = document.getElementById('gemReasons');
      gemReasons.innerHTML = gems.map(g => 
        `<div>${g.icon} <strong>${g.label}:</strong> ${g.details}</div>`
      ).join('');
    } else {
      document.getElementById('gemBadge').classList.add('hidden');
      document.getElementById('gemDetails').classList.add('hidden');
    }
    
    // Gemini section
    const geminiSection = document.getElementById('geminiSection');
    if (decision.isBorderline && decision.verdict === 'BUY') {
      geminiSection.classList.remove('hidden');
      document.getElementById('geminiResult').classList.add('hidden');
      document.getElementById('geminiResult').innerHTML = '';
    } else {
      geminiSection.classList.add('hidden');
    }
    
    // Show card
    card.classList.remove('hidden');
    card.classList.add('animate-slide-in');
    
    // Update status
    this.setStatus(keepaData.title);
  },

  renderGeminiResult(result) {
    const container = document.getElementById('geminiResult');
    
    let html = '';
    
    // Recommendation badge at top
    if (result.recommendation) {
      const badgeClass = result.recommendation === 'BUY' ? 'bg-green-500/20 text-green-400 border-green-500/50' : 'bg-red-500/20 text-red-400 border-red-500/50';
      html += `<div class="inline-block px-3 py-1 ${badgeClass} border rounded-lg font-bold text-sm mb-3">Gemini Recommendation: ${result.recommendation}</div><hr class="border-gray-800 mb-3">`;
    }
    
    // Analysis
    html += `<div class="text-sm text-gray-300 whitespace-pre-line leading-relaxed">${result.analysis}</div>`;
    
    container.innerHTML = html;
    container.classList.remove('hidden');
  },

  updateProfitTally() {
    const buyQueue = AppState.runtime.buyQueue;
    const totalProfit = buyQueue.reduce((sum, item) => sum + parseFloat(item.profit), 0);
    
    document.getElementById('profitTally').innerHTML = `
      <span class="font-semibold">Queue:</span> ${buyQueue.length} | 
      <span class="font-semibold">Profit:</span> $${totalProfit.toFixed(2)}
    `;
  },

  renderHistory() {
    const list = document.getElementById('historyList');
    const history = AppState.runtime.history;
    
    if (history.length === 0) {
      list.innerHTML = '<div class="text-center text-gray-500 py-8">No scans yet</div>';
      return;
    }
    
    list.innerHTML = history.slice().reverse().map(item => {
      const verdictClass = item.verdict === 'BUY' || item.verdict.includes('BORDERLINE') ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400';
      const gemBadge = item.isGem ? '<span class="text-yellow-400">‚ú®</span>' : '';
      
      return `
        <div class="p-4 bg-gray-900 rounded-xl border border-gray-800">
          <div class="inline-block px-2 py-1 ${verdictClass} rounded text-xs font-bold mb-2">
            ${gemBadge} ${item.verdict}
          </div>
          <div class="text-sm font-semibold mb-2">${item.title}</div>
          <div class="text-xs text-gray-400 font-mono space-y-1">
            <div>ASIN: ${item.asin}</div>
            <div>Price: $${item.price} ‚Ä¢ Profit: $${item.profit} ‚Ä¢ ROI: ${item.roi}%</div>
            ${item.gemTypes ? `<div class="text-yellow-400">üíé ${item.gemTypes}</div>` : ''}
            <div>${item.time}</div>
          </div>
        </div>
      `;
    }).join('');
  }
};

function updateProfitTally() {
  UI.updateProfitTally();
}

// =====================================================
// 8. EVENT HANDLERS
// =====================================================
async function handleScannedIdentifier(identifier) {
  // Vibrate feedback
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
  
  // Duplicate check
  if (AppState.runtime.scannedIdentifiers.has(identifier)) {
    UI.showDuplicateWarning(true);
    setTimeout(() => UI.showDuplicateWarning(false), 3000);
    return;
  }
  
  AppState.runtime.scannedIdentifiers.add(identifier);
  UI.showProcessing(true);
  UI.setStatus('Analyzing...');
  
  try {
    // Fetch Keepa data
    const keepaData = await KeepaClient.fetchProduct(identifier);
    
    // Analyze
    const decision = DecisionEngine.analyze(keepaData);
    
    // Render
    UI.renderDecision(decision, keepaData);
    
    // Add to history
    addToHistory(decision, keepaData);
    
  } catch (error) {
    console.error('Scan error:', error);
    UI.setStatus('Error: ' + error.message);
  } finally {
    UI.showProcessing(false);
  }
}

function addToHistory(decision, keepaData) {
  const gems = DecisionEngine.detectHiddenGems(keepaData, decision);
  
  const record = {
    verdict: decision.verdict,
    title: keepaData.title,
    asin: keepaData.asin,
    price: decision.targetPrice.toFixed(2),
    profit: decision.profit.toFixed(2),
    roi: decision.roi,
    time: new Date().toLocaleTimeString(),
    isGem: gems.length > 0,
    gemTypes: gems.map(g => g.label).join(', ')
  };
  
  AppState.runtime.history.push(record);
  
  if (decision.verdict === 'BUY' || decision.verdict.includes('BORDERLINE')) {
    AppState.runtime.buyQueue.push(record);
  }
  
  UI.updateProfitTally();
}

async function reanalyzeWithCurrentSettings() {
  if (!AppState.runtime.lastScanData) return;
  
  const { keepaData } = AppState.runtime.lastScanData;
  const decision = DecisionEngine.analyze(keepaData);
  UI.renderDecision(decision, keepaData);
  
  // Clear Gemini result since settings changed
  document.getElementById('geminiResult').classList.add('hidden');
}

// Slider events
document.getElementById('buyCostSlider').addEventListener('input', (e) => {
  const value = parseFloat(e.target.value);
  AppState.settings.buyCost = value;
  localStorage.setItem('buyCost', value);
  document.getElementById('buyCostValue').textContent = `$${value.toFixed(2)}`;
  reanalyzeWithCurrentSettings();
});

document.getElementById('profitFloorSlider').addEventListener('input', (e) => {
  const value = parseFloat(e.target.value);
  AppState.settings.profitFloor = value;
  localStorage.setItem('profitFloor', value);
  document.getElementById('profitFloorValue').textContent = `$${value.toFixed(2)}`;
  reanalyzeWithCurrentSettings();
});

// Gemini button
document.getElementById('askGeminiBtn').addEventListener('click', async () => {
  if (!AppState.runtime.lastScanData) return;
  
  const btn = document.getElementById('askGeminiBtn');
  btn.disabled = true;
  btn.textContent = 'Analyzing...';
  
  try {
    const { decision, keepaData } = AppState.runtime.lastScanData;
    const result = await GeminiClient.analyze(keepaData, decision);
    UI.renderGeminiResult(result);
  } catch (error) {
    console.error('Gemini error:', error);
  } finally {
    btn.disabled = false;
    btn.textContent = 'Ask Gemini for more detail';
  }
});

// Settings
document.getElementById('settingsBtn').addEventListener('click', () => {
  document.getElementById('settingsModal').classList.remove('hidden');
  document.getElementById('keepaKeyInput').value = AppState.settings.keepaKey;
  document.getElementById('geminiKeyInput').value = AppState.settings.geminiKey;
  document.getElementById('tokenBudgetInput').value = AppState.settings.tokenBudget;
  
  const tokenStatus = AppState.keepa.tokensRemaining 
    ? `Available: ${AppState.keepa.tokensRemaining}` 
    : 'Available: Unknown';
  document.getElementById('tokenStatus').textContent = tokenStatus;
});

document.getElementById('closeSettingsBtn').addEventListener('click', () => {
  document.getElementById('settingsModal').classList.add('hidden');
});

document.getElementById('saveSettingsBtn').addEventListener('click', () => {
  AppState.settings.keepaKey = document.getElementById('keepaKeyInput').value.trim();
  AppState.settings.geminiKey = document.getElementById('geminiKeyInput').value.trim();
  AppState.settings.tokenBudget = parseInt(document.getElementById('tokenBudgetInput').value);
  
  localStorage.setItem('keepaKey', AppState.settings.keepaKey);
  localStorage.setItem('geminiKey', AppState.settings.geminiKey);
  localStorage.setItem('tokenBudget', AppState.settings.tokenBudget);
  
  document.getElementById('settingsModal').classList.add('hidden');
  UI.setStatus('Settings saved');
});

// History
document.getElementById('historyBtn').addEventListener('click', () => {
  document.getElementById('mainPage').classList.add('hidden');
  document.getElementById('historyPage').classList.remove('hidden');
  UI.renderHistory();
});

document.getElementById('backBtn').addEventListener('click', () => {
  document.getElementById('historyPage').classList.add('hidden');
  document.getElementById('mainPage').classList.remove('hidden');
});

// Export CSV
document.getElementById('downloadBtn').addEventListener('click', () => {
  if (AppState.runtime.buyQueue.length === 0) {
    alert('No items in buy queue');
    return;
  }
  
  let csv = 'Title,ASIN,Price,Profit,ROI,HiddenGem,GemReasons\n';
  AppState.runtime.buyQueue.forEach(r => {
    const gemFlag = r.isGem ? 'YES' : 'NO';
    const gemReasons = r.isGem ? `"${r.gemTypes}"` : '';
    csv += `"${r.title}",${r.asin},${r.price},${r.profit},${r.roi}%,${gemFlag},${gemReasons}\n`;
  });
  
  const totalProfit = AppState.runtime.buyQueue.reduce((sum, r) => sum + parseFloat(r.profit), 0);
  csv += `\nTOTAL PROFIT,$${totalProfit.toFixed(2)}`;
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `scoutpro_buylist_${Date.now()}.csv`;
  a.click();
  URL.revokeObjectURL(url);
});

// Clear
document.getElementById('clearBtn').addEventListener('click', () => {
  if (!confirm('Clear all scan data and buy queue?')) return;
  
  AppState.runtime.history = [];
  AppState.runtime.buyQueue = [];
  AppState.runtime.scannedIdentifiers.clear();
  AppState.runtime.lastScanData = null;
  AppState.runtime.geminiCache.clear();
  
  document.getElementById('resultCard').classList.add('hidden');
  UI.setStatus('Ready to scan');
  UI.updateProfitTally();
});

</script>

</body>
</html>
