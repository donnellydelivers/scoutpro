<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Pretty Good Scouting App (Pro) - Marvel Edition</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&family=Bangers&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
/* --- THEME & RESET --- */
:root {
  --bg: #050505; --panel: #121212; --card: #1e1e1e; --border: #2a2a2a;
  --text: #ffffff; --muted: #888; --green: #34d399; --red: #f87171;
  --yellow: #fbbf24; --blue: #60a5fa; --purple: #a78bfa; --diamond: #22d3ee;
  --marvel: #ed1d24;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 120px; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
.app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; border-left: 1px solid var(--border); border-right: 1px solid var(--border); }

/* --- MARVEL VIBRATING BADGES --- */
@keyframes comicVibrate {
  0% { transform: translate(1px, 1px) rotate(0deg); }
  10% { transform: translate(-1px, -2px) rotate(-1deg); }
  20% { transform: translate(-3px, 0px) rotate(1deg); }
  30% { transform: translate(3px, 2px) rotate(0deg); }
  40% { transform: translate(1px, -1px) rotate(1deg); }
  50% { transform: translate(-1px, 2px) rotate(-1deg); }
  60% { transform: translate(-3px, 1px) rotate(0deg); }
  70% { transform: translate(3px, 1px) rotate(-1deg); }
  80% { transform: translate(-1px, -1px) rotate(1deg); }
  90% { transform: translate(1px, 2px) rotate(0deg); }
  100% { transform: translate(1px, -2px) rotate(-1deg); }
}

.badge-marvel {
  display: inline-block;
  animation: comicVibrate 0.3s infinite;
  font-family: 'Bangers', cursive;
  text-transform: uppercase;
  padding: 6px 12px;
  border-radius: 4px;
  border: 3px solid #000;
  box-shadow: 4px 4px 0px #000;
  margin: 4px;
  font-size: 14px;
  letter-spacing: 0.08em;
  line-height: 1;
}

.knockout { background: #ffde00; color: #000; }
.solo { background: var(--marvel); color: #fff; }
.mint { background: var(--diamond); color: #000; }
.fast-turn { background: var(--green); color: #000; }
.big-margin { background: var(--purple); color: #fff; }
.collector-warn { background: #000; color: var(--marvel); border-color: var(--marvel); box-shadow: 4px 4px 0px var(--marvel); }
.reject { background: #000; color: var(--red); border-color: var(--red); box-shadow: 4px 4px 0px var(--red); }

/* --- SUPERHERO ANIMATION --- */
.comic-burst {
  position: fixed; 
  top: 50%; 
  left: 50%; 
  transform: translate(-50%, -50%) scale(0);
  width: 300px; 
  height: 300px; 
  background: var(--marvel); 
  color: white;
  clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
  display: flex; 
  align-items: center; 
  justify-content: center;
  font-family: 'Bangers', cursive;
  font-weight: 900; 
  font-size: 60px; 
  z-index: 10000;
  border: 5px solid black; 
  transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  pointer-events: none;
  text-shadow: 3px 3px 0px black;
}
.comic-burst.show { transform: translate(-50%, -50%) scale(1.2); }

@keyframes heroPulse {
  from { transform: translate(-50%, -50%) scale(1.2); opacity: 0.9; }
  to { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
}

.comic-burst.show {
  animation: heroPulse 0.5s infinite alternate;
}

/* --- SPLASH SCREEN --- */
#splash-screen {
    position: fixed; inset: 0; z-index: 9999; background-color: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.8s ease-out, visibility 0.8s;
}
.splash-hidden { opacity: 0; visibility: hidden; pointer-events: none; }
.splash-bg { position: absolute; inset: 0; z-index: 0; }
.splash-bg img { width: 100%; height: 100%; object-fit: cover; }
.splash-bg::after {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(0,0,0,0.85) 0%, rgba(10,10,30,0.9) 100%);
}
.splash-content { position: relative; z-index: 10; text-align: center; width: 100%; padding: 0 20px; }
.big-title {
    font-family: 'Inter', sans-serif; font-weight: 900; text-transform: uppercase;
    line-height: 0.9; letter-spacing: -0.05em; display: flex; flex-direction: column; gap: 0;
    text-shadow: 0 4px 30px rgba(0,0,0,0.8);
}
.big-title span { font-size: 3.5rem; }
@media(min-width: 400px) { .big-title span { font-size: 4.5rem; } }

/* --- HEADER --- */
header { padding: 12px 16px; background: var(--bg); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid var(--border); }
.status-row { display: flex; justify-content: flex-end; gap: 8px; margin-bottom: 10px; }
.status-badge {
    font-size: 10px; font-weight: 700; color: var(--muted);
    background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 99px;
    display: flex; align-items: center; gap: 6px; border: 1px solid transparent; transition: all 0.2s;
}
.status-badge.live { color: var(--green); border-color: rgba(52, 211, 153, 0.2); background: rgba(52, 211, 153, 0.1); }
.status-badge.dead { color: var(--red); border-color: rgba(248, 113, 113, 0.2); background: rgba(248, 113, 113, 0.1); }
.status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

.search-container { position: relative; display: flex; gap: 8px; }
.input-wrapper { position: relative; flex: 1; }
.search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 16px; }
input[type="text"] {
  width: 100%; padding: 14px 14px 14px 42px; border-radius: 12px; background: #111; border: 1px solid #333;
  color: white; font-family: 'Inter', sans-serif; font-size: 16px; outline: none; transition: all 0.2s;
}
input[type="text"]:focus { border-color: var(--blue); background: #161616; }
.icon-btn {
    width: 48px; border-radius: 12px; border: 1px solid #333; background: #111;
    color: var(--muted); font-size: 18px; cursor: pointer; display: grid; place-items: center; transition: all 0.2s;
}
.icon-btn.active { color: var(--green); border-color: rgba(52, 211, 153, 0.4); background: rgba(52, 211, 153, 0.1); }

/* --- CARD --- */
.card {
  margin: 16px; background: var(--panel); border-radius: 20px; border: 1px solid var(--border);
  overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideUp 0.3s ease-out;
}
@keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

.banner { padding: 16px 16px; text-align: center; position: relative; }
.banner.buy { background: radial-gradient(circle at top, rgba(16,185,129,0.12), transparent 70%); }
.banner.gem { background: radial-gradient(circle at top, rgba(34, 211, 238, 0.2), transparent 70%); }
.banner.reject { background: radial-gradient(circle at top, rgba(239,68,68,0.12), transparent 70%); }
.banner.consider { background: radial-gradient(circle at top, rgba(245,158,11,0.12), transparent 70%); }

.score-container { position: relative; width: 80px; height: 80px; margin: 0 auto 10px auto; display: flex; align-items: center; justify-content: center; }
.score-svg { position: absolute; top:0; left:0; width:100%; height:100%; transform: rotate(-90deg); }
.score-circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 8; }
.score-circle-fg { fill: none; stroke: currentColor; stroke-width: 8; stroke-linecap: round; transition: stroke-dashoffset 1s; stroke-dasharray: 283; stroke-dashoffset: 283; }
.score-num { font-size: 32px; font-weight: 800; color: #fff; letter-spacing: -0.04em; z-index: 2; }

.item-title { font-size: 18px; font-weight: 800; color: #fff; line-height: 1.3; margin-bottom: 16px; text-align: center; min-height: 48px; display: flex; align-items: center; justify-content: center; padding: 0 16px; }

.price-profit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 16px; }
.info-box { border-radius: 10px; padding: 14px; text-align: center; border: 2px solid; }
.price-box { border-color: var(--blue); background: rgba(96,165,250,0.08); }
.profit-box { border-color: var(--green); background: rgba(52,211,153,0.08); }
.info-label { font-size: 10px; color: var(--muted); font-weight: 700; margin-bottom: 4px; }
.info-value { font-size: 24px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }

.signals-container { display: flex; flex-wrap: wrap; gap: 6px; margin: 12px 0; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; justify-content: center; }

/* Marvel Math Breakdown */
.marvel-math {
    background: rgba(0,0,0,0.5);
    padding: 12px;
    margin: 12px 16px;
    border-radius: 8px;
    font-size: 12px;
    border-left: 3px solid var(--marvel);
}
.marvel-math div {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-family: 'JetBrains Mono', monospace;
}
.marvel-math div:last-child {
    border-top: 1px solid var(--border);
    margin-top: 6px;
    padding-top: 8px;
    font-weight: 800;
    color: var(--green);
    font-size: 14px;
}
.marvel-math .bundle-bonus {
    color: var(--yellow);
    border-top: none;
    margin-top: 4px;
    padding-top: 4px;
}

/* TOGGLES */
.toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.toggle-switch {
  width: 44px; height: 24px; background: #333; border-radius: 99px; position: relative; cursor: pointer; transition: background 0.2s;
}
.toggle-switch::after {
  content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: transform 0.2s;
}
.toggle-switch.active { background: var(--green); }
.toggle-switch.active::after { transform: translateX(20px); }

/* --- PAGES --- */
#settingsPage, #historyPage {
  position: fixed; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px;
  background: var(--bg); z-index: 3000; padding: 24px;
  display: flex; flex-direction: column; border-left: 1px solid var(--border); border-right: 1px solid var(--border);
}
.settings-header { font-size: 20px; font-weight: 800; margin-bottom: 24px; text-align: center; }
.settings-content { flex: 1; overflow-y: auto; }
.settings-group { margin-bottom: 24px; }
.label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--muted); text-transform: uppercase; }
.settings-input { width: 100%; padding: 14px; background: var(--panel); border: 1px solid var(--border); color: white; border-radius: 12px; font-family: 'JetBrains Mono', monospace; }
.settings-select { width: 100%; padding: 14px; background: var(--panel); border: 1px solid var(--border); color: white; border-radius: 12px; font-family: 'Inter', sans-serif; cursor: pointer; }
.btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; }
.btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 14px; cursor: pointer; }
.btn-save { background: var(--green); color: #000; }
.btn-back { background: var(--panel); color: #fff; border: 1px solid var(--border); }

.actions { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(5,5,5,0.95); padding: 16px; border-top: 1px solid var(--border); display: flex; gap: 12px; max-width: 480px; margin: 0 auto; z-index: 100; }
.act-btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
.act-btn:active { transform: scale(0.95); }
.btn-cam { background: rgba(34,211,238,0.2); color: var(--diamond); border: 1px solid rgba(34,211,238,0.4); }

.hidden { display: none !important; }
</style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-bg"><img src="https://images.unsplash.com/photo-1521587760476-6c12a4b040da?w=1200&q=80" alt=""></div>
    <div class="splash-content">
        <h1 class="big-title"><span>PRETTY</span><span>GOOD</span><span>SOURCING</span><span>APP</span></h1>
    </div>
</div>

<div class="app">
  <div id="mainView">
    <header>
      <div class="status-row">
        <button onclick="showSourceSettings()" style="background:rgba(56,189,248,0.1);border:1px solid rgba(56,189,248,0.3);color:#38bdf8;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;">‚öôÔ∏è SKU SOURCE</button>
        <div id="badgeKeepa" class="status-badge dead"><div class="status-dot"></div> Keepa</div>
        <div id="badgeGemini" class="status-badge dead"><div class="status-dot"></div> Gemini</div>
      </div>
      <div class="search-container">
        <div class="input-wrapper"><i class="fas fa-search search-icon"></i><input id="scanInput" type="text" placeholder="Scan Marvel ISBN or Title..." autocomplete="off" onkeyup="if(event.key === 'Enter') submitSearch()" /></div>
        <button class="icon-btn" onclick="submitSearch()"><i class="fas fa-search"></i></button>
      </div>
    </header>

    <div id="processing" class="hidden" style="text-align:center; padding:60px;"><i class="fas fa-circle-notch fa-spin" style="font-size:32px; color:var(--marvel);"></i></div>

    <div class="card hidden" id="resultCard">
      <div id="banner" class="banner buy">
        <div id="itemTitle" class="item-title">--</div>
        <div class="score-container">
            <svg class="score-svg" viewBox="0 0 100 100">
                <circle class="score-circle-bg" cx="50" cy="50" r="45" fill="none"></circle>
                <circle class="score-circle-fg" id="scoreRing" cx="50" cy="50" r="45" fill="none"></circle>
            </svg>
            <span id="confidence" class="score-num">--</span>
        </div>
        <div id="decision" style="font-weight:900; text-transform:uppercase; padding:6px 14px; border-radius:99px; display:inline-block;">--</div>
      </div>
      
      <div id="signalsContainer" class="signals-container hidden">
          <div style="font-size: 10px; font-weight: 700; color: var(--muted); text-transform: uppercase; width: 100%; text-align: center; margin-bottom: 5px;">Strategy Score Signals</div>
          <div id="signalsBadges" style="display: flex; flex-wrap: wrap; justify-content: center;"></div>
      </div>

      <div class="price-profit-grid">
        <div class="info-box price-box">
          <div class="info-label">LIST PRICE</div>
          <div id="recommendedPrice" class="info-value" style="color:var(--blue);">$0.00</div>
        </div>
        <div class="info-box profit-box">
          <div class="info-label">NET PROFIT</div>
          <div id="profitValue" class="info-value" style="color:var(--green);">$0.00</div>
        </div>
      </div>

      <div id="marvelMath" class="hidden"></div>
    </div>
  </div>

  <div class="actions">
    <button onclick="showSettings()" class="act-btn" style="background:#222; color:#fff; flex:0.4;"><i class="fas fa-cog"></i></button>
    <button onclick="showHistory()" class="act-btn" style="background:var(--blue); color:#fff;">History</button>
    <button onclick="openCamera()" class="act-btn btn-cam"><i class="fas fa-bolt"></i> SCAN</button>
  </div>
</div>

<!-- Settings Page -->
<div id="settingsPage" class="hidden">
  <div class="settings-header">Settings</div>
  <div class="settings-content">
    <div class="settings-group">
      <span class="label">Keepa API Key</span>
      <input type="password" id="keepaKey" class="settings-input" placeholder="Paste Keepa key..." />
    </div>

    <div class="settings-group">
      <span class="label">Gemini API Key</span>
      <input type="password" id="geminiKey" class="settings-input" placeholder="Paste Gemini API key..." />
    </div>
    
    <div class="settings-group">
      <div class="toggle-row">
        <span class="label" style="margin:0;">Use Proxy Server</span>
        <div id="toggleProxy" class="toggle-switch active" onclick="toggleSetting('useProxy')"></div>
      </div>
      <div style="font-size:11px; color:var(--muted); margin-top:4px;">Turn OFF if you have a CORS extension installed. Direct is faster.</div>
    </div>

    <div class="settings-group">
      <div class="toggle-row">
        <span class="label" style="margin:0;">Fast Scan (90 Days)</span>
        <div id="toggleFastScan" class="toggle-switch" onclick="toggleSetting('fastScan')"></div>
      </div>
      <div style="font-size:11px; color:var(--muted); margin-top:4px;">Fetches less data for speed. Good for live scanning.</div>
    </div>

    <div class="settings-group">
      <span class="label">Default Condition</span>
      <select id="defCondition" class="settings-select">
        <option value="NEW">New</option>
        <option value="LIKE_NEW">Like New</option>
        <option value="VERY_GOOD">Very Good</option>
        <option value="GOOD">Good</option>
        <option value="ACCEPTABLE">Acceptable</option>
      </select>
    </div>

    <div class="settings-group">
      <span class="label">Default Buy Cost ($)</span>
      <input type="number" id="defCost" class="settings-input" value="1.00" step="0.25" />
    </div>
    <div class="settings-group">
      <span class="label">Default Profit Floor ($)</span>
      <input type="number" id="defFloor" class="settings-input" value="5.00" step="0.50" />
    </div>
  </div>
  <div class="btn-grid">
    <button onclick="closeSettings()" class="btn-main btn-back">Cancel</button>
    <button onclick="saveSettings()" class="btn-main btn-save">Save</button>
  </div>
</div>

<!-- History Page -->
<div id="historyPage" class="hidden">
  <div class="settings-header">Scan History</div>
  <div id="historyList" style="flex:1; overflow-y:auto; padding: 16px; color: var(--muted); text-align: center;">
    <p>History feature coming soon...</p>
  </div>
  <div class="btn-grid">
    <button onclick="closeHistory()" class="btn-main btn-back">Back</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
let CONFIG = { 
    keepaKey: localStorage.getItem('keepaKey') || '',
    geminiKey: localStorage.getItem('geminiKey') || '',
    buyCost: parseFloat(localStorage.getItem('buyCost')) || 1.00, 
    profitFloor: parseFloat(localStorage.getItem('profitFloor')) || 5.00, 
    condition: localStorage.getItem('condition') || 'LIKE_NEW',
    useProxy: localStorage.getItem('useProxy') !== 'false', 
    fastScan: localStorage.getItem('fastScan') === 'true'
};

/* ================= MARVEL-SPECIFIC CONFIG ================= */
const MARVEL_CONFIG = {
    // FBA Fee Table (for weight-based calculation)
    fbaFees: {
        '0-1': 3.66,
        '1-2': 4.75,
        '2-3': 5.50,
        '3-4': 6.10,
        '4-5': 7.15,
        '5-10': 8.26,
        '10-20': 15.06,
        '20+': 18.00
    },
    
    // Return rates by condition (percentage)
    returnRates: {
        'NEW': 5,
        'LIKE_NEW': 15,
        'VERY_GOOD': 25,
        'GOOD': 40,
        'ACCEPTABLE': 50
    },
    
    // Marvel Universe categories
    universes: {
        MCU: {
            keywords: ['Avengers', 'Iron Man', 'Captain America', 'Thor', 'Black Panther', 
                      'Black Widow', 'Hulk', 'Ant-Man', 'Doctor Strange', 'Captain Marvel',
                      'Guardians of the Galaxy', 'Eternals', 'Shang-Chi', 'Hawkeye', 'Falcon',
                      'Winter Soldier', 'Scarlet Witch', 'Vision', 'Loki', 'WandaVision'],
            badge: 'üé¨ MCU PREMIUM',
            scoreBonus: 10,
            color: 'knockout'
        },
        SpiderVerse: {
            keywords: ['Spider-Man', 'Spider-Verse', 'Miles Morales', 'Spider-Gwen', 
                      'Venom', 'Carnage', 'Spider-Woman', 'Spider-Man 2099', 'Spectacular Spider',
                      'Amazing Spider', 'Ultimate Spider'],
            badge: 'üï∑Ô∏è SPIDER-VERSE',
            scoreBonus: 8,
            color: 'knockout'
        },
        XMen: {
            keywords: ['X-Men', 'Wolverine', 'Deadpool', 'Magneto', 'Phoenix', 
                      'Professor X', 'Cyclops', 'Storm', 'Rogue', 'Gambit', 'Nightcrawler',
                      'Beast', 'Jean Grey', 'Mystique', 'Cable', 'X-Force'],
            badge: '‚ö° X-MEN VELOCITY',
            scoreBonus: 5,
            color: 'fast-turn'
        },
        Cosmic: {
            keywords: ['Infinity', 'Thanos', 'Silver Surfer', 'Galactus', 'Celestials',
                      'Nova', 'Adam Warlock', 'Annihilation', 'Infinity Gauntlet', 'Infinity War'],
            badge: 'üåå COSMIC',
            scoreBonus: 6,
            color: 'big-margin'
        },
        Street: {
            keywords: ['Daredevil', 'Punisher', 'Luke Cage', 'Jessica Jones', 
                      'Moon Knight', 'Elektra', 'Defenders', 'Iron Fist', 'Heroes for Hire'],
            badge: 'ü•ä STREET LEVEL',
            scoreBonus: 4,
            color: 'mint'
        }
    }
};

// FBA Inventory (for series detection) - stored in localStorage
let fbaInventory = JSON.parse(localStorage.getItem('fbaInventory') || '[]');

setTimeout(() => {
    document.getElementById('splash-screen').classList.add('splash-hidden');
    updateTokenUI(); // Update API key status on load
    updateToggleUI('toggleProxy', CONFIG.useProxy);
    updateToggleUI('toggleFastScan', CONFIG.fastScan);
}, 1500);

/* ================= HELPER FUNCTIONS ================= */

// #1: Get FBA fee based on weight
function getFBAFee(weight) {
    if (!weight || weight <= 0) return 5.50; // Default
    if (weight <= 1) return 3.66;
    if (weight <= 2) return 4.75;
    if (weight <= 3) return 5.50;
    if (weight <= 4) return 6.10;
    if (weight <= 5) return 7.15;
    if (weight <= 10) return 8.26;
    if (weight <= 20) return 15.06;
    return 18.00;
}

// #2: Get return rate for Marvel by condition
function getReturnRate(condition) {
    return MARVEL_CONFIG.returnRates[condition] || 15;
}

// #4: Detect Marvel Universe
function detectMarvelUniverse(title) {
    for (const [universe, config] of Object.entries(MARVEL_CONFIG.universes)) {
        if (config.keywords.some(kw => title.toLowerCase().includes(kw.toLowerCase()))) {
            return { universe, config };
        }
    }
    return null;
}

// #7: Detect series match in inventory
function detectSeriesMatch(title) {
    // Parse "Marvel Masterworks: Avengers Vol 3" or "Avengers Vol. 3"
    const patterns = [
        /(.+?)\s+Vol\.?\s*(\d+)/i,           // "Series Vol 3"
        /(.+?)\s+Volume\s+(\d+)/i,           // "Series Volume 3"
        /(.+?)\s+Book\s+(\d+)/i,             // "Series Book 3"
        /(.+?)\s+#(\d+)/i                    // "Series #3"
    ];
    
    for (const pattern of patterns) {
        const match = title.match(pattern);
        if (match) {
            const seriesName = match[1].trim();
            const volume = parseInt(match[2]);
            
            // Check if we have adjacent volumes in inventory
            const adjacentVolumes = fbaInventory.filter(item => {
                const itemMatch = item.title.match(pattern);
                if (!itemMatch) return false;
                
                const itemSeries = itemMatch[1].trim();
                const itemVolume = parseInt(itemMatch[2]);
                
                // Same series, adjacent volume
                return itemSeries.toLowerCase() === seriesName.toLowerCase() &&
                       (itemVolume === volume - 1 || itemVolume === volume + 1);
            });
            
            if (adjacentVolumes.length > 0) {
                return {
                    seriesName,
                    volume,
                    adjacentVolumes
                };
            }
        }
    }
    return null;
}

// Superhero Animation
function triggerMarvelAnimation() {
    const burst = document.createElement('div');
    burst.className = 'comic-burst';
    burst.innerHTML = 'POW!';
    document.body.appendChild(burst);
    
    setTimeout(() => burst.classList.add('show'), 100);
    
    // Vibrate if supported (Hero vibration pattern)
    if (navigator.vibrate) {
        navigator.vibrate([100, 30, 100, 30, 300]);
    }
    
    setTimeout(() => {
        burst.classList.remove('show');
        setTimeout(() => burst.remove(), 300);
    }, 2000);
}

/* ================= SEARCH & ANALYZE ================= */

async function submitSearch() {
    const val = document.getElementById('scanInput').value;
    if(!val) return;

    document.getElementById('processing').classList.remove('hidden');
    document.getElementById('resultCard').classList.add('hidden');

    // MOCK DATA SIMULATION (Replace with real Keepa call in production)
    setTimeout(() => {
        const isMarvelSearch = val.toLowerCase().includes('marvel');
        
        // Different mock scenarios
        let mockData;
        if (val.toLowerCase().includes('vol 3') || val.toLowerCase().includes('volume 3')) {
            // Scenario: Series completion test
            mockData = {
                title: "Marvel Masterworks: Avengers Vol 3",
                fbaCount: 0, 
                drops30: 14, 
                usedPrice: 85.00, 
                newPrice: 125.00,
                weight: 5.8, 
                category: "Books",
                asin: "B00EXAMPLE3"
            };
        } else if (isMarvelSearch) {
            // Standard Marvel omnibus
            mockData = {
                title: "Marvel Omnibus: The Infinity Gauntlet",
                fbaCount: 0, 
                drops30: 12, 
                usedPrice: 95.00, 
                newPrice: 150.00,
                weight: 6.2, 
                category: "Books",
                asin: "B00EXAMPLE"
            };
        } else {
            // Non-Marvel book
            mockData = {
                title: "Standard Fiction Novel",
                fbaCount: 2, 
                drops30: 8, 
                usedPrice: 25.00, 
                newPrice: 35.00,
                weight: 1.2, 
                category: "Books",
                asin: "B00STANDARD"
            };
        }
        
        const result = analyze(mockData);
        render(result, mockData);
        document.getElementById('processing').classList.add('hidden');
    }, 800);
}

/* ================= ANALYSIS WITH MARVEL ENHANCEMENTS ================= */
function analyze(data) {
    const isMarvel = data.title.toLowerCase().includes('marvel');
    let score = 70; // Base score
    let market = data.usedPrice;
    
    // --- #1: WEIGHT-BASED FBA FEE CALCULATION ---
    const fbaFee = isMarvel ? getFBAFee(data.weight) : 5.50;
    const referralFee = market * 0.15;
    const closingFee = 1.80;
    
    let trueProfit = market - fbaFee - referralFee - closingFee - CONFIG.buyCost;
    
    // --- #2: RETURN RISK ADJUSTMENT ---
    let returnAdjustedProfit = trueProfit;
    let returnRate = 0;
    
    if (isMarvel && CONFIG.condition !== 'NEW') {
        returnRate = getReturnRate(CONFIG.condition);
        const returnCost = referralFee + fbaFee; // Cost per return
        const expectedReturnLoss = returnCost * (returnRate / 100);
        returnAdjustedProfit = trueProfit - expectedReturnLoss;
    }
    
    // --- MARVEL STRATEGY LOGIC ---
    if (isMarvel) {
        // Solo Mission Bonus (FBA advantage)
        if (data.fbaCount === 0) score += 15;
        
        // Sales Velocity Bonus
        if (data.drops30 >= 10) score += 10;
        
        // #1: Heavy Item Penalty/Bonus
        if (data.weight > 4) {
            if (trueProfit < 12) {
                score -= 20; // Heavy + low margin = bad
            } else {
                score += 5; // Heavy but profitable = good (barrier to entry)
            }
        }
        
        // #2: Return Risk Penalty
        if (CONFIG.condition !== 'NEW' && returnRate > 20) {
            score -= (returnRate / 5); // -4 for 20%, -8 for 40%
        }
        
        // #4: Universe Detection Bonus
        const universeMatch = detectMarvelUniverse(data.title);
        if (universeMatch) {
            score += universeMatch.config.scoreBonus;
        }
        
        // #7: Series Completion Bonus
        const seriesMatch = detectSeriesMatch(data.title);
        if (seriesMatch) {
            score += 15; // Bundle opportunity
            // Note: Don't add bundle bonus to profit here, we'll show it separately
        }
    }
    
    score = Math.min(100, Math.max(0, score));
    const verdict = score >= 85 ? 'BUY' : score >= 60 ? 'CONSIDER' : 'REJECT';

    return { 
        score, 
        profit: trueProfit, 
        returnAdjustedProfit,
        returnRate,
        market, 
        verdict, 
        isMarvel,
        fbaFee,
        referralFee,
        closingFee,
        universeMatch: detectMarvelUniverse(data.title),
        seriesMatch: detectSeriesMatch(data.title)
    };
}

/* ================= RENDER WITH MARVEL UI ================= */
function render(res, data) {
    const card = document.getElementById('resultCard');
    const signals = document.getElementById('signalsContainer');
    const badges = document.getElementById('signalsBadges');
    const banner = document.getElementById('banner');
    const mathSection = document.getElementById('marvelMath');
    
    card.classList.remove('hidden');
    document.getElementById('itemTitle').innerText = data.title;
    document.getElementById('confidence').innerText = res.score;
    document.getElementById('recommendedPrice').innerText = "$" + res.market.toFixed(2);
    
    // Show return-adjusted profit for Marvel Used items
    if (res.isMarvel && CONFIG.condition !== 'NEW' && res.returnRate > 0) {
        document.getElementById('profitValue').innerText = "$" + res.returnAdjustedProfit.toFixed(2);
    } else {
        document.getElementById('profitValue').innerText = "$" + res.profit.toFixed(2);
    }
    
    document.getElementById('decision').innerText = res.verdict;

    // Ring Animation
    const offset = 283 - (283 * res.score / 100);
    document.getElementById('scoreRing').style.strokeDashoffset = offset;
    
    // Set ring color based on verdict
    const ring = document.getElementById('scoreRing');
    if (res.verdict === 'BUY') ring.style.stroke = 'var(--green)';
    else if (res.verdict === 'CONSIDER') ring.style.stroke = 'var(--yellow)';
    else ring.style.stroke = 'var(--red)';
    
    banner.className = `banner ${res.verdict.toLowerCase()}`;

    // --- MARVEL UI ENGINE ---
    if (res.isMarvel) {
        signals.classList.remove('hidden');
        let html = "";
        
        // Core badges
        if (res.score >= 90) html += `<div class="badge-marvel knockout">TOTAL KNOCKOUT</div>`;
        if (data.fbaCount === 0) html += `<div class="badge-marvel solo">SOLO MISSION</div>`;
        if (CONFIG.condition === 'NEW') html += `<div class="badge-marvel mint">MINT</div>`;
        if (data.drops30 >= 10) html += `<div class="badge-marvel fast-turn">SALES BEAST</div>`;
        
        // #1: Weight/FBA Fee badges
        if (data.weight > 4) {
            if (res.profit >= 12) {
                html += `<div class="badge-marvel big-margin">‚úì HEAVY BUT PROFITABLE</div>`;
            } else {
                html += `<div class="badge-marvel reject">‚ö†Ô∏è WEIGHT KILLS MARGIN</div>`;
            }
        }
        
        // #2: Return Risk Warning
        if (CONFIG.condition !== 'NEW' && res.returnRate >= 25) {
            html += `<div class="badge-marvel collector-warn">‚ö†Ô∏è ${res.returnRate}% RETURN RISK</div>`;
        }
        
        // #4: Universe Badge
        if (res.universeMatch) {
            html += `<div class="badge-marvel ${res.universeMatch.config.color}">${res.universeMatch.config.badge}</div>`;
        }
        
        // #7: Series Completion
        if (res.seriesMatch) {
            html += `<div class="badge-marvel knockout">üìö BUNDLE: ${res.seriesMatch.adjacentVolumes.length} VOL IN STOCK</div>`;
        }
        
        // Collector Risk (no sales)
        if (data.drops30 === 0 && res.market > 30) {
            html += `<div class="badge-marvel collector-warn">‚ö†Ô∏è COLLECTOR RISK</div>`;
        }
        
        // High profit
        if (res.profit >= 40) html += `<div class="badge-marvel big-margin">HIGH PROFIT</div>`;
        
        badges.innerHTML = html;

        // Marvel Math Breakdown (for BUY/CONSIDER scores)
        if (res.score >= 60) {
            mathSection.classList.remove('hidden');
            let mathHTML = `
                <div class="marvel-math">
                    <div><span>List Price</span><span>$${res.market.toFixed(2)}</span></div>
                    <div><span>- Amazon (15%)</span><span>-$${res.referralFee.toFixed(2)}</span></div>
                    <div><span>- FBA Fee (${data.weight.toFixed(1)}lb)</span><span>-$${res.fbaFee.toFixed(2)}</span></div>
                    <div><span>- Closing Fee</span><span>-$${res.closingFee.toFixed(2)}</span></div>
                    <div><span>- Buy Cost</span><span>-$${CONFIG.buyCost.toFixed(2)}</span></div>
            `;
            
            if (res.returnRate > 0) {
                const returnCost = res.profit - res.returnAdjustedProfit;
                mathHTML += `<div><span>- Return Risk (${res.returnRate}%)</span><span>-$${returnCost.toFixed(2)}</span></div>`;
            }
            
            mathHTML += `<div><span>= Net Profit</span><span>$${(res.returnRate > 0 ? res.returnAdjustedProfit : res.profit).toFixed(2)}</span></div>`;
            
            if (res.seriesMatch) {
                const bundleBonus = res.profit * 0.30;
                mathHTML += `<div class="bundle-bonus"><span>+ Bundle Bonus (30%)</span><span>+$${bundleBonus.toFixed(2)}</span></div>`;
            }
            
            mathHTML += `</div>`;
            mathSection.innerHTML = mathHTML;
        } else {
            mathSection.classList.add('hidden');
        }

        // Superhero Animation for 90+ scores
        if (res.score >= 90) {
            triggerMarvelAnimation();
        }
    } else {
        signals.classList.add('hidden');
        mathSection.classList.add('hidden');
    }
}

/* ================= UI FUNCTIONS ================= */

function updateToggleUI(id, state) {
    const el = document.getElementById(id);
    if(el) {
        if(state) el.classList.add('active'); else el.classList.remove('active');
    }
}

function toggleSetting(key) {
    CONFIG[key] = !CONFIG[key];
    updateToggleUI(key === 'useProxy' ? 'toggleProxy' : 'toggleFastScan', CONFIG[key]);
}

function updateTokenUI() {
    const el = document.getElementById('badgeKeepa');
    if(CONFIG.keepaKey) {
        el.className = 'status-badge live';
        el.innerHTML = `<div class="status-dot"></div> Keepa`;
    } else {
        el.className = 'status-badge dead';
        el.innerHTML = `<div class="status-dot"></div> Keepa`;
    }
    
    document.getElementById('badgeGemini').className = CONFIG.geminiKey ? 'status-badge live' : 'status-badge dead';
}

function showSettings() { 
    document.getElementById('settingsPage').classList.remove('hidden');
    document.getElementById('keepaKey').value = CONFIG.keepaKey;
    document.getElementById('geminiKey').value = CONFIG.geminiKey;
    document.getElementById('defCost').value = CONFIG.buyCost;
    document.getElementById('defFloor').value = CONFIG.profitFloor;
    document.getElementById('defCondition').value = CONFIG.condition;
    updateToggleUI('toggleProxy', CONFIG.useProxy);
    updateToggleUI('toggleFastScan', CONFIG.fastScan);
}

function closeSettings() {
    document.getElementById('settingsPage').classList.add('hidden');
}

function saveSettings() {
    CONFIG.keepaKey = document.getElementById('keepaKey').value.trim();
    CONFIG.geminiKey = document.getElementById('geminiKey').value.trim();
    CONFIG.buyCost = parseFloat(document.getElementById('defCost').value);
    CONFIG.profitFloor = parseFloat(document.getElementById('defFloor').value);
    CONFIG.condition = document.getElementById('defCondition').value;
    CONFIG.useProxy = document.getElementById('toggleProxy').classList.contains('active');
    CONFIG.fastScan = document.getElementById('toggleFastScan').classList.contains('active');
    
    localStorage.setItem('keepaKey', CONFIG.keepaKey);
    localStorage.setItem('geminiKey', CONFIG.geminiKey);
    localStorage.setItem('buyCost', CONFIG.buyCost);
    localStorage.setItem('profitFloor', CONFIG.profitFloor);
    localStorage.setItem('condition', CONFIG.condition);
    localStorage.setItem('useProxy', CONFIG.useProxy);
    localStorage.setItem('fastScan', CONFIG.fastScan);
    
    updateTokenUI();
    closeSettings();
    
    // If there's a current result, re-analyze with new settings
    if (!document.getElementById('resultCard').classList.contains('hidden')) {
        submitSearch();
    }
}

function showHistory() { 
    document.getElementById('historyPage').classList.remove('hidden');
}

function closeHistory() {
    document.getElementById('historyPage').classList.add('hidden');
}

function openCamera() { 
    alert("Camera scanner would open here (requires html5-qrcode setup)"); 
}

function showSourceSettings() { 
    alert("SKU Source Settings: Configure Smart SKU generation"); 
}

function clearScan() { 
    document.getElementById('resultCard').classList.add('hidden');
    document.getElementById('scanInput').value = ''; 
}

/* ================= MOCK INVENTORY FOR TESTING #7 ================= */
// Simulate having some volumes in FBA inventory for series detection
if (fbaInventory.length === 0) {
    fbaInventory = [
        { title: 'Marvel Masterworks: Avengers Vol 1', asin: 'B001' },
        { title: 'Marvel Masterworks: Avengers Vol 2', asin: 'B002' },
        { title: 'Spider-Man: The Clone Saga Vol 1', asin: 'B003' },
        { title: 'X-Men: Age of Apocalypse Vol 2', asin: 'B004' }
    ];
    localStorage.setItem('fbaInventory', JSON.stringify(fbaInventory));
}

</script>
</body>
</html>
