<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ScoutPro – Book Sourcing (Final)</title>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&family=DM+Mono&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0d0f12;
  --card:#1e2329;
  --border:rgba(255,255,255,.08);
  --text:#f0f2f5;
  --muted:#9aa3ad;
  --green:#00d68f;
  --red:#ff6b6b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:'DM Sans'}
.app{max-width:430px;margin:auto;min-height:100vh}
header{
  padding:14px 16px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
input{
  width:100%;
  padding:16px;
  font-size:17px;
  border-radius:14px;
  border:2px solid var(--border);
  background:#12151a;
  color:white;
}
.card{
  margin:16px;
  background:var(--card);
  border-radius:18px;
  border:1px solid var(--border);
  display:none;
  overflow:hidden;
}
.banner{
  padding:18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.buy{background:rgba(0,214,143,.12);border-bottom:2px solid var(--green)}
.pass{background:rgba(255,107,107,.12);border-bottom:2px solid var(--red)}
.grid{display:grid;grid-template-columns:1fr 1fr}
.cell{
  padding:14px;
  border-top:1px solid var(--border);
  border-right:1px solid var(--border)
}
.cell:nth-child(even){border-right:none}
.lbl{font-size:11px;color:var(--muted);text-transform:uppercase}
.val{font-family:'DM Mono';font-size:15px;margin-top:4px}
.meta{font-size:11px;color:var(--muted)}
.toggle{display:flex;gap:8px;padding:8px 16px}
.toggle button{
  flex:1;padding:10px;border-radius:10px;
  border:1px solid var(--border);
  background:#12151a;color:var(--muted);font-weight:600
}
.toggle .active{background:rgba(0,214,143,.15);color:var(--green)}
</style>
</head>

<body>
<div class="app">

<header>
  <strong>ScoutPro</strong>
  <span id="tokenDisplay" style="font-size:11px;color:var(--muted)"></span>
</header>

<div style="padding:16px">
  <input id="barcodeInput" placeholder="Scan barcode…" inputmode="numeric">
</div>

<div class="toggle">
  <button id="usedBtn" class="active">USED</button>
  <button id="newBtn">NEW</button>
</div>

<div id="card" class="card">
  <div id="banner" class="banner">
    <div>
      <div id="decision" style="font-size:22px;font-weight:700"></div>
      <div id="reason" class="meta"></div>
    </div>
    <div id="profit" style="font-size:22px;font-family:'DM Mono'"></div>
  </div>

  <div class="grid">
    <div class="cell"><div class="lbl">Used FBA</div><div id="usedFBA" class="val">--</div><div id="usedFBA_src" class="meta"></div></div>
    <div class="cell"><div class="lbl">Used FBM</div><div id="usedFBM" class="val">--</div><div id="usedFBM_src" class="meta"></div></div>
    <div class="cell"><div class="lbl">New FBA</div><div id="newFBA" class="val">--</div><div id="newFBA_src" class="meta"></div></div>
    <div class="cell"><div class="lbl">New FBM</div><div id="newFBM" class="val">--</div><div id="newFBM_src" class="meta"></div></div>
    <div class="cell"><div class="lbl">Amazon Retail</div><div id="amazon" class="val">--</div><div id="amazon_src" class="meta"></div></div>
    <div class="cell"><div class="lbl">Avg Rank</div><div id="rank" class="val">--</div><div id="rank_src" class="meta"></div></div>
  </div>
</div>

</div>

<script>
let condition='used';
usedBtn.onclick=()=>{condition='used';usedBtn.classList.add('active');newBtn.classList.remove('active')}
newBtn.onclick=()=>{condition='new';newBtn.classList.add('active');usedBtn.classList.remove('active')}
const apiKey=localStorage.getItem('scoutProKey')||prompt('Enter Keepa API key');
localStorage.setItem('scoutProKey',apiKey);

function getStat(stats,idx){
  const sets=['current','avg30','avg90','avg180'];
  for(const s of sets) if(stats[s]&&stats[s][idx]>0) return {v:stats[s][idx],src:s};
  return null;
}
function getCsv(csv,idx){
  if(!csv||!csv[idx]||csv[idx].length<2) return null;
  const v=csv[idx][csv[idx].length-1];
  return v>0?{v,src:'csv'}:null;
}
function show(id,obj){
  document.getElementById(id).textContent=obj?`$${(obj.v/100).toFixed(2)}`:'--';
  document.getElementById(id+'_src').textContent=obj?`[${obj.src}]`:'';
}

barcodeInput.addEventListener('keypress',e=>{if(e.key==='Enter') load(barcodeInput.value.trim())});

async function load(code){
  card.style.display='none';
  const r=await fetch(`https://api.keepa.com/product?key=${apiKey}&domain=1&code=${code}&stats=1&offers=20`);
  const d=await r.json();
  tokenDisplay.textContent=d.tokensLeft?`${d.tokensLeft} tokens`:'';
  if(!d.products?.[0]) return;
  render(d.products[0]);
}

function render(p){
  const s=p.stats,c=p.csv||{};
  let usedFBA=getStat(s,11)||getCsv(c,11);
  let usedFBM=getStat(s,7)||getCsv(c,7);
  let newFBA=getStat(s,10)||getCsv(c,10);
  let newFBM=getStat(s,18)||getStat(s,1)||getCsv(c,18)||getCsv(c,1);
  let amazon=getStat(s,0)||getCsv(c,0);
  let rank=getStat(s,3);

  show('usedFBA',usedFBA);
  show('usedFBM',usedFBM);
  show('newFBA',newFBA);
  show('newFBM',newFBM);
  show('amazon',amazon);

  document.getElementById('rank').textContent=rank?rank.v.toLocaleString():'--';
  document.getElementById('rank_src').textContent=rank?`[${rank.src}]`:'';

  const prices=condition==='used'?[usedFBA,usedFBM]:[newFBA,amazon,newFBM];
  const sell=prices.find(x=>x?.v);
  if(!sell){
    decision.textContent='PASS';
    reason.textContent='No active offers (suppressed or OOP)';
    profit.textContent='--';
    banner.className='banner pass';
  }else{
    const sellP=sell.v/100,fees=sellP*0.15+4.5,buy=1,net=sellP-buy-fees;
    decision.textContent=net>=5?'BUY':'PASS';
    profit.textContent=`$${net.toFixed(2)}`;
    reason.textContent=`Using ${sell.src} price`;
    banner.className='banner '+(net>=5?'buy':'pass');
  }

  card.style.display='block';
  navigator.vibrate?.(sell&&sell.v>=500?[60]:[20,20]);
  setTimeout(()=>{barcodeInput.value='';barcodeInput.focus()},600);
}
</script>
</body>
</html>
