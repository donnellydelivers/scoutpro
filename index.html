<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ScoutPro AI v3.1 (Token Saver)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0a0e1a;
  --panel: #141b2d;
  --card: #1a2332;
  --border: rgba(255,255,255,.08);
  --text: #ffffff;
  --muted: #8b92ab;
  --green: #10b981;
  --yellow: #fbbf24;
  --red: #ef4444;
  --blue: #3b82f6;
}

* { 
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.app { 
  max-width: 480px;
  margin: 0 auto;
  min-height: 100vh;
  padding-bottom: 140px;
}

/* Header */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--bg);
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.brand {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.brand-title {
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.02em;
}

.brand-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid rgba(59, 130, 246, 0.3);
  border-radius: 999px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--blue);
  font-weight: 600;
}

.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 999px;
  background: var(--blue);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.input-row {
  display: grid;
  grid-template-columns: 1fr auto auto;
  gap: 8px;
  width: 100%;
}

input[type="text"] {
  min-width: 0;
  padding: 14px 16px;
  border-radius: 12px;
  background: var(--panel);
  border: 1px solid var(--border);
  color: var(--text);
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 15px;
  outline: none;
  transition: border-color 0.2s;
}

input[type="text"]:focus {
  border-color: var(--blue);
}

input[type="text"]::placeholder {
  color: var(--muted);
}

button {
  padding: 14px 20px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: transform 0.1s, opacity 0.2s;
}

button:active {
  transform: scale(0.98);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Status Bar */
.status-bar {
  padding: 10px 16px;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 12px;
  color: var(--muted);
  background: var(--panel);
  margin: 12px 12px 0;
  border-radius: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.status-label {
  color: var(--blue);
}

/* Duplicate Warning */
#dupeWarning {
  padding: 10px 16px;
  margin: 12px;
  background: rgba(251, 191, 36, 0.1);
  border: 1px solid var(--yellow);
  border-radius: 8px;
  color: var(--yellow);
  font-size: 13px;
  display: none;
}

/* Processing State */
.processing {
  margin: 12px;
  padding: 24px;
  background: var(--panel);
  border-radius: 16px;
  border: 1px solid var(--border);
  text-align: center;
  display: none;
}

.spinner {
  width: 40px;
  height: 40px;
  margin: 0 auto 16px;
  border: 3px solid var(--border);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.processing-text {
  font-size: 14px;
  color: var(--muted);
}

/* Cards */
.card {
  margin: 12px;
  background: var(--panel);
  border-radius: 16px;
  border: 1px solid var(--border);
  overflow: hidden;
}

/* Decision Banner */
.banner {
  padding: 24px 20px;
  text-align: center;
  position: relative;
}

.banner.buy { 
  background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), transparent);
  border-bottom: 2px solid rgba(16, 185, 129, 0.3);
}

.banner.pass { 
  background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), transparent);
  border-bottom: 2px solid rgba(239, 68, 68, 0.3);
}

.banner.gem {
  background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(16, 185, 129, 0.1));
  border-bottom: 2px solid rgba(251, 191, 36, 0.5);
  box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
}

.gem-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #000;
  margin-bottom: 8px;
  box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
  animation: gem-pulse 2s ease-in-out infinite;
}

.gem-sparkle {
  font-size: 14px;
  animation: sparkle 1.5s ease-in-out infinite;
}

@keyframes gem-pulse {
  0%, 100% { 
    transform: scale(1);
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(251, 191, 36, 0.6);
  }
}

@keyframes sparkle {
  0%, 100% { 
    opacity: 1;
    transform: rotate(0deg);
  }
  50% { 
    opacity: 0.7;
    transform: rotate(180deg);
  }
}

.gem-reasons {
  margin-top: 12px;
  padding: 12px;
  background: rgba(251, 191, 36, 0.1);
  border-radius: 8px;
  border: 1px solid rgba(251, 191, 36, 0.3);
  font-size: 12px;
  color: var(--text);
  text-align: left;
}

.gem-reasons strong {
  color: #fbbf24;
  display: block;
  margin-bottom: 6px;
  font-size: 13px;
}

/* Gemini Insights */
.gemini-insights {
  margin-top: 16px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1));
  border-radius: 12px;
  border: 1px solid rgba(139, 92, 246, 0.3);
  display: none;
}

.gemini-insights-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  font-weight: 700;
  font-size: 14px;
  color: #a78bfa;
}

.gemini-insights-body {
  font-size: 13px;
  line-height: 1.6;
  color: var(--text);
}

.gemini-loading {
  text-align: center;
  padding: 20px;
  color: var(--muted);
  font-size: 13px;
}

.gemini-loading-spinner {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid var(--border);
  border-top-color: #8b5cf6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 8px;
}

.banner .decision {
  font-size: 36px;
  font-weight: 800;
  letter-spacing: 0.02em;
  margin-bottom: 6px;
}

.banner.buy .decision { color: var(--green); }
.banner.pass .decision { color: var(--red); }

.banner .reason {
  font-size: 14px;
  color: var(--muted);
  margin-bottom: 16px;
}

.banner .explanation {
  font-size: 13px;
  color: var(--text);
  line-height: 1.6;
  text-align: left;
  background: rgba(0,0,0,0.3);
  padding: 14px;
  border-radius: 10px;
  margin-top: 16px;
}

.banner .explanation ul {
  margin: 0;
  padding-left: 20px;
}

.banner .explanation li {
  margin: 6px 0;
}

/* Stats Grid */
.stats {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-top: 20px;
}

.stat {
  background: var(--card);
  padding: 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
}

.stat-label {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 6px;
}

.stat-value {
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 20px;
  font-weight: 700;
}

.stat-value.negative { color: var(--red); }
.stat-value.warning { color: var(--yellow); }

/* Section */
.section {
  padding: 20px;
  border-top: 1px solid var(--border);
}

.section-title {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 16px;
  font-weight: 600;
}

/* Sliders */
.slider-group {
  margin-bottom: 20px;
}

.slider-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 14px;
}

.slider-value {
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-weight: 600;
  color: var(--blue);
}

input[type="range"] {
  width: 100%;
  height: 6px;
  border-radius: 3px;
  background: var(--card);
  outline: none;
  -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--blue);
  cursor: pointer;
  border: 3px solid var(--panel);
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

input[type="range"]::-moz-range-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--blue);
  cursor: pointer;
  border: 3px solid var(--panel);
}

/* Settings */
.settings-group {
  margin-bottom: 16px;
}

.settings-label {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
}

.settings-input {
  width: 100%;
  padding: 10px 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 13px;
  outline: none;
}

.settings-input:focus {
  border-color: var(--blue);
}

.settings-hint {
  font-size: 11px;
  color: var(--muted);
  margin-top: 4px;
}

/* Action Buttons */
.actions {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 16px;
  background: linear-gradient(to top, var(--bg) 70%, transparent);
  display: flex;
  gap: 10px;
  max-width: 480px;
  margin: 0 auto;
}

.actions button {
  flex: 1;
  padding: 16px;
  font-size: 14px;
  font-weight: 600;
}

.btn-download {
  background: var(--green);
  color: var(--bg);
}

.btn-clear {
  background: var(--red);
  color: white;
}

.btn-settings {
  background: var(--blue);
  color: white;
}

.btn-history {
  background: var(--yellow);
  color: var(--bg);
}

/* History */
#historyPage, #settingsPage { display: none; }

.history-item {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.history-item:last-child {
  border-bottom: none;
}

.history-decision {
  font-weight: 700;
  font-size: 14px;
  margin-bottom: 6px;
}

.history-decision.ACCEPT { color: var(--green); }
.history-decision.REJECT { color: var(--red); }

.history-title {
  font-size: 13px;
  margin-bottom: 8px;
  color: var(--text);
}

.history-meta {
  font-size: 11px;
  color: var(--muted);
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  line-height: 1.6;
}

.flash {
  animation: flash 300ms ease-out;
}

@keyframes flash {
  0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
  100% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
}

.hidden { display: none !important; }
</style>
</head>

<body>
<div class="app">

<header>
  <div class="brand">
    <div class="brand-title">ScoutPro AI</div>
    <div style="display:flex;gap:6px;align-items:center;">
      <div class="brand-badge" id="keepaBadge" style="display:none;background:rgba(16,185,129,0.1);border-color:rgba(16,185,129,0.3);color:#10b981;">
        <div class="status-dot" style="background:#10b981;"></div>
        <span>Keepa API</span>
      </div>
      <div class="brand-badge" id="engineBadge">
        <div class="status-dot"></div>
        <span id="engineName">Local Engine</span>
      </div>
    </div>
  </div>
  <div class="input-row">
    <input id="scanInput" type="text" placeholder="Scan Barcode or Enter ASIN..." autocomplete="off" />
    <button id="settingsBtn" class="btn-settings" style="background:var(--card);color:var(--muted);padding:12px;min-width:48px;" title="Settings">‚öôÔ∏è</button>
    <button id="historyBtn" class="btn-history">History</button>
  </div>
</header>

<div class="status-bar">
  <span id="statusText">Ready to scan</span>
  <span id="itemCount"><span class="status-label">Queue:</span> 0</span>
  <span id="tokenCount" style="display:none;"><span class="status-label">Tokens:</span> <span id="tokenValue">0</span></span>
</div>

<div id="dupeWarning">‚ö†Ô∏è Already scanned ‚Äî ignored</div>

<div class="processing" id="processing">
  <div class="spinner"></div>
  <div class="processing-text" id="processingText">Analyzing...</div>
</div>

<div id="mainPage">
  <div class="card hidden" id="resultCard">
    <div id="banner" class="banner buy">
      <div id="gemBadge" class="gem-badge" style="display:none;">
        <span class="gem-sparkle">‚ú®</span>
        <span>HIDDEN GEM</span>
        <span class="gem-sparkle">‚ú®</span>
      </div>
      <div class="decision" id="decision">ACCEPT</div>
      <div class="reason" id="reason"></div>
      
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Target Price</div>
          <div class="stat-value" id="targetPrice">‚Äî</div>
        </div>
        <div class="stat">
          <div class="stat-label">Profit</div>
          <div class="stat-value" id="profit">‚Äî</div>
        </div>
        <div class="stat">
          <div class="stat-label">ROI</div>
          <div class="stat-value" id="roi">‚Äî</div>
        </div>
        <div class="stat">
          <div class="stat-label">Buy Box</div>
          <div class="stat-value" id="bb">‚Äî</div>
        </div>
      </div>
      
      <div class="explanation" id="explanation"></div>
      
      <button id="askGeminiBtn" class="btn-toggle" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white;width:100%;margin-top:16px;display:none;padding:14px;font-weight:600;">
        ü§ñ Ask Gemini Why
      </button>
      
      <div class="gemini-insights" id="geminiInsights">
        <div class="gemini-insights-header">
          <span>ü§ñ</span>
          <span>Gemini AI Analysis</span>
        </div>
        <div class="gemini-insights-body" id="geminiInsightsBody"></div>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Scanner Controls</div>
      
      <div class="slider-group">
        <div class="slider-label">
          <span>Buy Cost</span>
          <span class="slider-value">$<span id="buyCostVal">1.00</span></span>
        </div>
        <input type="range" min="0.10" max="10" step="0.10" id="buyCostSlider" value="1.00" />
      </div>

      <div class="slider-group">
        <div class="slider-label">
          <span>Profit Floor</span>
          <span class="slider-value">$<span id="profitFloorVal">5.00</span></span>
        </div>
        <input type="range" min="1" max="20" step="1" id="profitFloorSlider" value="5" />
      </div>
    </div>
  </div>
</div>

<div id="settingsPage" class="card">
  <div class="section">
    <div class="section-title">‚öôÔ∏è Settings</div>
    
    <div style="background:rgba(59,130,246,0.1); padding:12px; border-radius:8px; margin-bottom:20px; border:1px solid rgba(59,130,246,0.3);">
      <div style="font-size:13px; color:var(--text); line-height:1.6;">
        <strong style="color:var(--blue);">üîë API Keys Required</strong><br>
        ScoutPro needs your API keys to fetch real product data and provide AI analysis.
      </div>
    </div>
    
    <div class="settings-group">
      <label class="settings-label">Keepa API Key <span style="color:var(--red);">*</span></label>
      <input type="password" id="keepaKey" class="settings-input" placeholder="Enter your Keepa API key" />
      <div class="settings-hint">
        Required for product lookups. Get your key at <a href="https://keepa.com/#!api" target="_blank" style="color:var(--blue);text-decoration:underline;">keepa.com/#!api</a><br>
        <span style="font-size:11px;">Tip: Your keys are stored locally on this device only.</span>
      </div>
    </div>
    
    <div class="settings-group">
      <label class="settings-label">Gemini API Key <span style="color:var(--muted);">(Optional)</span></label>
      <input type="password" id="geminiKey" class="settings-input" placeholder="Enter your Gemini API key (optional)" />
      <div class="settings-hint">
        Only needed for "Ask Gemini Why" feature. Get free key at <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--blue);text-decoration:underline;">aistudio.google.com</a>
      </div>
    </div>
    
    <div class="settings-group">
      <label class="settings-label">Decision Engine</label>
      <select id="useGemini" style="width:100%; padding:10px 12px; background:var(--card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px;">
        <option value="false">Local Engine (Fast, Free) ‚ö°</option>
        <option value="true">Gemini AI (Smarter, requires API key) ü§ñ</option>
      </select>
      <div class="settings-hint">
        Recommended: Use Local Engine for fast scanning, then click "Ask Gemini Why" on specific items you're curious about.
      </div>
    </div>
    
    <button id="saveSettings" style="width:100%; background:var(--green); color:var(--bg); margin-top:16px; padding:14px; font-weight:700;">
      ‚úÖ Save Settings
    </button>
    
    <button id="forceLocalEngine" style="width:100%; background:var(--blue); color:white; margin-top:8px; padding:14px; font-weight:600;">
      ‚ö° Use Local Engine (Recommended)
    </button>
    
    <button id="backFromSettings" style="width:100%; background:var(--panel); color:var(--text); margin-top:8px; border:1px solid var(--border); padding:14px;">
      ‚Üê Back to Scanner
    </button>
  </div>
</div>

<div id="historyPage" class="card">
  <div class="section">
    <div class="section-title">Scan History</div>
    <div id="historyList"></div>
    <button id="backBtn" style="margin-top:16px; background:var(--blue); color:white; width:100%;">Back</button>
  </div>
</div>

<div class="actions">
  <button id="downloadBtn" class="btn-download">Download</button>
  <button id="clearBtn" class="btn-clear">Clear</button>
</div>

</div>

<script>
/* ==================== CONFIG & SETUP ==================== */
let BUY_COST = 1.00;
let PROFIT_FLOOR = 5.00;
let buffer = "";
let timer = null;
const SCAN_DELAY = 100;

const CONFIG = {
  keepaKey: localStorage.getItem('keepaKey') || '',
  geminiKey: localStorage.getItem('geminiKey') || '',
  useGemini: localStorage.getItem('useGemini') === 'true'
};

const seenIdentifiers = new Set();
let scanHistory = [];
let buyList = [];
let lastScanData = null;

const scanInput = document.getElementById("scanInput");
scanInput.focus();

/* ==================== ENGINE & BADGES ==================== */
function updateEngineBadge() {
  const badge = document.getElementById("engineName");
  badge.textContent = CONFIG.useGemini ? "Gemini AI" : "Local Engine";
  
  const keepaBadge = document.getElementById("keepaBadge");
  if (CONFIG.keepaKey) {
    keepaBadge.style.display = "flex";
  } else {
    keepaBadge.style.display = "none";
  }
}
updateEngineBadge();

window.useLocalEngine = function() {
  CONFIG.useGemini = false;
  localStorage.setItem('useGemini', 'false');
  updateEngineBadge();
};

/* ==================== ASK GEMINI WHY ==================== */
document.getElementById("askGeminiBtn").onclick = async () => {
  if (!lastScanData) return;
  if (!CONFIG.geminiKey) {
    alert('‚ö†Ô∏è Please add your Gemini API key in Settings first');
    return;
  }
  
  const insightsContainer = document.getElementById("geminiInsights");
  const insightsBody = document.getElementById("geminiInsightsBody");
  const btn = document.getElementById("askGeminiBtn");
  
  btn.disabled = true;
  btn.textContent = "ü§ñ Analyzing...";
  insightsContainer.style.display = "block";
  insightsBody.innerHTML = '<div class="gemini-loading"><div class="gemini-loading-spinner"></div><br>Gemini is analyzing this item...</div>';
  
  try {
    const { decision, keepaData } = lastScanData;
    
    const prompt = `You are an expert Amazon FBA book reseller analyzing this item.

ITEM DATA:
- Title: ${keepaData.title}
- ASIN: ${keepaData.asin}
- Sales Rank: ${keepaData.salesRank.toLocaleString()}
- Rank Drops (30d): ${keepaData.salesRankDrops30} (REAL DATA)
- Current FBA Price: $${keepaData.currentPriceFBA}
- Current FBM Price: $${keepaData.currentPriceFBM}
- Amazon Price: ${keepaData.currentPriceAmazon > 0 ? '$' + keepaData.currentPriceAmazon : 'Not available'}
- Buy Box Winner: ${keepaData.buyBoxWinner}
- Price Volatility: ${keepaData.priceVolatility}

LOCAL ENGINE DECISION:
- Verdict: ${decision.verdict}
- Profit: $${decision.profit}
- ROI: ${decision.roi}%
- Reasoning: ${decision.reasoning.replace(/<[^>]*>/g, '')}

USER THRESHOLDS:
- Buy Cost: $${BUY_COST}
- Profit Floor: $${PROFIT_FLOOR}

ANALYZE THIS:
1. Do you agree with the ${decision.verdict} decision? Why or why not?
2. What market dynamics or patterns do you see?
3. What are the risks and opportunities?
4. Would you personally buy this?

Keep response conversational and under 200 words.`;

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${CONFIG.geminiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: {
          temperature: 0.7,
          maxOutputTokens: 500
        }
      })
    });

    if (!response.ok) throw new Error(`Gemini API error: ${response.status}`);

    const data = await response.json();
    const insights = data.candidates[0].content.parts[0].text;
    
    const formattedInsights = insights
      .split('\n')
      .map(line => line.trim())
      .filter(line => line.length > 0)
      .join('<br><br>');
    
    insightsBody.innerHTML = formattedInsights;
    
  } catch (error) {
    console.error('Gemini insights error:', error);
    insightsBody.innerHTML = `<div style="color:var(--red);">‚ùå Error: ${error.message}</div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = "ü§ñ Ask Gemini Again";
  }
};

/* ==================== SLIDERS ==================== */
const bcSlider = document.getElementById("buyCostSlider");
const pfSlider = document.getElementById("profitFloorSlider");
let sliderTimeout = null;

bcSlider.oninput = () => {
  BUY_COST = parseFloat(bcSlider.value);
  document.getElementById("buyCostVal").textContent = BUY_COST.toFixed(2);
  clearTimeout(sliderTimeout);
  sliderTimeout = setTimeout(() => { if (lastScanData) reanalyzeWithNewThresholds(); }, 300);
};

pfSlider.oninput = () => {
  PROFIT_FLOOR = parseFloat(pfSlider.value);
  document.getElementById("profitFloorVal").textContent = PROFIT_FLOOR.toFixed(2);
  clearTimeout(sliderTimeout);
  sliderTimeout = setTimeout(() => { if (lastScanData) reanalyzeWithNewThresholds(); }, 300);
};

/* ==================== SETTINGS ==================== */
document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("mainPage").style.display = "none";
  document.getElementById("settingsPage").style.display = "block";
  document.getElementById("keepaKey").value = CONFIG.keepaKey;
  document.getElementById("geminiKey").value = CONFIG.geminiKey;
  document.getElementById("useGemini").value = CONFIG.useGemini ? "true" : "false";
};

document.getElementById("saveSettings").onclick = () => {
  CONFIG.keepaKey = document.getElementById("keepaKey").value.trim();
  CONFIG.geminiKey = document.getElementById("geminiKey").value.trim();
  CONFIG.useGemini = document.getElementById("useGemini").value === "true";
  
  localStorage.setItem('keepaKey', CONFIG.keepaKey);
  localStorage.setItem('geminiKey', CONFIG.geminiKey);
  localStorage.setItem('useGemini', CONFIG.useGemini);
  
  updateEngineBadge();
  alert('‚úÖ Settings saved!');
  document.getElementById("settingsPage").style.display = "none";
  document.getElementById("mainPage").style.display = "block";
};

document.getElementById("forceLocalEngine").onclick = () => {
  document.getElementById("useGemini").value = "false";
  CONFIG.useGemini = false;
  localStorage.setItem('useGemini', 'false');
  updateEngineBadge();
  alert("‚ö° Switched to Local Engine!");
};

document.getElementById("backFromSettings").onclick = () => {
  document.getElementById("settingsPage").style.display = "none";
  document.getElementById("mainPage").style.display = "block";
};

/* ==================== SCAN INPUT & BARCODE HANDLING ==================== */
scanInput.addEventListener("input", e => {
  buffer += e.data || "";
  scanInput.value = buffer;
  clearTimeout(timer);
  timer = setTimeout(finalizeScan, SCAN_DELAY);
});

scanInput.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    clearTimeout(timer);
    finalizeScan();
  }
});

function detectInputType(input) {
  const cleaned = input.replace(/[^0-9X]/gi, '');
  if (cleaned.length === 10 || cleaned.length === 13) return cleaned; // ISBN
  if (cleaned.length >= 12 && cleaned.length <= 14) return cleaned; // UPC/EAN
  if (/^B[0-9A-Z]{9}$/i.test(input)) return input.toUpperCase(); // ASIN
  return input; // Fallback
}

function checkDuplicate(identifier) {
  if (seenIdentifiers.has(identifier)) {
    document.getElementById("dupeWarning").style.display = "block";
    setTimeout(() => document.getElementById("dupeWarning").style.display = "none", 2000);
    return true;
  }
  seenIdentifiers.add(identifier);
  return false;
}

/* ==================== MAIN SCAN LOGIC ==================== */
async function finalizeScan() {
  const input = buffer.trim() || scanInput.value.trim();
  buffer = "";
  scanInput.value = "";
  scanInput.focus();

  if (!input) return;
  if (navigator.vibrate) navigator.vibrate(40);
  
  if (!CONFIG.keepaKey) console.warn('No Keepa key - using mock data');
  
  const identifier = detectInputType(input);
  if (checkDuplicate(identifier)) return;
  
  const engineName = CONFIG.useGemini ? 'Gemini AI' : 'Local Engine';
  document.getElementById("statusText").textContent = `Looking up: ${identifier}`;
  document.getElementById("processingText").textContent = `Decision Engine: ${engineName}`;
  document.getElementById("processing").style.display = "block";
  document.getElementById("resultCard").classList.add("hidden");
  
  try {
    // 1. Query Keepa (New Optimized Function)
    const keepaData = await queryKeepa(identifier, input);
    
    // 2. Decision Logic
    let decision;
    try {
      decision = CONFIG.useGemini 
        ? await analyzeWithGemini(keepaData)
        : localDecisionEngine(keepaData);
    } catch (analysisError) {
      console.warn('Analysis failed, using local fallback:', analysisError.message);
      decision = localDecisionEngine(keepaData);
    }
    
    // 3. Display
    displayResult(decision, keepaData);
    addToHistory(decision, keepaData);
    
    document.getElementById("statusText").textContent = `${decision.verdict}: ${keepaData.title}`;
    document.getElementById("processing").style.display = "none";
    
  } catch (error) {
    console.error('Scan error:', error);
    let errorMsg = error.message;
    if (errorMsg.includes('Failed to fetch')) errorMsg = 'Network error.';
    else if (errorMsg.includes('API key')) errorMsg = 'Invalid API key.';
    
    document.getElementById("statusText").textContent = "Error";
    document.getElementById("processing").style.display = "none";
    document.getElementById("resultCard").classList.remove("hidden");
    document.getElementById("banner").className = "banner pass";
    document.getElementById("decision").textContent = "ERROR";
    document.getElementById("reason").textContent = errorMsg;
    document.getElementById("explanation").innerHTML = `‚ö†Ô∏è ${error.message}`;
  }
}

/* ==================== KEEPA API (OPTIMIZED) ==================== */
async function queryKeepa(identifier, rawInput) {
  if (!CONFIG.keepaKey) {
    return getMockKeepaData(identifier, rawInput);
  }
  
  try {
    const domain = 1; // US
    let queryParam = '';
    
    // 1. ASIN (B0...) -> Use 'asin' param
    if (/^B[0-9A-Z]{9}$/i.test(identifier)) {
      queryParam = `asin=${encodeURIComponent(identifier)}`;
    } 
    // 2. ISBN/UPC -> Use 'code' param (Prevents broad search token leaks)
    else {
      queryParam = `code=${encodeURIComponent(identifier)}`;
    }
    
    // OPTIMIZATION: &offers=0, &history=0 (Saves tokens & bandwidth)
    const url = `https://api.keepa.com/product?key=${CONFIG.keepaKey}&domain=${domain}&${queryParam}&offers=0&history=0&rating=0&stats=1`;
    
    console.log('Keepa API call:', url.replace(CONFIG.keepaKey, 'HIDDEN'));
    const response = await fetch(url);
    
    if (!response.ok) {
      if (response.status === 429) throw new Error('‚è±Ô∏è Keepa rate limit. Slow down.');
      if (response.status === 402) throw new Error('üí≥ Keepa quota exceeded.');
      throw new Error(`Keepa API error: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (data.tokensConsumed !== undefined) {
      document.getElementById("tokenCount").style.display = "block";
      document.getElementById("tokenValue").textContent = data.tokensConsumed;
    }
    
    if (!data.products || data.products.length === 0) {
      throw new Error('Product not found in Keepa database');
    }
    
    return parseKeepaResponse(data.products[0]);
    
  } catch (error) {
    throw error;
  }
}

/* ==================== PARSE KEEPA RESPONSE (OPTIMIZED) ==================== */
function parseKeepaResponse(product) {
  const parsePrice = (val) => {
    if (val === null || val === undefined || val === -1) return 0;
    return val / 100;
  };
  
  const stats = product.stats || {};
  const current = stats.current || [];
  
  // Indices: 0: Amazon, 1: New, 2: Used, 18: Sales Rank
  const amazonPrice = parsePrice(current[0]);
  const newPrice = parsePrice(current[1]); 
  const usedPrice = parsePrice(current[2]);
  const salesRank = current[18] || 0;
  
  // REAL Velocity Data
  const salesRankDrops30 = stats.salesRankDrops30 || 0;
  const salesRankDrops90 = stats.salesRankDrops90 || (salesRankDrops30 * 3);
  
  // Buy Box Logic
  const buyBoxPrice = parsePrice(stats.buyBoxPrice);
  let buyBoxWinner = 'UNKNOWN';
  
  if (buyBoxPrice > 0) {
    if (buyBoxPrice === amazonPrice) buyBoxWinner = 'AMAZON';
    else if (buyBoxPrice === newPrice) buyBoxWinner = 'FBA'; 
    else buyBoxWinner = 'FBM';
  } else {
    if (amazonPrice > 0) buyBoxWinner = 'AMAZON';
    else if (newPrice > 0) buyBoxWinner = 'FBA';
    else buyBoxWinner = 'FBM';
  }

  const totalOffers = (stats.offerCountUsed || 0) + (stats.offerCountNew || 0);
  
  return {
    asin: product.asin || 'UNKNOWN',
    title: product.title || 'Unknown Product',
    salesRank: salesRank,
    salesRankDrops30: salesRankDrops30, 
    salesRankDrops90: salesRankDrops90,
    avgRank30: stats.avg30 ? stats.avg30[18] : salesRank,
    avgRank90: stats.avg90 ? stats.avg90[18] : salesRank,
    currentPriceFBA: newPrice > 0 ? newPrice : usedPrice,
    currentPriceFBM: usedPrice,
    currentPriceAmazon: amazonPrice,
    avgPrice30: stats.avg30 ? parsePrice(stats.avg30[2]) : usedPrice,
    buyBoxWinner: buyBoxWinner,
    buyBoxPrice: buyBoxPrice,
    offerCountFBA: product.fbaFees ? 1 : 0,
    offerCountFBM: totalOffers,
    priceVolatility: 'Low',
    condition: 'Used - Very Good',
    weight: product.packageWeight ? product.packageWeight / 100 : 1.0,
    reviewCount: product.reviewCount || 0,
    packageQuantity: product.packageQuantity || 1,
    outOfPrint: false 
  };
}

/* ==================== MOCK DATA FALLBACK ==================== */
function getMockKeepaData(identifier, rawInput) {
  const rank = Math.floor(Math.random() * 900000) + 10000;
  const drops30 = Math.floor(Math.random() * 40) + 2;
  return {
    asin: 'B00' + Math.random().toString(36).substring(2, 9).toUpperCase(),
    title: `Test Product for ${rawInput}`,
    salesRank: rank,
    salesRankDrops30: drops30,
    salesRankDrops90: drops30 * 3,
    avgRank30: rank * 1.1,
    avgRank90: rank * 1.2,
    currentPriceFBA: +(Math.random() * 25 + 12).toFixed(2),
    currentPriceFBM: +(Math.random() * 20 + 10).toFixed(2),
    currentPriceAmazon: Math.random() > 0.6 ? +(Math.random() * 28 + 15).toFixed(2) : 0,
    avgPrice30: 15.00,
    buyBoxWinner: ['FBA', 'FBM', 'AMAZON'][Math.floor(Math.random() * 3)],
    offerCountFBA: 5,
    offerCountFBM: 10,
    priceVolatility: 'Low',
    weight: 1.5
  };
}

/* ==================== DECISION ENGINE (AI) ==================== */
async function analyzeWithGemini(keepaData) {
  const prompt = `You are an AI sourcing assistant for Amazon FBA.
  
PRODUCT:
${JSON.stringify(keepaData)}

CONTEXT:
- Buy Cost: $${BUY_COST.toFixed(2)}
- Total COGS: $${(BUY_COST + 0.75).toFixed(2)} (includes $0.75 shipping to Amazon)
- Profit Floor: $${PROFIT_FLOOR.toFixed(2)}
- Weight is IRRELEVANT for FBA profitability calculations (fees already account for it).

TASK:
1. Target Sell Price = Buy Box Price (or FBA price)
2. Profit = Target Price - COGS - (Target Price * 0.15 + 5.00)
3. Accept if Profit >= Profit Floor

OUTPUT JSON:
{
  "verdict": "ACCEPT" or "REJECT",
  "targetPrice": 24.99,
  "profit": 8.50,
  "roi": 425,
  "reasoning": "Short HTML bullets explaining why."
}`;

  try {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${CONFIG.geminiKey}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { responseMimeType: "application/json" }
      })
    });

    if (!response.ok) throw new Error(`Gemini Error: ${response.status}`);
    const data = await response.json();
    return JSON.parse(data.candidates[0].content.parts[0].text);
  } catch (error) {
    console.warn('Gemini failed, fallback to local');
    return localDecisionEngine(keepaData);
  }
}

/* ==================== HIDDEN GEM DETECTION ==================== */
function detectHiddenGems(keepaData, decision) {
  const gems = [];
  if (decision.verdict !== 'ACCEPT') return gems;
  
  if (keepaData.salesRank > 500000 && keepaData.salesRankDrops30 >= 15) {
    gems.push({ type: 'high-velocity', icon: 'üöÄ', label: 'High velocity despite rank', details: `${keepaData.salesRankDrops30} drops/30d` });
  }
  if (keepaData.offerCountFBA <= 3 && keepaData.offerCountFBA > 0 && decision.profit > 5) {
    gems.push({ type: 'low-competition', icon: 'üéØ', label: 'Low competition', details: `Only ${keepaData.offerCountFBA} FBA sellers` });
  }
  if (keepaData.currentPriceAmazon === 0 && keepaData.buyBoxWinner !== 'AMAZON' && decision.profit > 5) {
    gems.push({ type: 'amazon-oos', icon: 'üèÜ', label: 'Amazon OOS', details: 'Amazon not selling' });
  }
  if (decision.roi > 200 && decision.profit > 8) {
    gems.push({ type: 'high-margin', icon: 'üí∞', label: 'Big Margin', details: `${decision.roi}% ROI` });
  }
  
  return gems;
}

/* ==================== LOCAL DECISION ENGINE ==================== */
function localDecisionEngine(keepaData) {
  let targetPrice = keepaData.currentPriceFBA;
  
  if (keepaData.buyBoxWinner === "AMAZON") targetPrice = keepaData.currentPriceAmazon * 0.95;
  else if (keepaData.buyBoxWinner === "FBM") targetPrice = keepaData.currentPriceFBM * 0.98;
  else if (keepaData.buyBoxWinner === "FBA") targetPrice = keepaData.currentPriceFBA * 0.97;
  
  const totalCOGS = BUY_COST + 0.75; // 75 cents shipping to warehouse
  const fees = targetPrice * 0.15 + 5; // Rough FBA fee estimate
  const profit = targetPrice - totalCOGS - fees;
  const roi = Math.round((profit / totalCOGS) * 100);
  
  let verdict = "REJECT";
  let reasoning = "";
  
  if (profit >= PROFIT_FLOOR) {
    verdict = "ACCEPT";
    reasoning = `‚úì Profit: $${profit.toFixed(2)} (${roi}% ROI)<br>‚úì Target: $${targetPrice.toFixed(2)}`;
  } else {
    reasoning = `‚úó Low Profit: $${profit.toFixed(2)}<br>‚úó Fees too high for price`;
  }
  
  return {
    verdict,
    targetPrice: Math.round(targetPrice * 100) / 100,
    profit: Math.round(profit * 100) / 100,
    roi,
    reasoning
  };
}

/* ==================== DISPLAY & UTILS ==================== */
function displayResult(decision, keepaData) {
  lastScanData = { decision, keepaData };
  
  const banner = document.getElementById("banner");
  const cls = decision.verdict === "ACCEPT" ? "buy" : "pass";
  const gems = detectHiddenGems(keepaData, decision);
  const isGem = gems.length > 0;
  
  banner.className = `banner ${cls}${isGem ? ' gem' : ''}`;
  document.getElementById("gemBadge").style.display = isGem ? "inline-flex" : "none";
  
  document.getElementById("decision").textContent = decision.verdict;
  document.getElementById("reason").textContent = keepaData.title;
  document.getElementById("targetPrice").textContent = `$${decision.targetPrice.toFixed(2)}`;
  document.getElementById("profit").textContent = `$${decision.profit.toFixed(2)}`;
  document.getElementById("roi").textContent = `${decision.roi}%`;
  document.getElementById("bb").textContent = keepaData.buyBoxWinner;
  
  document.getElementById("profit").className = "stat-value" + (decision.profit < 0 ? " negative" : "");
  
  let explanationHTML = decision.reasoning;
  if (isGem) {
    explanationHTML += '<div class="gem-reasons"><strong>üíé Hidden Gem:</strong>';
    gems.forEach(gem => {
      explanationHTML += `<div style="margin:6px 0;">${gem.icon} <strong>${gem.label}:</strong> ${gem.details}</div>`;
    });
    explanationHTML += '</div>';
  }
  
  document.getElementById("explanation").innerHTML = explanationHTML;
  document.getElementById("askGeminiBtn").style.display = CONFIG.geminiKey ? "block" : "none";
  document.getElementById("geminiInsights").style.display = "none";
  
  document.getElementById("resultCard").classList.remove("hidden");
  document.getElementById("resultCard").classList.add("flash");
  setTimeout(() => document.getElementById("resultCard").classList.remove("flash"), 300);
}

async function reanalyzeWithNewThresholds() {
  if (!lastScanData) return;
  try {
    const decision = CONFIG.useGemini
      ? await analyzeWithGemini(lastScanData.keepaData)
      : localDecisionEngine(lastScanData.keepaData);
    displayResult(decision, lastScanData.keepaData);
  } catch (e) { console.error(e); }
}

function addToHistory(decision, keepaData) {
  const gems = detectHiddenGems(keepaData, decision);
  const record = {
    verdict: decision.verdict,
    title: keepaData.title,
    asin: keepaData.asin,
    price: decision.targetPrice.toFixed(2),
    profit: decision.profit.toFixed(2),
    roi: decision.roi,
    time: new Date().toLocaleTimeString(),
    isGem: gems.length > 0,
    gemTypes: gems.map(g => g.label).join(', ')
  };
  scanHistory.push(record);
  if (decision.verdict === "ACCEPT") buyList.push(record);
  
  const list = document.getElementById("historyList");
  list.innerHTML = '';
  scanHistory.slice().reverse().forEach(rec => {
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <div class="history-decision ${rec.verdict}">${rec.isGem?'‚ú® ':''}${rec.verdict}</div>
      <div class="history-title">${rec.title}</div>
      <div class="history-meta">ASIN: ${rec.asin} ‚Ä¢ $${rec.profit} Profit ‚Ä¢ ${rec.roi}% ROI<br>${rec.time}</div>
    `;
    list.appendChild(div);
  });
  document.getElementById("itemCount").innerHTML = `<span class="status-label">Queue:</span> ${buyList.length}`;
}

document.getElementById("historyBtn").onclick = () => {
  document.getElementById("mainPage").style.display = "none";
  document.getElementById("historyPage").style.display = "block";
};
document.getElementById("backBtn").onclick = () => {
  document.getElementById("historyPage").style.display = "none";
  document.getElementById("mainPage").style.display = "block";
};
document.getElementById("downloadBtn").onclick = () => {
  if (buyList.length === 0) return alert("No items in buy queue.");
  let csv = "Title,ASIN,TargetPrice,Profit,ROI,HiddenGem,GemReasons\n";
  buyList.forEach(r => {
    csv += `"${r.title}",${r.asin},${r.price},${r.profit},${r.roi}%,${r.isGem?'YES':'NO'},"${r.gemTypes}"\n`;
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
  a.download = `scoutpro_buylist_${Date.now()}.csv`;
  a.click();
};
document.getElementById("clearBtn").onclick = () => {
  if (!confirm("Clear all data?")) return;
  scanHistory = []; buyList = []; lastScanData = null; seenIdentifiers.clear();
  document.getElementById("historyList").innerHTML = "";
  document.getElementById("itemCount").innerHTML = `<span class="status-label">Queue:</span> 0`;
  document.getElementById("resultCard").classList.add("hidden");
};
</script>

</body>
</html>