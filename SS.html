<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelf Scanner</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --success-dark: #059669;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-900: #111827;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-900);
        }

        .container { max-width: 500px; margin: 0 auto; }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .header p {
            opacity: 0.95;
            font-size: 16px;
            font-weight: 500;
        }

        .screen {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .screen.active { display: block; }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Settings */
        .settings-content { padding: 30px; }
        
        .settings-header { margin-bottom: 30px; }
        
        .settings-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .settings-header p {
            color: var(--gray-600);
            font-size: 14px;
        }

        .form-group { margin-bottom: 24px; }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 6px;
            color: var(--gray-600);
            font-size: 13px;
        }

        .form-group .toggle-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle {
            position: relative;
            width: 48px;
            height: 28px;
            background: var(--gray-300);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle.active {
            background: var(--success);
        }

        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .toggle.active .toggle-knob {
            transform: translateX(20px);
        }

        .settings-footer {
            padding: 20px 30px;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        /* Upload */
        .upload-content { padding: 30px; }

        .upload-area {
            border: 3px dashed var(--gray-300);
            border-radius: 16px;
            padding: 60px 30px;
            text-align: center;
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.03);
        }

        .upload-icon { font-size: 48px; margin-bottom: 16px; }
        
        .upload-text {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .upload-hint {
            font-size: 14px;
            color: var(--gray-600);
        }

        #file-input { display: none; }

        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .photo-preview-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 4/3;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .photo-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-preview-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .photo-preview-remove:hover {
            background: var(--danger);
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            background: var(--gray-100);
            color: var(--gray-700);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .btn-scan {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--success) 0%, var(--success-dark) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            margin-top: 20px;
        }

        .btn-scan:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Scanning */
        .scanning-content {
            padding: 60px 30px;
            text-align: center;
        }

        .scanning-spinner {
            width: 64px;
            height: 64px;
            border: 4px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .scanning-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 12px;
        }

        .scanning-status {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 30px;
        }

        .scanning-progress {
            background: var(--gray-200);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .scanning-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transition: width 0.3s ease;
            width: 0;
        }

        .scanning-progress-text {
            font-size: 14px;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Results */
        .results-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .results-header h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 8px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            min-width: 0;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
            line-height: 1;
            word-break: break-word;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
            line-height: 1.2;
            word-break: break-word;
        }

        .results-grid {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .result-card {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .result-card:active {
            transform: scale(0.98);
        }

        .result-card.profitable {
            border: 3px solid var(--success);
        }

        .result-card.skip {
            border: 3px solid var(--gray-300);
            opacity: 0.6;
            cursor: default;
        }

        .result-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .result-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .result-info {
            padding: 12px;
            background: white;
        }

        .result-count {
            font-size: 18px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 4px;
        }

        .result-meta {
            font-size: 13px;
            color: var(--gray-600);
            font-weight: 500;
        }

        .results-footer {
            padding: 20px;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
            display: none;
        }

        .error-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Shelf Scanner</h1>
            <p>AI-Powered Book Discovery</p>
        </div>

        <!-- Settings Screen -->
        <div id="settings-screen" class="screen active">
            <div class="settings-content">
                <div class="settings-header">
                    <h2>Settings</h2>
                    <p>Configure your API keys and preferences</p>
                </div>

                <div id="settings-error" class="error-message"></div>

                <div class="form-group">
                    <label for="gemini-key">Gemini API Key</label>
                    <input type="password" id="gemini-key" placeholder="Enter your Gemini API key">
                    <small>Get your key at <a href="https://aistudio.google.com/apikey" target="_blank">aistudio.google.com</a></small>
                </div>

                <div class="form-group">
                    <label for="keepa-key">Keepa API Key</label>
                    <input type="password" id="keepa-key" placeholder="Enter your Keepa API key">
                    <small>Get your key at <a href="https://keepa.com/#!api" target="_blank">keepa.com</a></small>
                </div>

                <div class="form-group">
                    <label>Use Proxy Server</label>
                    <div class="toggle-row">
                        <div class="toggle" id="use-proxy-toggle" onclick="toggleProxy()">
                            <div class="toggle-knob"></div>
                        </div>
                        <span id="proxy-label">Enabled (Recommended)</span>
                    </div>
                    <small>Enable if Keepa calls fail due to CORS</small>
                </div>

                <div class="form-group">
                    <label>Strict High-Confidence Mode</label>
                    <div class="toggle-row">
                        <div class="toggle active" id="strict-mode-toggle" onclick="toggleStrictMode()">
                            <div class="toggle-knob"></div>
                        </div>
                        <span id="strict-label">Enabled (Recommended)</span>
                    </div>
                    <small>Skip blurry or partial titles to save Keepa API credits</small>
                </div>

                <div class="form-group">
                    <label for="buy-cost">Buy Cost per Book ($)</label>
                    <input type="number" id="buy-cost" placeholder="1.00" step="0.01" min="0" value="1.00">
                </div>

                <div class="form-group">
                    <label for="min-profit">Minimum Profit Target ($)</label>
                    <input type="number" id="min-profit" placeholder="3.00" step="0.50" min="0" value="3.00">
                </div>
            </div>

            <div class="settings-footer">
                <button class="btn-primary" onclick="saveSettings()">Continue to Upload</button>
            </div>
        </div>

        <!-- Upload Screen -->
        <div id="upload-screen" class="screen">
            <div class="upload-content">
                <div class="settings-header">
                    <h2>Upload Photos</h2>
                    <p>Take photos of bookshelves and upload them</p>
                </div>

                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                    <div class="upload-icon">üì∏</div>
                    <div class="upload-text">Tap to select photos</div>
                    <div class="upload-hint">Or drag and drop images here</div>
                </div>

                <input type="file" id="file-input" accept="image/*" multiple>

                <div id="photo-previews" class="photo-preview-grid"></div>

                <button class="btn-secondary" onclick="showSettings()">‚Üê Back to Settings</button>
                <button class="btn-scan" id="scan-btn" onclick="startScanning()" disabled>
                    ‚ú® Scan All Photos
                </button>
            </div>
        </div>

        <!-- Scanning Screen -->
        <div id="scanning-screen" class="screen">
            <div class="scanning-content">
                <div class="scanning-spinner"></div>
                <div class="scanning-title">Analyzing Books...</div>
                <div class="scanning-status" id="scanning-status">Initializing scan...</div>
                <div class="scanning-progress">
                    <div class="scanning-progress-bar" id="scan-progress-bar"></div>
                </div>
                <div class="scanning-progress-text" id="scan-progress-text">0%</div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <div class="results-header">
                <h2>Scan Complete</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-value" id="total-buys">0</span>
                        <span class="stat-label">Profitable</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-books">0</span>
                        <span class="stat-label">Total Books</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-profit">$0</span>
                        <span class="stat-label">Est. Profit</span>
                    </div>
                </div>
            </div>

            <div class="results-grid" id="results-grid"></div>

            <div class="results-footer">
                <button class="btn-secondary" onclick="newScan()">üîÑ New Scan</button>
            </div>
        </div>
    </div>

    <script>
        // Global CONFIG (copied from Scout Pro)
        let CONFIG = {
            geminiKey: '',
            keepaKey: '',
            useProxy: true,
            strictMode: true,
            buyCost: 1.00,
            minProfit: 3.00
        };

        let uploadedPhotos = [];
        let scanResults = [];

        // Load settings
        function loadSettings() {
            const saved = localStorage.getItem('shelf-scanner-config');
            if (saved) {
                CONFIG = JSON.parse(saved);
                document.getElementById('gemini-key').value = CONFIG.geminiKey || '';
                document.getElementById('keepa-key').value = CONFIG.keepaKey || '';
                document.getElementById('buy-cost').value = CONFIG.buyCost || 1.00;
                document.getElementById('min-profit').value = CONFIG.minProfit || 3.00;
                updateProxyToggle();
                updateStrictModeToggle();
            }
        }

        function toggleProxy() {
            CONFIG.useProxy = !CONFIG.useProxy;
            updateProxyToggle();
        }

        function updateProxyToggle() {
            const toggle = document.getElementById('use-proxy-toggle');
            const label = document.getElementById('proxy-label');
            if (CONFIG.useProxy) {
                toggle.classList.add('active');
                label.textContent = 'Enabled (Recommended)';
            } else {
                toggle.classList.remove('active');
                label.textContent = 'Disabled';
            }
        }

        function toggleStrictMode() {
            CONFIG.strictMode = !CONFIG.strictMode;
            updateStrictModeToggle();
        }

        function updateStrictModeToggle() {
            const toggle = document.getElementById('strict-mode-toggle');
            const label = document.getElementById('strict-label');
            if (CONFIG.strictMode) {
                toggle.classList.add('active');
                label.textContent = 'Enabled (Recommended)';
            } else {
                toggle.classList.remove('active');
                label.textContent = 'Disabled';
            }
        }

        function saveSettings() {
            CONFIG.geminiKey = document.getElementById('gemini-key').value.trim();
            CONFIG.keepaKey = document.getElementById('keepa-key').value.trim();
            CONFIG.buyCost = parseFloat(document.getElementById('buy-cost').value) || 1.00;
            CONFIG.minProfit = parseFloat(document.getElementById('min-profit').value) || 3.00;

            if (!CONFIG.geminiKey || !CONFIG.keepaKey) {
                showError('settings-error', 'Please enter both API keys');
                return;
            }

            localStorage.setItem('shelf-scanner-config', JSON.stringify(CONFIG));
            showScreen('upload-screen');
        }

        function showSettings() {
            showScreen('settings-screen');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        // File upload
        const fileInput = document.getElementById('file-input');
        const uploadArea = document.getElementById('upload-area');
        const scanBtn = document.getElementById('scan-btn');

        fileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files));
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            handleFiles(files);
        });

        function handleFiles(files) {
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedPhotos.push({ dataUrl: e.target.result, file: file });
                    renderPhotoPreviews();
                    scanBtn.disabled = uploadedPhotos.length === 0;
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPhotoPreviews() {
            const container = document.getElementById('photo-previews');
            container.innerHTML = '';
            uploadedPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo.dataUrl}" alt="Photo ${index + 1}">
                    <button class="photo-preview-remove" onclick="removePhoto(${index})">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        function removePhoto(index) {
            uploadedPhotos.splice(index, 1);
            renderPhotoPreviews();
            scanBtn.disabled = uploadedPhotos.length === 0;
        }

        // SCOUT PRO KEEPA FUNCTIONS (EXACT COPY)
        
        async function searchByTitle(title) {
            if(!CONFIG.keepaKey) throw new Error("No Keepa API Key");

            const cleanTitle = title.trim();
            const encodedTitle = encodeURIComponent(cleanTitle).replace(/%20/g, '+');
            const baseUrl = `https://api.keepa.com/search?key=${CONFIG.keepaKey}&domain=1&type=product&term=${encodedTitle}`;
            
            console.log('Keepa search:', cleanTitle);

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000);
            let data = null;
            
            try {
                if(CONFIG.useProxy) {
                    try {
                        const proxyEncodedTitle = encodeURIComponent(cleanTitle);
                        const proxyBaseUrl = `https://api.keepa.com/search?key=${CONFIG.keepaKey}&domain=1&type=product&term=${proxyEncodedTitle}`;
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(proxyBaseUrl)}`;
                        const res = await fetch(proxyUrl, { signal: controller.signal });
                        if(res.ok) {
                            data = await res.json();
                            if(!data.error && data.products) {
                                console.log('Proxy success:', data.products.length, 'results');
                            } else {
                                data = null;
                            }
                        }
                    } catch(proxyErr) {
                        console.log("Proxy failed:", proxyErr.message);
                    }
                }
                
                if(!data) {
                    const res = await fetch(baseUrl, { signal: controller.signal });
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                }
                
                clearTimeout(timeout);
                
                if(!data.products || data.products.length === 0) {
                    return null;
                }

                return data.products[0].asin;
                
            } catch(e) {
                clearTimeout(timeout);
                console.error('searchByTitle error:', e);
                return null;
            }
        }

        async function fetchKeepa(asin) {
            if(!CONFIG.keepaKey) throw new Error("No API Key");
            
            const days = 180;
            let url = `https://api.keepa.com/product?key=${CONFIG.keepaKey}&domain=1&asin=${asin}&stats=${days}&history=1`;
            
            if(CONFIG.useProxy) {
                try {
                    const proxy1 = `https://corsproxy.io/?${encodeURIComponent(url)}`;
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 5000);
                    
                    const res = await fetch(proxy1, { signal: controller.signal });
                    clearTimeout(id);
                    if(res.ok) {
                        const json = await res.json();
                        return parseKeepaJson(json);
                    }
                } catch(e) {
                    console.log("Proxy 1 failed, trying backup...");
                }
                
                try {
                    const proxy2 = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const res2 = await fetch(proxy2);
                    if(!res2.ok) throw new Error("Proxy 2 failed");
                    const json = await res2.json();
                    return parseKeepaJson(json);
                } catch(e2) {
                    console.log("Both proxies failed, trying direct fetch...");
                }
                
                try {
                    const res = await fetch(url);
                    if(!res.ok) throw new Error(`Keepa API Error: HTTP ${res.status}`);
                    const json = await res.json();
                    return parseKeepaJson(json);
                } catch(e3) {
                    throw new Error("Connection Failed");
                }
                
            } else {
                const res = await fetch(url);
                if(!res.ok) throw new Error(`Keepa API Error: HTTP ${res.status}`);
                const json = await res.json();
                return parseKeepaJson(json);
            }
        }

        function parseKeepaJson(json) {
            console.log('üîç RAW KEEPA RESPONSE:', json);
            
            if(json.error) throw new Error(json.error.message);
            if(!json.products || !json.products.length) {
                throw new Error("Product Not Found");
            }
            const product = json.products[0];
            
            // Get current stats (Scout Pro method)
            const s = product.stats.current;
            const stats = product.stats || {};
            
            console.log('üì¶ PRODUCT DATA:', {
                title: product.title,
                asin: product.asin,
                stats_current: s,
                packageWeight: product.packageWeight
            });
            
            // Rank from stats.current[3]
            const toVal = (v) => (v == -1 || v == null) ? 0 : v;
            const rank = toVal(s[3]) || 999999;
            
            // BUY BOX INFERENCE - Extract ALL prices
            const keepaBb = (s[18] > 0) ? s[18] / 100 : 0;
            const newPrice = (s[1] > 0) ? s[1] / 100 : 0;
            const fbaPrice = (s[10] > 0) ? s[10] / 100 : 0;
            const usedPrice = (s[2] > 0) ? s[2] / 100 : 0;
            
            console.log('üí∞ ALL PRICES FROM KEEPA:', {
                'BB (s[18])': keepaBb,
                'New (s[1])': newPrice,
                'FBA (s[10])': fbaPrice,
                'Used (s[2])': usedPrice
            });
            
            // Use inferred price hierarchy: BB > FBA > Used
            const inferredPrice = keepaBb || fbaPrice || usedPrice || 10.00;
            
            const fbaCount = toVal(s[16]) || 0;
            
            const drops30 = stats.salesRankDrops30 || 0;
            const drops90 = stats.salesRankDrops90 || 0;
            const drops180 = stats.salesRankDrops180 || 0;
            
            // Get weight
            const weight = product.packageWeight ? product.packageWeight / 100 : 1.2;
            
            console.log('üìä FINAL PARSED DATA:', {
                asin: product.asin,
                rank: rank,
                selectedPrice: inferredPrice.toFixed(2),
                weight: weight.toFixed(2),
                fbaCount: fbaCount,
                drops30: drops30,
                drops180: drops180
            });
            
            return {
                asin: product.asin,
                rank: rank,
                price: inferredPrice,
                weight: weight,
                fbaCount: fbaCount,
                drops30: drops30,
                drops90: drops90,
                drops180: drops180
            };
        }

        // Scanning
        async function startScanning() {
            showScreen('scanning-screen');
            scanResults = [];
            
            try {
                let totalBooks = 0;
                
                for (let i = 0; i < uploadedPhotos.length; i++) {
                    const photo = uploadedPhotos[i];
                    updateScanStatus(`Analyzing photo ${i + 1} of ${uploadedPhotos.length}...`);
                    updateScanProgress((i / uploadedPhotos.length) * 30);

                    const books = await analyzePhotoWithGemini(photo.dataUrl);
                    totalBooks += books.length;

                    for (let j = 0; j < books.length; j++) {
                        updateScanStatus(`Looking up: ${books[j].title}...`);
                        
                        try {
                            const asin = await searchByTitle(`${books[j].title} ${books[j].author}`);
                            if (asin) {
                                console.log('Found ASIN:', asin, 'for', books[j].title);
                                const keepaData = await fetchKeepa(asin);
                                if (keepaData) {
                                    books[j] = { ...books[j], ...keepaData };
                                    books[j].score = calculateScore(books[j]);
                                    books[j].verdict = getVerdict(books[j]);
                                    console.log('Scored:', books[j].title, '- Score:', books[j].score, 'Verdict:', books[j].verdict, 'Profit:', books[j].profit);
                                } else {
                                    console.error('No Keepa data returned for ASIN:', asin);
                                }
                            } else {
                                console.log('No ASIN found for:', books[j].title);
                            }
                        } catch (e) {
                            console.error('Lookup failed:', books[j].title, e);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 700));
                    }

                    scanResults.push({
                        photoIndex: i,
                        photoDataUrl: photo.dataUrl,
                        books: books.filter(b => b.verdict && (b.verdict === 'BUY' || b.verdict === 'CONSIDER'))
                    });
                }

                updateScanProgress(100);
                await new Promise(resolve => setTimeout(resolve, 500));
                displayResults();
            } catch (error) {
                console.error('Scanning error:', error);
                alert('Error: ' + error.message);
                showScreen('upload-screen');
            }
        }

        async function analyzePhotoWithGemini(imageDataUrl) {
            const base64Image = imageDataUrl.split(',')[1];

            const prompt = `Act as an expert book scout. Extract all visible book titles and authors from this shelf spine image.
${CONFIG.strictMode ? 'STRICT MODE: Only return books where the title is clearly legible. Skip partial or blurry spines.' : 'EXTRACT ALL: Include partial titles.'}

Return ONLY a JSON array:
[
  {"title": "Book Title", "author": "Author Name"}
]

Return [] if no books visible.`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${CONFIG.geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                        ]
                    }]
                })
            });

            if (!response.ok) throw new Error(`Gemini API error: ${response.statusText}`);

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            const jsonMatch = text.match(/\[[\s\S]*\]/);
            if (!jsonMatch) return [];

            return JSON.parse(jsonMatch[0]);
        }

        // SCOUT PRO FEE CALCULATION (Exact Copy)
        function calculateFees(price, weight) {
            const closingFee = 1.80;
            const referralFee = price * 0.15; // 15% for books
            
            let fulfillmentFee = 0;
            if(weight <= 0.5) fulfillmentFee = 3.07;
            else if(weight <= 1) fulfillmentFee = 3.37;
            else if(weight <= 2) fulfillmentFee = 4.16;
            else fulfillmentFee = 5.32;
            
            return closingFee + referralFee + fulfillmentFee;
        }

        // SCOUT PRO SMART SCORE (Base-50 Model)
        function calculateScore(book) {
            // 1. Calculate REAL profit using Scout Pro fees
            const fees = calculateFees(book.price, book.weight || 1.2);
            const profit = book.price - fees - CONFIG.buyCost;
            book.profit = profit;

            // 2. Start with Base 50
            let score = 50;

            // 3. HARD GATE: Profit Floor
            if (profit < CONFIG.minProfit) return 30;

            // 4. Velocity Score (180-day focus)
            if (book.drops180 > 25) score += 25;
            else if (book.drops180 > 10) score += 15;
            else if (book.drops180 > 5) score += 10;
            else if (book.drops180 === 0) score -= 30; // Drought penalty

            // 5. Competition Score
            if (book.fbaCount === 0) score += 12; // Lone Wolf
            else if (book.fbaCount <= 3) score += 8;
            else if (book.fbaCount > 10) score -= 5;

            // 6. Rank Adjustment (Books)
            if (book.rank < 100000) score += 10;
            else if (book.rank > 2000000) score -= 15;

            return Math.min(100, Math.max(0, score));
        }

        function getVerdict(book) {
            if (book.profit < CONFIG.minProfit) return 'REJECT';
            if (book.score >= 75) return 'BUY';
            if (book.score >= 50) return 'CONSIDER';
            return 'REJECT';
        }

        function updateScanStatus(status) {
            document.getElementById('scanning-status').textContent = status;
        }

        function updateScanProgress(percent) {
            document.getElementById('scan-progress-bar').style.width = percent + '%';
            document.getElementById('scan-progress-text').textContent = Math.round(percent) + '%';
        }

        function displayResults() {
            const totalBuys = scanResults.reduce((sum, r) => sum + r.books.length, 0);
            const totalProfit = scanResults.reduce((sum, r) => 
                sum + r.books.reduce((s, b) => s + b.profit, 0), 0);

            document.getElementById('total-buys').textContent = totalBuys;
            document.getElementById('total-books').textContent = scanResults.reduce((sum, r) => sum + r.books.length, 0);
            document.getElementById('total-profit').textContent = '$' + totalProfit.toFixed(0);

            const grid = document.getElementById('results-grid');
            grid.innerHTML = '';

            scanResults.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = result.books.length > 0 ? 'result-card profitable' : 'result-card skip';
                card.innerHTML = `
                    <div class="result-badge">${result.books.length > 0 ? '‚úì' : '‚úï'}</div>
                    <img src="${result.photoDataUrl}" alt="Photo ${index + 1}">
                    <div class="result-info">
                        <div class="result-count">${result.books.length} Book${result.books.length !== 1 ? 's' : ''}</div>
                        <div class="result-meta">${result.books.length > 0 ? 
                            'BUY ‚Ä¢ $' + result.books.reduce((s, b) => s + b.profit, 0).toFixed(0) + ' profit' : 
                            'SKIP'}</div>
                    </div>
                `;
                grid.appendChild(card);
            });

            showScreen('results-screen');
        }

        function newScan() {
            uploadedPhotos = [];
            scanResults = [];
            renderPhotoPreviews();
            scanBtn.disabled = true;
            showScreen('upload-screen');
        }

        loadSettings();
    </script>
</body>
</html>
