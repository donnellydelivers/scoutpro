<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ScoutPro Inventory Manager ‚Äì v5</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&family=DM+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#05060a;--panel:#121728;--card:#171c33;--border:rgba(255,255,255,.12);
  --text:#f6f7ff;--muted:#9aa3c7;--accent:#5aa9ff;--danger:#ff6b6b;--good:#00d68f;--warn:#ffd166;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:'DM Sans',sans-serif;
  background:radial-gradient(circle at top,#151932,#05060a 70%);
  color:var(--text);
}
.app{max-width:1200px;margin:0 auto;padding:16px 12px 80px}
.card{
  background:var(--panel);border-radius:18px;border:1px solid var(--border);
  padding:14px 16px;margin-bottom:14px;
}
h1{font-size:22px;margin:0 0 10px}
h1 span{font-size:12px;color:var(--muted);font-weight:400}
h3{margin:0 0 8px}
label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px}
input[type="file"],input[type="number"],input[type="text"],textarea{
  width:100%;padding:8px;border-radius:10px;border:1px solid var(--border);
  background:#050711;color:var(--text);font-size:13px;
}
textarea{font-family:monospace;font-size:12px}
.small-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:8px}
button{
  border:none;border-radius:12px;padding:8px 12px;font-size:13px;font-weight:600;cursor:pointer;
}
.btn-primary{background:var(--accent);color:#fff}
.btn-outline{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-disabled{opacity:.6;cursor:default}
.footer-note{font-size:11px;color:var(--muted);margin-top:6px}
table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px}
th,td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08)}
th{text-align:left;color:var(--muted);font-size:12px}
tr.clickable{cursor:pointer}
tr.clickable:hover{background:rgba(255,255,255,.04)}
.pill{
  display:inline-block;padding:2px 8px;border-radius:999px;
  font-size:11px;font-family:'DM Mono',monospace;
  background:rgba(255,255,255,.08);color:var(--muted);
}
.bad{color:var(--danger)} .good{color:var(--good)} .warn{color:var(--warn)}
.mono{font-family:'DM Mono',monospace;font-size:12px}
.bad-cell{background:rgba(255,107,107,.08)}
#detailWrapper{max-height:380px;overflow:auto;margin-top:8px}
.hidden{display:none}
hr{border:none;border-top:1px solid var(--border);margin:10px 0}
.toggle-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
input[type="checkbox"]{transform:scale(1.05)}
.price-up{color:var(--good);}
.price-down{color:var(--danger);}
/* NEW STYLES FOR COMPATIBILITY MESSAGE */
#amazon-compatibility-error-message {
    max-width: 800px; 
    margin: 15px auto; 
    padding: 20px; 
    border: 2px solid var(--danger);
    background-color: rgba(255, 107, 107, 0.08); /* Using danger color with low opacity */
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    line-height: 1.6;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}
#amazon-compatibility-error-message h3 {
    color: var(--text);
    margin-top: 15px;
    margin-bottom: 5px;
}
#amazon-compatibility-error-message p {
    font-size: 13px;
    margin: 8px 0;
}
.compatibility-section {
    padding: 10px;
    border-radius: 4px;
    margin-top: 15px;
}
.issue-section {
    background-color: rgba(255, 107, 107, 0.15); /* Light red for issue */
    border-left: 4px solid var(--danger);
}
.solution-section {
    background-color: rgba(0, 214, 143, 0.1); /* Light green for solution */
    border-left: 4px solid var(--good);
}
.solution-section ol {
    margin-top: 8px;
    padding-left: 20px;
    font-size: 13px;
}
</style>
</head>
<body>
<div class="app">
  <h1>
    ScoutPro Inventory Manager
    <span>Library-aware rules ‚Ä¢ Budgeted returns ‚Ä¢ Repricing with min/max & price deltas ‚Ä¢ Keepa-safe</span>
  </h1>

  <div class="card">
    <h3>1) Library Client Dictionary</h3>
    <p class="footer-note">
      Only SKUs containing one of these client codes will be treated as <b>library inventory</b>.<br>
      Format: <code>CODE,Library Name</code> (one per line, case-insensitive).
    </p>
    <textarea id="clientDict" rows="5" placeholder="DPL,Denver Public Library
NYPL,New York Public Library
UCLA,UCLA Library"></textarea>
    <div class="small-grid" style="margin-top:8px">
      <div>
        <button class="btn-primary btn-disabled" id="saveClientsBtn" disabled>Save Client List</button>
      </div>
      <div>
        <div id="clientStatus" class="footer-note">No client list saved yet.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>2) Upload Files & Global Settings</h3>
    <div class="small-grid">
      <div>
        <label for="invCsv">Inventory file (Amazon Active Listings / Pricing)</label>
        <input type="file" id="invCsv" accept=".csv,.txt,text/csv,text/plain">
      </div>
      <div>
        <label for="perCsv">Pricing Error Report (optional)</label>
        <input type="file" id="perCsv" accept=".csv,.txt,text/csv,text/plain">
      </div>
    </div>

    <div class="small-grid" style="margin-top:10px">
      <div>
        <label for="returnBudget">Monthly return budget ($)</label>
        <input type="number" id="returnBudget" min="0" step="1" value="100">
      </div>
      <div>
        <label for="removalFee">Per-unit removal fee ($)</label>
        <input type="number" id="removalFee" min="0" step="0.01" value="0.50">
      </div>
      <div>
        <label for="storageFee">Monthly storage per unit ($, est)</label>
        <input type="number" id="storageFee" min="0" step="0.01" value="0.10">
      </div>
      <div>
        <label for="roiMonths">ROI horizon (months)</label>
        <input type="number" id="roiMonths" min="1" step="1" value="6">
      </div>
    </div>

    <div class="small-grid" style="margin-top:10px">
      <div>
        <label for="keepaKey">Keepa API key (used only on Verify)</label>
        <input type="text" id="keepaKey" placeholder="Paste Keepa API key">
      </div>
      <div>
        <label for="maxKeepa">Max Keepa verifications per run</label>
        <input type="number" id="maxKeepa" min="0" step="1" value="25">
      </div>
      <div>
        <label>Keepa status</label>
        <div id="keepaStatus" class="footer-note">No key set. No Keepa calls made.</div>
      </div>
    </div>

    <div class="toggle-row" style="margin-top:10px">
      <label><input type="checkbox" id="applyDecay" checked> Apply confidence decay (age-based)</label>
      <label><input type="checkbox" id="modePricingErrors"> <span class="warn">Pricing Error Fix Mode</span></label>
    </div>

    <div id="fileStatus" class="footer-note" style="margin-top:6px;">
      ‚ùó Inventory CSV required. Upload an Amazon Active Listings / Pricing report to proceed.
    </div>
    
    <div id="amazon-compatibility-error-message" class="hidden"> 
        <h2 style="color: var(--danger); margin-top: 0; font-size: 16px;">
            ‚ö†Ô∏è File Format Error: Amazon Report Compatibility Issue
        </h2>
        <p>This is a compatibility issue between the specific file format of your Amazon report and a bug in the application's file parsing logic.</p>

        <div class="compatibility-section issue-section">
            <h3 style="color: var(--danger);">What is Happening</h3>
            
            <p><strong>The File Type:</strong> Your "Active Listings Report" from Amazon is a **tab-delimited file (TSV)**.</p>
            
            <p><strong>The Application Bug:</strong> Our core file reading logic is incorrectly hardcoded to only look for a **comma (`,`)** as the delimiter, resulting in the **"Inventory CSV required"** error.</p>
            
            <p><strong>The Result:</strong> The application fails to parse the data because it is looking for commas, but the file uses tabs.</p>
        </div>

        <div class="compatibility-section solution-section">
            <h3 style="color: var(--good);">‚úÖ Solution (Workaround)</h3>
            <p>The simplest solution is to manually convert your tab-delimited file into a **comma-separated value (CSV) file** before uploading it.</p>

            <h4>Conversion Steps:</h4>
            <ol>
                <li><strong>Open the file</strong> in a spreadsheet program (e.g., Excel, Google Sheets).</li>
                <li>Go to **File > Save As**.</li>
                <li>Select **"CSV (Comma delimited) (*.csv)"** as the file type.</li>
                <li>**Save** and then **Upload** this new <code>.csv</code> file into the Inventory Manager.</li>
            </ol>
        </div>
    </div>
    <div class="toggle-row" style="margin-top:8px">
      <button class="btn-primary btn-disabled" id="analyzeBtn" disabled>3) Run analysis (no Keepa)</button>
      <button class="btn-outline btn-disabled" id="verifyBtn" disabled>4) Verify RETURNs with Keepa</button>
      <button class="btn-outline" id="resetKeepaBtn">Reset Keepa cache</button>
    </div>
  </div>

  <div class="card">
    <h3>How min / max / target are calculated</h3>
    <p class="footer-note">
      The app builds <b>target price</b>, then <b>min</b> and <b>max</b> around it, based on confidence:
    </p>
    <ul class="footer-note">
      <li>Conf 4‚Äì5 ‚Üí Target ‚âà current, Min = 80% of target, Max = 130% of target</li>
      <li>Conf 3 ‚Üí Target ‚âà 3% below current, Min = 85% of target, Max = 120% of target</li>
      <li>Conf 1‚Äì2 ‚Üí Target ‚âà 10% below current, Min = 75% of target, Max = 105% of target</li>
      <li>Hidden Gem ‚Üí Target and Max nudged +5%</li>
      <li>If Amazon already has min/max, the app never goes below that min or above that max.</li>
    </ul>
    <p class="footer-note">
      Detail view shows: <b>Current</b> vs <b>Target</b> vs <b>Min/Max</b> and the <b>price change</b> (Œî$ and Œî%).
    </p>
  </div>

  <div class="card hidden" id="rulesCard">
    <h3>3) Per-Library Rules</h3>
    <p class="footer-note">
      Rules apply only to SKUs identified as library clients. Non-library inventory is never auto-returned, but can still be repriced.
    </p>
    <div id="rulesWrap" style="max-height:260px;overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Library</th>
            <th style="text-align:right;">Max returns / month</th>
            <th style="text-align:center;">Allow liquidation</th>
            <th style="text-align:right;">Confidence floor</th>
          </tr>
        </thead>
        <tbody id="rulesBody"></tbody>
      </table>
    </div>
    <div class="toggle-row" style="margin-top:8px">
      <button class="btn-primary" id="saveRulesBtn">Save rules</button>
      <button class="btn-outline" id="resetRulesBtn">Reset rules</button>
    </div>
  </div>

  <div class="card hidden" id="summaryCard">
    <h3>4) Global Summary & ROI Preview</h3>
    <div class="small-grid">
      <div class="footer-note">Mode: <span id="modeBadge">Standard</span></div>
      <div class="footer-note">Total items: <span id="sumTotal">0</span></div>
      <div class="footer-note">Libraries: <span id="sumLibraries">0</span></div>
      <div class="footer-note">Library items: <span id="sumLibItems">0</span></div>
      <div class="footer-note">Non-library items: <span id="sumNonLibItems">0</span></div>
      <div class="footer-note">Library Conf 1‚Äì2: <span id="sumLowConf">0</span></div>
      <div class="footer-note">Planned returns: <span id="sumReturns">0</span></div>
      <div class="footer-note">Est return cost: <span id="sumReturnCost">$0.00</span></div>
    </div>
    <hr>
    <h4>Return ROI Preview</h4>
    <div class="small-grid">
      <div class="footer-note">Return cost: <span id="roiRemovalCost">$0.00</span></div>
      <div class="footer-note">Avoided storage: <span id="roiStorageSaved">$0.00</span></div>
      <div class="footer-note">Net benefit: <span id="roiNet">$0.00</span></div>
    </div>
  </div>

  <div class="card hidden" id="clientsCard">
    <h3>5) Library Summary</h3>
    <p class="footer-note">Click a row to inspect that library‚Äôs items.</p>
    <table>
      <thead>
        <tr>
          <th>Library</th>
          <th style="text-align:right;">Items</th>
          <th style="text-align:right;">Conf 1‚Äì2</th>
          <th style="text-align:right;">Returns</th>
          <th style="text-align:right;">Return cost</th>
        </tr>
      </thead>
      <tbody id="clientsBody"></tbody>
    </table>
  </div>

  <div class="card hidden" id="detailCard">
    <div style="display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;">
      <h3 id="detailTitle">Library Detail</h3>
      <span id="detailStats" class="footer-note"></span>
    </div>
    <div id="detailWrapper">
      <table>
        <thead>
          <tr>
            <th>SKU</th>
            <th>ASIN</th>
            <th>Conf</th>
            <th>Gem</th>
            <th>Action</th>
            <th style="text-align:right;">Current</th>
            <th style="text-align:right;">Target</th>
            <th style="text-align:right;">Œî (price)</th>
            <th style="text-align:right;">Min</th>
            <th style="text-align:right;">Max</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>
      </table>
    </div>
    <div class="toggle-row" style="margin-top:8px;">
      <button class="btn-primary" id="downloadRepriceBtn">Download repricing CSV</button>
      <button class="btn-outline" id="downloadReturnsBtn">Download returns CSV</button>
      <button class="btn-outline" id="downloadClientSummariesBtn">Download client summaries CSV</button>
      <button class="btn-outline" id="downloadPricingFixesBtn">Download pricing error fixes CSV</button>
    </div>
    <p class="footer-note">
      Repricing CSV: includes <b>current_price</b>, <b>target_price</b>, <b>min_price</b>, <b>max_price</b>, and <b>price change ($ and %)</b> for each SKU.
    </p>
  </div>
</div>

<script>
(function(){
  /* ============== STATE ============== */
  let clientMap={};
  let invHeader=[],invRows=[],invCols={};
  let perHeader=[],perRows=[],perCols={},perLoaded=false;
  let clientBuckets={};
  let rulesMap={};
  let analysisDone=false;
  let keepaCache={}; let keepaCallsThisSession=0;

  // DOM
  const clientDictEl=document.getElementById('clientDict');
  const clientStatusEl=document.getElementById('clientStatus');
  const saveClientsBtn=document.getElementById('saveClientsBtn');

  const invCsvEl=document.getElementById('invCsv');
  const perCsvEl=document.getElementById('perCsv');
  const fileStatusEl=document.getElementById('fileStatus');
  const compatMsgEl=document.getElementById('amazon-compatibility-error-message');

  const returnBudgetEl=document.getElementById('returnBudget');
  const removalFeeEl=document.getElementById('removalFee');
  const storageFeeEl=document.getElementById('storageFee');
  const roiMonthsEl=document.getElementById('roiMonths');
  const applyDecayEl=document.getElementById('applyDecay');
  const modePricingErrorsEl=document.getElementById('modePricingErrors');

  const keepaKeyEl=document.getElementById('keepaKey');
  const maxKeepaEl=document.getElementById('maxKeepa');
  const keepaStatusEl=document.getElementById('keepaStatus');
  const analyzeBtn=document.getElementById('analyzeBtn');
  const verifyBtn=document.getElementById('verifyBtn');
  const resetKeepaBtn=document.getElementById('resetKeepaBtn');

  const rulesCard=document.getElementById('rulesCard');
  const rulesBody=document.getElementById('rulesBody');
  const saveRulesBtn=document.getElementById('saveRulesBtn');
  const resetRulesBtn=document.getElementById('resetRulesBtn');

  const summaryCard=document.getElementById('summaryCard');
  const modeBadge=document.getElementById('modeBadge');
  const sumTotalEl=document.getElementById('sumTotal');
  const sumLibrariesEl=document.getElementById('sumLibraries');
  const sumLibItemsEl=document.getElementById('sumLibItems');
  const sumNonLibItemsEl=document.getElementById('sumNonLibItems');
  const sumLowConfEl=document.getElementById('sumLowConf');
  const sumReturnsEl=document.getElementById('sumReturns');
  const sumReturnCostEl=document.getElementById('sumReturnCost');
  const roiRemovalCostEl=document.getElementById('roiRemovalCost');
  const roiStorageSavedEl=document.getElementById('roiStorageSaved');
  const roiNetEl=document.getElementById('roiNet');

  const clientsCard=document.getElementById('clientsCard');
  const clientsBody=document.getElementById('clientsBody');

  const detailCard=document.getElementById('detailCard');
  const detailTitleEl=document.getElementById('detailTitle');
  const detailStatsEl=document.getElementById('detailStats');
  const detailBody=document.getElementById('detailBody');

  const downloadRepriceBtn=document.getElementById('downloadRepriceBtn');
  const downloadReturnsBtn=document.getElementById('downloadReturnsBtn');
  const downloadClientSummariesBtn=document.getElementById('downloadClientSummariesBtn');
  const downloadPricingFixesBtn=document.getElementById('downloadPricingFixesBtn');

  /* ============== HELPERS ============== */

  function toNum(v){if(v==null)return NaN;const n=parseFloat(String(v).replace(/[^0-9.\-]/g,''));return isNaN(n)?NaN:n;}
  function fixNum(n){return isNaN(n)?0:n;}
  function money(n){return n?('$'+Number(n).toFixed(2)) : '';}
  function round2(n){return Math.round(n*100)/100;}
  function fix2(n){return Number(n||0).toFixed(2);}
  
  // Button management functions
  function lockClientsBtn(){
      saveClientsBtn.disabled = true;
      saveClientsBtn.classList.add('btn-disabled');
      saveClientsBtn.textContent = 'Save Client List';
  }
  function unlockClientsBtn(){
      saveClientsBtn.disabled = false;
      saveClientsBtn.classList.remove('btn-disabled');
      saveClientsBtn.textContent = 'Save Client List (Unsaved Changes)';
  }

  /* CLIENT DICTIONARY */

  function loadClientDict(){
    try{
      const raw=localStorage.getItem('SCOUTPRO_LIB_CLIENTS')||'{}';
      clientMap=JSON.parse(raw);
    }catch(e){clientMap={};}
    clientDictEl.value=Object.entries(clientMap)
      .map(([code,name])=>`${code.toUpperCase()},${name}`).join('\n');
    updateClientStatus();
    lockClientsBtn();
  }
  
  function saveClientDict(){
    lockClientsBtn();
    clientMap={};
    const raw=clientDictEl.value.trim();
    if(raw){
      raw.split(/\r?\n/).forEach(line=>{
        const parts=line.split(',');
        if(parts.length>=2){
          const code=parts[0].trim().toLowerCase();
          const name=parts.slice(1).join(',').trim();
          if(code&&name) clientMap[code]=name;
        }
      });
    }
    localStorage.setItem('SCOUTPRO_LIB_CLIENTS',JSON.stringify(clientMap));
    updateClientStatus();
    alert('Client list saved.');
  }
  
  function updateClientStatus(){
    const count=Object.keys(clientMap).length;
    clientStatusEl.textContent = count
      ? `Loaded ${count} library client code(s).`
      : 'No library clients defined. All SKUs will be treated as Non-Library.';
  }
  function identifyClientFromSku(sku){
    const s=(sku||'').toLowerCase();
    for(const code in clientMap){
      const re=new RegExp(`(^|[-_ ])${code}($|[-_ ])`);
      if(re.test(s)) return {code, name:clientMap[code], type:'LIB'};
    }
    return {code:'NONLIB', name:'Non-Library', type:'OTHER'};
  }
  
  saveClientsBtn.addEventListener('click',saveClientDict);
  clientDictEl.addEventListener('input', unlockClientsBtn); 

  /* KEEPA STATE */

  function loadKeepaState(){
    keepaKeyEl.value=localStorage.getItem('SCOUTPRO_KEEPA_KEY')||'';
    try{
      keepaCache=JSON.parse(localStorage.getItem('SCOUTPRO_KEEPA_CACHE')||'{}')||{};
    }catch(e){keepaCache={};}
    updateKeepaStatus();
  }
  function saveKeepaCache(){
    try{localStorage.setItem('SCOUTPRO_KEEPA_CACHE',JSON.stringify(keepaCache));}catch(e){}
  }
  function updateKeepaStatus(){
    const keySet=!!keepaKeyEl.value.trim();
    const cached=Object.keys(keepaCache).length;
    keepaStatusEl.textContent=(keySet?'Key set. ':'No key set. ')+`Cached ASINs: ${cached} ¬∑ Keepa calls: ${keepaCallsThisSession}`;
  }
  keepaKeyEl.addEventListener('input',()=>{
    localStorage.setItem('SCOUTPRO_KEEPA_KEY',keepaKeyEl.value.trim());
    updateKeepaStatus();
  });
  resetKeepaBtn.addEventListener('click',()=>{
    if(!confirm('Clear Keepa cache and reset counters?')) return;
    keepaCache={}; keepaCallsThisSession=0; saveKeepaCache(); updateKeepaStatus();
  });

  /* CSV / TABLE PARSING */

  function parseCsvLine(line){ // comma-delimited with quotes
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(q && line[i+1]==='"'){cur+='"';i++;}
        else q=!q;
      }else if(ch===',' && !q){
        out.push(cur);cur='';
      }else cur+=ch;
    }
    out.push(cur);
    return out;
  }

  // auto-detect delimiter (tab vs comma)
  function parseTable(text){
    const lines=text.split(/\r?\n/);
    const nonEmpty=lines.filter(l=>l.trim().length>0);
    if(!nonEmpty.length) return {header:[],rows:[]};
    const headerLine=nonEmpty[0].replace(/^\uFEFF/,''); // strip BOM if present
    const hasTab=headerLine.indexOf('\t')!==-1;
    const hasComma=headerLine.indexOf(',')!==-1;
    const useTab = hasTab && (!hasComma || headerLine.split('\t').length>headerLine.split(',').length);

    let header,rows=[];
    if(useTab){
      header=headerLine.split('\t');
      for(let i=1;i<nonEmpty.length;i++){
        rows.push(nonEmpty[i].split('\t'));
      }
    }else{
      header=parseCsvLine(headerLine);
      for(let i=1;i<nonEmpty.length;i++){
        const row=parseCsvLine(nonEmpty[i]);
        if(row.length===1 && row[0].trim()==='') continue;
        rows.push(row);
      }
    }
    // normalize row lengths
    rows=rows.map(r=>{
      const a=r.slice();
      while(a.length<header.length) a.push('');
      return a;
    });
    return {header,rows,useTab};
  }

  function detectInvCols(){
    const low=invHeader.map(h=>h.trim().toLowerCase());
    const find=names=>{
      for(const n of names){
        const i=low.indexOf(n.toLowerCase());
        if(i!==-1) return i;
      }
      return null;
    };
    invCols.sku=find(['seller-sku','sku','seller sku']);
    invCols.asin=find(['asin1','asin','product-id']);
    invCols.price=find(['price','your-price','standard-price','listing-price','price 1']);
    invCols.minPrice=find(['minimum-seller-allowed-price','min-price','minimum-price']);
    invCols.maxPrice=find(['maximum-seller-allowed-price','max-price','maximum-price']);
    invCols.confidence=find(['confidence','scout_confidence','buybox_confidence']);
    invCols.hiddenGem=find(['hidden_gem','hidden gem','hidden-gem']);
    invCols.ageDays=find(['days-in-inventory','age','afn-age']);
  }

  function detectPerCols(){
    const low=perHeader.map(h=>h.trim().toLowerCase());
    const find=names=>{
      for(const n of names){
        const i=low.indexOf(n.toLowerCase());
        if(i!==-1) return i;
      }
      return null;
    };
    perCols.sku=find(['seller-sku','sku']);
    perCols.curr=find(['price','your-price','current-price','standard-price']);
    perCols.min=find(['minimum-seller-allowed-price','min-price','minimum-price']);
    perCols.max=find(['maximum-seller-allowed-price','max-price','maximum-price']);
    perCols.issue=find(['issue','issue-type','error-code']);
  }

  function getInv(row,key){const i=invCols[key];return i==null?'':row[i]||'';}
  function getPer(row,key){const i=perCols[key];return i==null?'':row[i]||'';}

  /* FILE STATUS */

  function updateFileStatus(wasTabDelimited = false){
    let txt='';
    if(invRows.length){
      txt+=`Inventory: ${invRows.length} row(s) loaded. Core fields: `;
      txt+=(invCols.sku!=null && invCols.price!=null)?'OK.':'MISSING (need seller-sku and price).';
      
      if (wasTabDelimited) {
          txt += ' NOTE: This file appears to be Tab-Delimited, which may cause errors during analysis.';
          compatMsgEl.classList.remove('hidden');
      } else {
          compatMsgEl.classList.add('hidden');
      }
      
    }else{
      txt+='‚ùó Inventory CSV required. Upload an Amazon Active Listings / Pricing report to proceed.';
      compatMsgEl.classList.add('hidden');
    }
    if(perRows.length){
      txt+=` Pricing Errors: ${perRows.length} row(s) loaded.`;
    }
    fileStatusEl.textContent=txt;
  }
  
  function showCompatibilityError(message) {
      fileStatusEl.textContent = '‚ùó Inventory CSV required. Upload an Amazon Active Listings / Pricing report to proceed. ' + message;
      compatMsgEl.classList.remove('hidden');
  }


  /* RULES */

  function loadRules(){
    try{rulesMap=JSON.parse(localStorage.getItem('SCOUTPRO_CLIENT_RULES')||'{}')||{};}catch(e){rulesMap={};}
  }
  function persistRules(){
    try{localStorage.setItem('SCOUTPRO_CLIENT_RULES',JSON.stringify(rulesMap));}catch(e){}
  }

  function renderRulesTable(){
    const libCodes=Object.keys(clientBuckets).filter(code=>{
      const items=clientBuckets[code]; return items && items[0] && items[0].clientType==='LIB';
    }).sort();
    rulesBody.innerHTML='';
    libCodes.forEach(code=>{
      const name=clientBuckets[code][0].clientName || code.toUpperCase();
      const key=code.toLowerCase();
      const r=rulesMap[key] || {maxReturns:50,allowLiquidation:true,confidenceFloor:2};
      rulesMap[key]=r;
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${name} <span class="pill">${code.toUpperCase()}</span></td>
        <td style="text-align:right;"><input type="number" data-client="${code}" data-field="maxReturns" value="${r.maxReturns}" min="0" step="1"></td>
        <td style="text-align:center;"><input type="checkbox" data-client="${code}" data-field="allowLiquidation" ${r.allowLiquidation?'checked':''}></td>
        <td style="text-align:right;"><input type="number" data-client="${code}" data-field="confidenceFloor" value="${r.confidenceFloor}" min="1" max="5" step="1"></td>`;
      rulesBody.appendChild(tr);
    });
    rulesCard.classList.toggle('hidden',libCodes.length===0);
  }

  saveRulesBtn.addEventListener('click',()=>{
    const inputs=rulesBody.querySelectorAll('input');
    inputs.forEach(inp=>{
      const code=(inp.getAttribute('data-client')||'').toLowerCase();
      const field=inp.getAttribute('data-field');
      if(!code||!field) return;
      const r=rulesMap[code] || (rulesMap[code]={maxReturns:50,allowLiquidation:true,confidenceFloor:2});
      if(inp.type==='checkbox') r[field]=inp.checked;
      else r[field]=Number(inp.value||0);
    });
    persistRules();
    alert('Rules saved.');
  });

  resetRulesBtn.addEventListener('click',()=>{
    rulesMap={};
    renderRulesTable();
    persistRules();
  });

  /* BUILD ITEMS */

  function buildItemsFromInv(){
    clientBuckets={};
    invRows.forEach(row=>{
      const sku=getInv(row,'sku'); if(!sku) return;
      const client=identifyClientFromSku(sku);
      const asin=getInv(row,'asin');
      const price=fixNum(toNum(getInv(row,'price')));
      const minPrice=fixNum(toNum(getInv(row,'minPrice')));
      const maxPrice=fixNum(toNum(getInv(row,'maxPrice')));

      let confidence=3;
      if(invCols.confidence!=null){
        const v=Math.round(toNum(getInv(row,'confidence'))||3);
        if(v>=1 && v<=5) confidence=v;
      }
      let hiddenGem=false;
      if(invCols.hiddenGem!=null){
        const v=(getInv(row,'hiddenGem')||'').toString().trim().toLowerCase();
        hiddenGem=(v==='yes'||v==='true'||v==='1'||v==='y'||v==='üíé');
      }
      let ageDays=null;
      if(invCols.ageDays!=null){
        const v=toNum(getInv(row,'ageDays'));
        if(!isNaN(v)) ageDays=v;
      }

      const code=client.code; const name=client.name; const type=client.type;
      const item={
        row, sku, asin,
        currentPrice:price,
        price,
        minPrice,maxPrice,
        clientCode:code,clientName:name,clientType:type,
        confidence,hiddenGem,ageDays,
        action:'HOLD',
        targetPrice:price||0,targetMin:minPrice||0,targetMax:maxPrice||0,
        delta:0,deltaPct:0,
        returnFlag:false,score:0
      };
      if(!clientBuckets[code]) clientBuckets[code]=[];
      clientBuckets[code].push(item);
    });
    renderRulesTable();
  }

  /* LOAD INVENTORY + PRICING ERROR FILES */

  invCsvEl.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      const {header,rows,useTab}=parseTable(ev.target.result);
      invHeader=header; invRows=rows;
      detectInvCols();

      if(!invRows.length){
        clientBuckets={};
        updateFileStatus(false);
        analyzeBtn.disabled=true;
        analyzeBtn.classList.add('btn-disabled');
        verifyBtn.disabled=true;
        verifyBtn.classList.add('btn-disabled');
        summaryCard.classList.add('hidden');
        clientsCard.classList.add('hidden');
        detailCard.classList.add('hidden');
        alert('No inventory rows found. Please check that this is an Amazon Active Listings / Pricing report.');
        return;
      }
      if(invCols.sku==null || invCols.price==null){
        clientBuckets={};
        const hdrPreview=invHeader.join(' | ');
        invRows=[];
        
        updateFileStatus(true);
        
        analyzeBtn.disabled=true;
        analyzeBtn.classList.add('btn-disabled');
        verifyBtn.disabled=true;
        verifyBtn.classList.add('btn-disabled');
        summaryCard.classList.add('hidden');
        clientsCard.classList.add('hidden');
        detailCard.classList.add('hidden');
        showCompatibilityError('\n\nInventory file loaded, but required columns (seller-sku and price) were not found. This is often caused by trying to upload a tab-delimited file (TSV) directly.');
        
        return;
      }

      buildItemsFromInv();
      updateFileStatus(useTab);
      analyzeBtn.disabled=false;
      analyzeBtn.classList.remove('btn-disabled');
      verifyBtn.disabled=true;
      verifyBtn.classList.add('btn-disabled');
      summaryCard.classList.add('hidden');
      clientsCard.classList.add('hidden');
      detailCard.classList.add('hidden');
    };
    r.readAsText(f);
  });

  perCsvEl.addEventListener('change',e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=ev=>{
      const {header,rows}=parseTable(ev.target.result);
      perHeader=header; perRows=rows; detectPerCols();
      perLoaded=perRows.length>0;
      updateFileStatus();
    };
    r.readAsText(f);
  });

  /* ANALYSIS (NO KEEPA) */

  analyzeBtn.addEventListener('click',async()=>{
    if(analyzeBtn.disabled) return;
    if(!invRows.length){alert('Load inventory first.');return;}

    analyzeBtn.classList.add('btn-disabled'); analyzeBtn.textContent='Analyzing‚Ä¶';

    const budget=toNum(returnBudgetEl.value)||0;
    const fee=toNum(removalFeeEl.value)||0.5;
    const applyDecay=!!applyDecayEl.checked;

    Object.values(clientBuckets).forEach(items=>{
      items.forEach(it=>{
        it.action='HOLD'; it.returnFlag=false; it.score=0;
        it.targetPrice=it.price||0;
        it.targetMin=it.minPrice||0;
        it.targetMax=it.maxPrice||0;
        it.delta=0; it.deltaPct:0;
      });
    });

    if(applyDecay){
      Object.values(clientBuckets).forEach(items=>{
        items.forEach(it=>{
          if(it.clientType!=='LIB') return;
          const age=it.ageDays||0;
          if(age>=180 && it.confidence>1) it.confidence=Math.max(1,it.confidence-2);
          else if(age>=120 && it.confidence>2) it.confidence--;
          else if(age>=90 && it.confidence>3) it.confidence--;
          else if(age>=60 && it.confidence>4) it.confidence--;
        });
      });
    }

    let allItems=[];
    Object.entries(clientBuckets).forEach(([code,items])=>{
      const key=code.toLowerCase();
      const rule = items[0].clientType==='LIB'
        ? (rulesMap[key] || {maxReturns:50,allowLiquidation:true,confidenceFloor:2})
        : {maxReturns:0,allowLiquidation:true,confidenceFloor:1};
      items.forEach(it=>{
        if(it.clientType==='LIB' && it.confidence<(rule.confidenceFloor||2)){
          it.confidence=Math.min(it.confidence,2);
        }
        computeSuggestedPricing(it,rule);
        computeReturnScore(it);
        allItems.push(it);
      });
    });

    const result=chooseReturns(allItems,budget,fee);
    updateViewsAfterAnalysis(result,fee);

    analysisDone=true;
    verifyBtn.disabled=false;
    verifyBtn.classList.remove('btn-disabled');
    analyzeBtn.classList.remove('btn-disabled'); analyzeBtn.textContent='3) Run analysis (no Keepa)';
  });

  function computeSuggestedPricing(item,rule){
    const c=item.confidence||3;
    let current=item.price||0;
    let target=current;
    let min=item.minPrice||0;
    let max=item.maxPrice||0;

    if(c>=4){
      // hold current
    }else if(c===3){
      target=current*0.97;
    }else{
      target=current*0.90;
    }

    if(c>=4){
      if(!min) min=target*0.80;
      if(!max) max=target*1.30;
      item.action='HOLD';
    }else if(c===3){
      if(!min) min=target*0.85;
      if(!max) max=target*1.20;
      item.action='HOLD';
    }else{
      if(!min) min=target*0.75;
      if(!max) max=target*1.05;
      item.action=(rule && rule.allowLiquidation!==false)?'LIQUIDATE':'HOLD';
    }

    if(item.hiddenGem){
      target*=1.05;
      max*=1.05;
    }

    if(item.minPrice) min=Math.max(min,item.minPrice);
    if(item.maxPrice && item.maxPrice>0) max=Math.min(max,item.maxPrice);

    item.targetPrice=round2(target);
    item.targetMin=round2(min);
    item.targetMax=round2(max);

    const delta=item.targetPrice-(item.currentPrice||0);
    item.delta=round2(delta);
    item.deltaPct=(item.currentPrice>0)?round2((delta/item.currentPrice)*100):0;
  }

  function computeReturnScore(item){
    let s=0; const c=item.confidence||3;
    if(c<=1) s+=30; else if(c===2) s+=20; else if(c===3) s+=10;
    const age=item.ageDays||0;
    if(age>=365) s+=25; else if(age>=180) s+=15; else if(age>=90) s+=8;
    if(item.hiddenGem) s-=15;
    if(item.price && item.price<6 && c<=2) s+=10;
    item.score=s;
  }

  function chooseReturns(allItems,budget,fee){
    const perClientCounts={}; let spent=0,total=0;
    const candidates=allItems.filter(it=>it.clientType==='LIB' && it.confidence<=2 && !it.hiddenGem).sort((a,b)=>b.score-a.score);
    for(const it of candidates){
      const code=it.clientCode; const key=code.toLowerCase();
      const rule=rulesMap[key] || {maxReturns:50};
      const used=perClientCounts[code]||0;
      if(rule.maxReturns>0 && used>=rule.maxReturns) continue;
      if(budget>0 && spent+fee>budget) break;
      it.returnFlag=true; it.action='RETURN';
      perClientCounts[code]=used+1;
      total++; spent+=fee;
    }
    return {totalReturns:total,totalReturnCost:spent,clientReturnCounts:perClientCounts};
  }

  function updateViewsAfterAnalysis(result,fee){
    modeBadge.textContent=modePricingErrorsEl.checked?'Pricing Error Fix Mode':'Standard';

    const allItemsArr=Object.values(clientBuckets).flat();
    const totalItems=allItemsArr.length;
    const libItems=allItemsArr.filter(i=>i.clientType==='LIB').length;
    const nonLibItems=totalItems-libItems;
    const libCodes=Object.keys(clientBuckets).filter(c=>clientBuckets[c][0].clientType==='LIB');
    const lowConfLib=allItemsArr.filter(i=>i.clientType==='LIB' && i.confidence<=2).length;

    sumTotalEl.textContent=totalItems;
    sumLibrariesEl.textContent=libCodes.length;
    sumLibItemsEl.textContent=libItems;
    sumNonLibItemsEl.textContent=nonLibItems;
    sumLowConfEl.textContent=lowConfLib;
    sumReturnsEl.textContent=result.totalReturns;
    sumReturnCostEl.textContent='$'+(result.totalReturnCost||0).toFixed(2);

    const returnsCount=result.totalReturns||0;
    const rmCost=returnsCount*(toNum(removalFeeEl.value)||0.5);
    const avoided=returnsCount*(toNum(storageFeeEl.value)||0.10)*(toNum(roiMonthsEl.value)||6);
    const net=avoided-rmCost;

    roiRemovalCostEl.textContent='$'+rmCost.toFixed(2);
    roiStorageSavedEl.textContent='$'+avoided.toFixed(2);
    roiNetEl.textContent=(net>=0?'+':'')+'$'+net.toFixed(2);

    summaryCard.classList.remove('hidden');

    clientsBody.innerHTML='';
    Object.entries(clientBuckets)
      .filter(([code,items])=>items[0].clientType==='LIB')
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .forEach(([code,items])=>{
        const name=items[0].clientName || code.toUpperCase();
        const total=items.length;
        const low=items.filter(i=>i.confidence<=2).length;
        const ret=items.filter(i=>i.returnFlag).length;
        const cost=ret*(fee||0);
        const tr=document.createElement('tr');
        tr.className='clickable';
        tr.innerHTML=`
          <td>${name} <span class="pill">${code.toUpperCase()}</span></td>
          <td style="text-align:right;">${total}</td>
          <td style="text-align:right;">${low?'<span class="bad">'+low+'</span>':'0'}</td>
          <td style="text-align:right;">${ret}</td>
          <td style="text-align:right;">$${cost.toFixed(2)}</td>`;
        tr.addEventListener('click',()=>showClientDetail(code));
        clientsBody.appendChild(tr);
      });
    clientsCard.classList.toggle('hidden',clientsBody.children.length===0);
    detailCard.classList.add('hidden');
  }

  function showClientDetail(code){
    const items=clientBuckets[code]||[]; if(!items.length) return;
    const name=items[0].clientName || (items[0].clientType==='LIB'?'Library '+code.toUpperCase():'Non-Library');
    detailTitleEl.textContent=`${name} (${code.toUpperCase()})`;
    detailStatsEl.textContent=`${items.length} items`;
    detailBody.innerHTML='';

    items.forEach(it=>{
      const tr=document.createElement('tr');
      if(it.returnFlag && it.clientType==='LIB') tr.classList.add('bad-cell');

      const tdSku=document.createElement('td'); tdSku.textContent=it.sku; tdSku.className='mono';
      const tdAsin=document.createElement('td'); tdAsin.textContent=it.asin; tdAsin.className='mono';

      const tdConf=document.createElement('td'); tdConf.textContent=it.confidence||''; 
      if(it.confidence<=2) tdConf.classList.add('bad'); else if(it.confidence>=4) tdConf.classList.add('good');

      const tdGem=document.createElement('td'); tdGem.textContent=it.hiddenGem?'üíé':'';
      const tdAct=document.createElement('td'); tdAct.textContent=(it.returnFlag && it.clientType==='LIB')?'RETURN':it.action;

      const tdCurr=document.createElement('td'); tdCurr.style.textAlign='right'; tdCurr.textContent=money(it.currentPrice);
      const tdTar=document.createElement('td'); tdTar.style.textAlign='right'; tdTar.textContent=money(it.targetPrice);

      const tdDelta=document.createElement('td'); tdDelta.style.textAlign='right';
      const deltaStr=(it.delta===0)?'$0.00 (0%)':`${it.delta>0?'+':'-'}$${Math.abs(it.delta).toFixed(2)} (${it.deltaPct>0?'+':'-'}${Math.abs(it.deltaPct).toFixed(1)}%)`;
      tdDelta.textContent=deltaStr;
      if(it.delta>0) tdDelta.classList.add('price-up');
      else if(it.delta<0) tdDelta.classList.add('price-down');

      const tdMin=document.createElement('td'); tdMin.style.textAlign='right'; tdMin.textContent=money(it.targetMin);
      const tdMax=document.createElement('td'); tdMax.style.textAlign='right'; tdMax.textContent=money(it.targetMax);

      [tdSku,tdAsin,tdConf,tdGem,tdAct,tdCurr,tdTar,tdDelta,tdMin,tdMax].forEach(t=>tr.appendChild(t));
      detailBody.appendChild(tr);
    });
    detailCard.classList.remove('hidden');
  }

  /* KEEP-A VERIFY (unchanged logic, now gated) */

  verifyBtn.addEventListener('click',async()=>{
    if(verifyBtn.disabled) return;
    if(!analysisDone){alert('Run analysis first.');return;}
    const key=keepaKeyEl.value.trim(); if(!key){alert('Enter Keepa API key.');return;}
    const maxKeepa=parseInt(maxKeepaEl.value||'0',10);
    const fee=toNum(removalFeeEl.value)||0.5;

    verifyBtn.classList.add('btn-disabled'); verifyBtn.textContent='Verifying‚Ä¶';
    try{
      await verifyReturnCandidates(key,maxKeepa);
      const stats=recomputeReturnStats(fee);
      updateViewsAfterAnalysis(stats,fee);
    }finally{
      verifyBtn.classList.remove('btn-disabled'); verifyBtn.textContent='4) Verify RETURNs with Keepa';
      updateKeepaStatus();
    }
  });

  async function verifyReturnCandidates(key,maxKeepa){
    const candidates=[];
    Object.values(clientBuckets).forEach(items=>{
      items.forEach(it=>{
        if(it.clientType==='LIB' && it.returnFlag && it.asin) candidates.push(it);
      });
    });
    if(!candidates.length){alert('No library items currently marked RETURN.');return;}
    const ttl=7*24*60*60*1000, now=Date.now();
    let used=0;
    for(const it of candidates){
      if(maxKeepa>0 && used>=maxKeepa) break;
      const asin=it.asin;
      const cached=keepaCache[asin];
      if(cached && (now-cached.fetchedAt)<ttl){
        applyKeepaInsight(it,cached.data);
        continue;
      }
      try{
        const url=`https://api.keepa.com/product?key=${encodeURIComponent(key)}&domain=1&asin=${encodeURIComponent(asin)}&stats=1`;
        const resp=await fetch(url); if(!resp.ok) throw new Error('HTTP '+resp.status);
        const data=await resp.json(); const product=data?.products?.[0]; if(!product) continue;
        keepaCallsThisSession++; keepaCache[asin]={data:product,fetchedAt:Date.now()}; saveKeepaCache();
        applyKeepaInsight(it,product);
        used++;
      }catch(e){
        console.warn('Keepa error',asin,e);
      }
    }
  }

  function applyKeepaInsight(item,product){
    const stats=product.stats||{};
    const drops=stats.salesRankDrops30||0;
    const bb=stats.buyBoxPrice?stats.buyBoxPrice/100:null;
    if(item.confidence<=2 && (drops>0 || bb)){
      item.confidence=Math.max(3,item.confidence+1);
      item.returnFlag=false;
      const key=item.clientCode.toLowerCase();
      const rule=rulesMap[key] || {allowLiquidation:true};
      computeSuggestedPricing(item,rule);
      item.action=(rule.allowLiquidation!==false)?'LIQUIDATE':'HOLD';
    }
  }

  function recomputeReturnStats(fee){
    let total=0,cost=0,perClient={};
    Object.entries(clientBuckets).forEach(([code,items])=>{
      if(items[0].clientType!=='LIB') return;
      const cnt=items.filter(it=>it.returnFlag).length;
      perClient[code]=cnt; total+=cnt; cost+=cnt*(fee||0);
    });
    return {totalReturns:total,totalReturnCost:cost,clientReturnCounts:perClient};
  }

  /* DOWNLOADS */

  downloadRepriceBtn.addEventListener('click',()=>{
    if(!analysisDone){alert('Run analysis first.');return;}
    const rows=[[
      'sku','client_code','client_name','client_type',
      'current_price','target_price','min_price','max_price',
      'price_change','price_change_pct',
      'action','confidence','hidden_gem'
    ]];
    Object.entries(clientBuckets).forEach(([code,items])=>{
      const name=items[0].clientName;
      const type=items[0].clientType;
      items.forEach(it=>{
        rows.push([
          it.sku,code,name,type,
          fix2(it.currentPrice),
          fix2(it.targetPrice),
          fix2(it.targetMin),
          fix2(it.targetMax),
          fix2(it.delta),
          fix2(it.deltaPct),
          (it.returnFlag && type==='LIB')?'RETURN':it.action,
          it.confidence,
          it.hiddenGem?'YES':'NO'
        ]);
      });
    });
    downloadCsv(rows,'repricing_suggestions_with_deltas.csv');
  });

  downloadReturnsBtn.addEventListener('click',()=>{
    if(!analysisDone){alert('Run analysis first.');return;}
    const rows=[['sku','library_code','library_name','reason']];
    let any=false;
    Object.entries(clientBuckets).forEach(([code,items])=>{
      if(items[0].clientType!=='LIB') return;
      const name=items[0].clientName;
      items.filter(it=>it.returnFlag).forEach(it=>{
        any=true;
        rows.push([it.sku,code,name,`Low confidence (${it.confidence}) / score ${it.score}`]);
      });
    });
    if(!any){alert('No library items currently marked RETURN.');return;}
    downloadCsv(rows,'returns_recommendations.csv');
  });

  downloadClientSummariesBtn.addEventListener('click',()=>{
    if(!analysisDone){alert('Run analysis first.');return;}
    const fee=toNum(removalFeeEl.value)||0.5;
    const rows=[[
      'client_code','client_name','client_type',
      'sku','action','confidence','hidden_gem',
      'est_return_cost'
    ]];
    Object.entries(clientBuckets).forEach(([code,items])=>{
      const name=items[0].clientName;
      const type=items[0].clientType;
      items.forEach(it=>{
        const cost=(it.returnFlag && type==='LIB')?fee:0;
        rows.push([
          code,name,type,
          it.sku,
          (it.returnFlag && type==='LIB')?'RETURN':it.action,
          it.confidence,
          it.hiddenGem?'YES':'NO',
          fix2(cost)
        ]);
      });
    });
    downloadCsv(rows,'client_summaries.csv');
  });

  downloadPricingFixesBtn.addEventListener('click',()=>{
    if(!modePricingErrorsEl.checked){alert('Enable Pricing Error Fix Mode first.');return;}
    if(!perLoaded || perRows.length===0){alert('Load Pricing Error report first.');return;}
    const invBySku=new Map();
    Object.values(clientBuckets).forEach(items=>items.forEach(it=>invBySku.set(it.sku,it)));
    const rows=[['sku','suggested_price','suggested_min','suggested_max','issue']];
    perRows.forEach(r=>{
      const sku=getPer(r,'sku'); if(!sku) return;
      const inv=invBySku.get(sku);
      const curr=toNum(getPer(r,'curr')) || (inv?inv.price:NaN);
      const min=toNum(getPer(r,'min')) || (inv?inv.minPrice:NaN);
      const max=toNum(getPer(r,'max')) || (inv?inv.maxPrice:NaN);
      let base=!isNaN(curr)?curr:(!isNaN(min)?min:(!isNaN(max)?max:15));
      let target=base;
      let sMin=target*0.85;
      let sMax=target*1.25;
      if(!isNaN(min)) sMin=Math.max(sMin,min);
      if(!isNaN(max) && max>0) sMax=Math.min(sMax,max);
      rows.push([sku,fix2(target),fix2(sMin),fix2(sMax),(getPer(r,'issue')||'').toString()]);
    });
    downloadCsv(rows,'pricing_error_fixes.csv');
  });

  function downloadCsv(rows,filename){
    const csv=rows.map(r=>r.map(c=>{
      const s=String(c==null?'':c);
      return /[",\n]/.test(s)?('"'+s.replace(/"/g,'""')+'"'):s;
    }).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();
    document.body.removeChild(a);URL.revokeObjectURL(url);
  }

  document.getElementById('modePricingErrors').addEventListener('change',()=>{
    modeBadge.textContent=modePricingErrorsEl.checked?'Pricing Error Fix Mode':'Standard';
  });

  /* INIT */

  loadClientDict();
  loadKeepaState();
  loadRules();
  updateFileStatus();
  analyzeBtn.disabled=true; analyzeBtn.classList.add('btn-disabled');
  verifyBtn.disabled=true; verifyBtn.classList.add('btn-disabled');
  lockClientsBtn();
})();
</script>
</body>
</html>