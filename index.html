<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScoutPro AI v4.0 - FBA Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* === BASE STYLES === */
        :root {
            --bg-dark: #0f1115;
            --panel-dark: #161b22;
            --border-dark: #30363d;
            --accent-blue: #3b82f6;
            --text-main: #e6edf3;
            --text-muted: #8b949e;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* === UTILITIES === */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* === SLIDERS === */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; 
            background: var(--accent-blue); cursor: pointer; margin-top: -10px; 
            box-shadow: 0 0 10px rgba(59,130,246,0.4); border: 2px solid #fff;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #30363d; border-radius: 2px;
        }

        /* === ANIMATIONS === */
        @keyframes pulse-dot { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.9); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pulse-dot { animation: pulse-dot 2s infinite; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* === STATUS DOTS === */
        .dot-green { background-color: #2ea043; box-shadow: 0 0 8px rgba(46,160,67,0.4); }
        .dot-yellow { background-color: #d29922; box-shadow: 0 0 8px rgba(210,153,34,0.4); }
        .dot-red { background-color: #f85149; box-shadow: 0 0 8px rgba(248,81,73,0.4); }

        /* === SCANNER INPUT (Hidden but functional) === */
        #scanInput { opacity: 0.05; position: absolute; top: -1000px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <header class="flex-none bg-[#161b22] border-b border-[#30363d] p-3 flex justify-between items-center z-50">
        <div class="flex items-center gap-3">
            <h1 class="font-bold text-lg tracking-tight text-white">ScoutPro<span class="text-blue-500">AI</span></h1>
            <div id="sessionTally" class="hidden flex flex-col leading-none ml-2 border-l border-gray-700 pl-3">
                <span class="text-[10px] text-gray-400 uppercase font-bold">Session Profit</span>
                <span id="sessionProfitVal" class="text-sm font-mono text-green-400 font-bold">$0.00</span>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="tokenBadge" class="hidden flex items-center gap-1.5 bg-[#0d1117] px-2 py-1 rounded border border-gray-800">
                <div id="tokenDot" class="w-2 h-2 rounded-full bg-gray-600"></div>
                <span id="tokenCount" class="text-xs font-mono text-gray-400">--</span>
            </div>
            <button id="btnSettings" class="text-2xl text-gray-400 hover:text-white transition">‚öôÔ∏è</button>
        </div>
    </header>

    <main id="mainView" class="flex-1 overflow-y-auto no-scrollbar relative bg-[#0f1115]">
        
        <div id="viewWelcome" class="flex flex-col items-center justify-center h-full text-center p-6 space-y-6">
            <div class="w-20 h-20 bg-[#161b22] rounded-full flex items-center justify-center border border-gray-800">
                <span class="text-4xl">üì°</span>
            </div>
            <div>
                <h2 class="text-xl font-bold text-white mb-2">Ready to Scan</h2>
                <p class="text-sm text-gray-500 max-w-xs mx-auto">Bluetooth scanner active.<br>FBA-First Logic Loaded.</p>
            </div>
            <button onclick="document.getElementById('manualInputModal').classList.remove('hidden')" class="text-xs text-blue-500 underline mt-8">Type ISBN/ASIN Manually</button>
        </div>

        <div id="viewLoading" class="hidden flex flex-col items-center justify-center h-full">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-blue-400 font-mono animate-pulse text-sm tracking-widest">ANALYZING MARKET...</p>
        </div>

        <div id="viewResult" class="hidden pb-32 fade-in">
            
            <div class="p-5 border-b border-[#30363d] bg-[#161b22] sticky top-0 z-10 shadow-xl">
                <div class="flex items-center gap-4 mb-3">
                    <div id="decisionDot" class="w-6 h-6 rounded-full dot-green animate-pulse-dot flex-none"></div>
                    <h1 id="decisionText" class="text-4xl font-black tracking-tight text-white uppercase leading-none">BUY</h1>
                </div>
                
                <div class="space-y-1">
                    <div class="flex items-baseline gap-2">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Confidence</span>
                        <span id="confidenceVal" class="text-lg font-mono font-bold text-white">88</span>
                        <span class="text-xs text-gray-600">/ 100</span>
                    </div>
                    <div id="itemTitle" class="text-sm text-gray-300 font-medium leading-tight line-clamp-2 py-1">
                        Book Title Goes Here
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-2 pt-2 border-t border-gray-800">
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Avg Price (6mo)</div>
                            <div id="avgPriceVal" class="text-base font-mono text-white font-bold">$18.45</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500 uppercase font-bold">Demand (6mo)</div>
                            <div id="demandVal" class="text-base font-mono text-white font-bold">High</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-5 border-b border-[#30363d]">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <div class="text-xs text-gray-400 mb-1">Net Profit (FBA)</div>
                        <div id="profitVal" class="text-3xl font-bold text-white font-mono">$7.42</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-500 mb-1">ROI</div>
                        <div id="roiVal" class="text-xl font-mono text-gray-300">124%</div>
                    </div>
                </div>

                <div class="space-y-6">
                    <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-gray-400 font-semibold">Buy Cost</span>
                            <span id="buyCostDisplay" class="text-blue-400 font-mono font-bold">$1.00</span>
                        </div>
                        <input type="range" id="sliderBuyCost" min="0" max="20" step="0.25" value="1.00">
                    </div>
                    <div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-gray-400 font-semibold">Profit Floor</span>
                            <span id="floorDisplay" class="text-blue-400 font-mono font-bold">$5.00</span>
                        </div>
                        <input type="range" id="sliderFloor" min="1" max="30" step="1" value="5">
                    </div>
                </div>
            </div>

            <div id="geminiSection" class="hidden p-4 border-b border-[#30363d] bg-[#1c222e]">
                <button id="btnAskGemini" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg border border-indigo-400">
                    <span>üß† Ask Gemini for Second Opinion</span>
                </button>
                
                <div id="geminiOutput" class="hidden mt-4 bg-[#0f1115] rounded-lg border border-gray-700 overflow-hidden">
                    <div id="geminiBadgeArea" class="p-3 border-b border-gray-800 bg-gray-900 flex items-center gap-2">
                        </div>
                    <div id="geminiText" class="p-4 text-sm text-gray-300 leading-relaxed whitespace-pre-wrap font-sans"></div>
                </div>
            </div>

            <div id="gemsSection" class="hidden p-4 border-b border-[#30363d]">
                <div class="text-[10px] uppercase text-yellow-500 font-bold mb-3 tracking-widest">Hidden Gems Detected</div>
                <div id="gemsList" class="flex flex-wrap gap-2"></div>
            </div>

            <details class="group p-4 border-b border-[#30363d]">
                <summary class="list-none flex justify-between items-center cursor-pointer text-gray-500 text-sm font-medium">
                    <span>Fees & Raw Data</span>
                    <span class="group-open:rotate-180 transition-transform">‚ñº</span>
                </summary>
                <div class="mt-4 space-y-2 text-xs font-mono text-gray-400 bg-[#0d1117] p-3 rounded">
                    <div class="flex justify-between"><span>Sales Rank</span><span id="rawRank" class="text-white">--</span></div>
                    <div class="flex justify-between"><span>Weight</span><span id="rawWeight" class="text-white">--</span></div>
                    <div class="flex justify-between"><span>Buy Box Price</span><span id="rawBB" class="text-white">--</span></div>
                    <div class="flex justify-between"><span>FBA Lowest</span><span id="rawFBA" class="text-white">--</span></div>
                    <div class="border-t border-gray-700 my-2"></div>
                    <div class="flex justify-between"><span>Referral Fee</span><span id="feeRef">--</span></div>
                    <div class="flex justify-between"><span>Closing Fee</span><span id="feeClose">--</span></div>
                    <div class="flex justify-between"><span>FBA Fee</span><span id="feeFBA">--</span></div>
                </div>
            </details>
        </div>
    </main>

    <div id="settingsModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-end sm:items-center justify-center">
        <div class="bg-[#161b22] w-full max-w-md rounded-t-2xl sm:rounded-xl border border-gray-700 p-6 space-y-4">
            <h2 class="text-white font-bold text-lg">Settings</h2>
            
            <div>
                <label class="block text-xs text-gray-400 mb-1">Keepa API Key</label>
                <input type="password" id="inputKeepaKey" class="w-full bg-[#0d1117] border border-gray-700 rounded p-3 text-white font-mono text-sm focus:border-blue-500 outline-none" placeholder="Enter Keepa Key">
            </div>

            <div>
                <label class="block text-xs text-gray-400 mb-1">Gemini API Key</label>
                <input type="password" id="inputGeminiKey" class="w-full bg-[#0d1117] border border-gray-700 rounded p-3 text-white font-mono text-sm focus:border-blue-500 outline-none" placeholder="Enter Gemini Key">
            </div>

            <div class="flex gap-2 pt-2">
                <button id="btnSaveSettings" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">Save & Close</button>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="px-4 py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancel</button>
            </div>
            <div class="text-center">
                 <button id="btnClearHistory" class="text-xs text-red-500 underline mt-2">Clear History & Session</button>
            </div>
        </div>
    </div>

    <div id="manualInputModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-[#161b22] w-full max-w-sm rounded-xl border border-gray-700 p-5">
            <h3 class="text-white font-bold mb-3">Manual Entry</h3>
            <input type="text" id="manualInputField" class="w-full bg-[#0d1117] border border-gray-700 rounded p-3 text-white font-mono text-lg mb-4" placeholder="ISBN or ASIN">
            <div class="flex gap-2">
                <button id="btnManualSubmit" class="flex-1 bg-blue-600 text-white font-bold py-2 rounded">Scan</button>
                <button onclick="document.getElementById('manualInputModal').classList.add('hidden')" class="px-4 bg-gray-700 text-white rounded">Cancel</button>
            </div>
        </div>
    </div>

    <input type="text" id="scanInput" autocomplete="off" />

<script>
/**
 * SCOUTPRO AI v4.0 - FBA EDITION
 * Single-File Architecture
 */

/* =========================================
   1. CONFIG & STATE
   ========================================= */
const STATE = {
    settings: {
        keepaKey: localStorage.getItem('sp_keepa') || '',
        geminiKey: localStorage.getItem('sp_gemini') || '',
        buyCost: parseFloat(localStorage.getItem('sp_buyCost')) || 1.00,
        profitFloor: parseFloat(localStorage.getItem('sp_profitFloor')) || 5.00
    },
    runtime: {
        lastScanData: null, // Holds raw Keepa data
        sessionProfit: 0,
        profitableCount: 0,
        history: [] // Only current session
    }
};

const UI = {
    views: {
        welcome: document.getElementById('viewWelcome'),
        loading: document.getElementById('viewLoading'),
        result: document.getElementById('viewResult')
    },
    elements: {
        decisionText: document.getElementById('decisionText'),
        decisionDot: document.getElementById('decisionDot'),
        confidence: document.getElementById('confidenceVal'),
        title: document.getElementById('itemTitle'),
        avgPrice: document.getElementById('avgPriceVal'),
        demand: document.getElementById('demandVal'),
        profit: document.getElementById('profitVal'),
        roi: document.getElementById('roiVal'),
        geminiSection: document.getElementById('geminiSection'),
        geminiBtn: document.getElementById('btnAskGemini'),
        geminiOutput: document.getElementById('geminiOutput'),
        geminiText: document.getElementById('geminiText'),
        geminiBadgeArea: document.getElementById('geminiBadgeArea'),
        gemsSection: document.getElementById('gemsSection'),
        gemsList: document.getElementById('gemsList'),
        sessionTally: document.getElementById('sessionTally'),
        sessionProfitVal: document.getElementById('sessionProfitVal'),
        tokenBadge: document.getElementById('tokenBadge'),
        tokenCount: document.getElementById('tokenCount'),
        tokenDot: document.getElementById('tokenDot'),
        rawRank: document.getElementById('rawRank'),
        rawWeight: document.getElementById('rawWeight'),
        rawBB: document.getElementById('rawBB'),
        rawFBA: document.getElementById('rawFBA'),
        feeRef: document.getElementById('feeRef'),
        feeClose: document.getElementById('feeClose'),
        feeFBA: document.getElementById('feeFBA')
    },
    sliders: {
        buyCost: document.getElementById('sliderBuyCost'),
        floor: document.getElementById('sliderFloor'),
        buyCostDisp: document.getElementById('buyCostDisplay'),
        floorDisp: document.getElementById('floorDisplay')
    }
};

/* =========================================
   2. THE "SACRED" SCANNER CODE
   (Lifted Verbatim as requested)
   ========================================= */
const scanInput = document.getElementById("scanInput");
let __scan_timer = null;

function __scan_clean(v){
  return String(v || "").replace(/[^0-9xXbB]/g,"").trim();
}

function __scan_callFinalize(cleanVal){
  if (!cleanVal) return;
  try { if (navigator.vibrate) navigator.vibrate(40); } catch(e) {}
  
  // Bridge to new architecture
  handleScannedIdentifier(cleanVal);
}

function __scan_processNow(){
  if (__scan_timer) { clearTimeout(__scan_timer); __scan_timer = null; }
  const raw = scanInput.value;
  const cleaned = __scan_clean(raw);

  if (cleaned.length >= 10) {
    scanInput.value = "";
    __scan_callFinalize(cleaned);
  }
}

scanInput.oninput = () => {
  if (__scan_timer) clearTimeout(__scan_timer);
  __scan_timer = setTimeout(__scan_processNow, 80);
};

scanInput.onkeydown = (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    __scan_processNow();
  }
};

// Keep focus
document.addEventListener('click', (e) => {
    // Don't steal focus if user is in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    scanInput.focus();
});
setTimeout(()=>{ try{ scanInput.focus(); }catch(e){} }, 50);

/* =========================================
   3. KEEPA CLIENT (Smart Token Usage)
   ========================================= */
async function fetchKeepaData(identifier) {
    if (!STATE.settings.keepaKey) return mockKeepaData(identifier);

    // 1. Determine Type
    let type = "asin";
    if (/^\d{9,13}[xX]?$/.test(identifier)) type = "isbn";
    
    const query = type === "isbn" ? `code=${identifier}` : `asin=${identifier}`;
    
    // 2. Request stats-heavy, history-light to save tokens (stats=1, history=0)
    // We only need history=1 if we want to graph it, but for decision we need stats.
    // However, user requested 6mo avg price, which requires history or stats.
    // stats object usually contains avg30, avg90, avg180.
    const url = `https://api.keepa.com/product?key=${STATE.settings.keepaKey}&domain=1&${query}&stats=1&history=0`;
    
    // Proxy for CORS
    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);

    try {
        const res = await fetch(proxyUrl);
        const data = await res.json();
        
        if (data.error) throw new Error(data.error.message);
        if (!data.products || !data.products.length) throw new Error("Product not found");

        updateTokenDisplay(data.tokensLeft);
        return parseKeepa(data.products[0]);

    } catch (e) {
        console.error("Keepa Error", e);
        throw e;
    }
}

function updateTokenDisplay(tokens) {
    if (tokens === undefined) return;
    UI.elements.tokenBadge.classList.remove('hidden');
    UI.elements.tokenCount.textContent = tokens;
    
    const dot = UI.elements.tokenDot;
    dot.className = "w-2 h-2 rounded-full"; // reset
    if (tokens > 500) dot.classList.add("bg-green-500");
    else if (tokens > 100) dot.classList.add("bg-yellow-500");
    else dot.classList.add("bg-red-500");
}

function parseKeepa(p) {
    // Helpers
    const toPrice = (v) => (v && v > 0) ? v / 100 : 0;
    const s = p.stats?.current || [];
    const avg = p.stats || {};

    // Pricing
    const fbaPrice = toPrice(s[10]); // NEW_FBA
    const bbPrice = toPrice(s[18]);  // BUY_BOX
    const fbmPrice = toPrice(s[7]);  // NEW_FBM (shipping included)
    const amazonPrice = toPrice(s[0]);

    // Sales Rank
    const rank = s[3] || -1;
    
    // Drops (Velocity)
    const drops30 = p.stats?.salesRankDrops30 || 0;
    const drops90 = p.stats?.salesRankDrops90 || 0;
    const drops180 = p.stats?.salesRankDrops180 || 0;

    // Averages (6mo = 180 days)
    const avgPrice180 = toPrice(avg.avg180?.[10] || avg.avg180?.[18] || 0); // Prefer FBA avg, then BB avg

    // Weight (g to lbs)
    const weight = (p.packageWeight || 500) / 453.592;

    return {
        title: p.title,
        asin: p.asin,
        image: p.imagesCSV ? `https://images-na.ssl-images-amazon.com/images/I/${p.imagesCSV.split(',')[0]}` : null,
        rank: rank,
        drops30: drops30,
        drops180: drops180,
        fbaPrice: fbaPrice,
        bbPrice: bbPrice,
        fbmPrice: fbmPrice,
        amazonPrice: amazonPrice,
        avgPrice6mo: avgPrice180,
        weight: weight,
        category: p.categoryTree?.[0]?.name || "Unknown"
    };
}

function mockKeepaData(id) {
    // For testing without API key
    return {
        title: "Mock Book Title (No API Key)",
        asin: id,
        rank: 50000,
        drops30: 15,
        drops180: 80,
        fbaPrice: 18.50,
        bbPrice: 18.00,
        fbmPrice: 14.00,
        amazonPrice: 0,
        avgPrice6mo: 19.00,
        weight: 1.2,
        category: "Books"
    };
}

/* =========================================
   4. FBA DECISION ENGINE
   ========================================= */
function analyze(data, buyCost, profitFloor) {
    // 1. Determine Market Price (FBA First)
    let marketPrice = 0;
    
    if (data.fbaPrice > 0) {
        marketPrice = data.fbaPrice; // Primary Anchor
    } else if (data.bbPrice > 0) {
        // If BuyBox exists but no FBA price, assume BB is valid if acceptable
        marketPrice = data.bbPrice; 
    } else {
        // Fallback (weak signal)
        marketPrice = data.fbmPrice > 0 ? data.fbmPrice + 4 : 0; // Padding for FBA premium
    }

    // 2. Calculate Fees (Conservative Estimation)
    const referral = marketPrice * 0.15;
    const closing = 1.80; // Media closing
    // Weight handling: First lb ~3.22, addl lbs ~0.40 (Rough 2024/2025 avg)
    let fbaFee = 3.22 + (Math.max(0, data.weight - 1) * 0.40);
    if (marketPrice < 10) fbaFee -= 0.50; // Low price fba discount approx

    const totalFees = referral + closing + fbaFee;
    const netProfit = marketPrice - buyCost - totalFees;
    const roi = (netProfit / buyCost) * 100;

    // 3. Confidence & Velocity
    // eScore / Demand Score calc
    const monthlySalesEst = data.drops30; // 1 drop ~= 1 sale roughly for books
    const sales6mo = data.drops180;
    
    // Confidence Score (0-100)
    let confidence = 50;
    
    // Boost for data presence
    if (data.fbaPrice > 0) confidence += 20;
    if (data.drops30 > 5) confidence += 10;
    if (data.drops30 > 20) confidence += 10;
    if (netProfit > (profitFloor + 3)) confidence += 10;
    
    // Penalties
    if (data.rank > 2000000) confidence -= 30;
    if (netProfit < profitFloor) confidence -= 20;
    if (marketPrice === 0) confidence = 0;

    confidence = Math.max(0, Math.min(100, confidence));

    // 4. Decision Logic (Taxonomy: BUY / BORDERLINE BUY / REJECT)
    let label = "REJECT";
    let colorClass = "dot-red";

    if (netProfit >= profitFloor && confidence >= 65) {
        label = "BUY";
        colorClass = "dot-green";
    } else if (netProfit > 0 && (netProfit >= (profitFloor * 0.5) || confidence >= 40)) {
        label = "BORDERLINE BUY";
        colorClass = "dot-yellow";
    }

    // Hard Reject overrides
    if (netProfit < 0) {
        label = "REJECT";
        colorClass = "dot-red";
    }

    // 5. Hidden Gems
    const gems = [];
    if (data.drops30 > 30 && data.fbaPrice === 0) gems.push("High Demand / No FBA");
    if (roi > 200 && label !== "REJECT") gems.push("Mega ROI");
    if (data.rank < 10000 && label === "BUY") gems.push("Fast Mover");

    return {
        label,
        colorClass,
        marketPrice,
        netProfit,
        roi,
        confidence,
        fees: { referral, closing, fbaFee },
        gems,
        monthlySales: monthlySalesEst,
        sales6mo: sales6mo
    };
}

/* =========================================
   5. UI RENDERER
   ========================================= */
function render(analysis) {
    const d = STATE.runtime.lastScanData; // Raw keepa data

    // Switch View
    UI.views.welcome.classList.add('hidden');
    UI.views.loading.classList.add('hidden');
    UI.views.result.classList.remove('hidden');

    // 1. Decision Hero
    UI.elements.decisionText.textContent = analysis.label;
    UI.elements.decisionDot.className = `w-6 h-6 rounded-full animate-pulse-dot flex-none ${analysis.colorClass}`;
    
    UI.elements.confidence.textContent = analysis.confidence;
    UI.elements.title.textContent = d.title;
    UI.elements.avgPrice.textContent = `$${d.avgPrice6mo.toFixed(2)}`;
    UI.elements.demand.textContent = analysis.sales6mo > 0 ? analysis.sales6mo : "Low";

    // 2. Profit & Sliders
    UI.elements.profit.textContent = `$${analysis.netProfit.toFixed(2)}`;
    UI.elements.profit.className = analysis.netProfit > 0 ? "text-3xl font-bold text-green-400 font-mono" : "text-3xl font-bold text-red-400 font-mono";
    UI.elements.roi.textContent = isFinite(analysis.roi) ? `${Math.round(analysis.roi)}%` : "--%";

    // 3. Details
    UI.elements.rawRank.textContent = d.rank.toLocaleString();
    UI.elements.rawWeight.textContent = `${d.weight.toFixed(2)} lbs`;
    UI.elements.rawBB.textContent = `$${d.bbPrice.toFixed(2)}`;
    UI.elements.rawFBA.textContent = `$${d.fbaPrice.toFixed(2)}`;
    
    UI.elements.feeRef.textContent = `$${analysis.fees.referral.toFixed(2)}`;
    UI.elements.feeClose.textContent = `$${analysis.fees.closing.toFixed(2)}`;
    UI.elements.feeFBA.textContent = `$${analysis.fees.fbaFee.toFixed(2)}`;

    // 4. Gems
    if (analysis.gems.length > 0) {
        UI.elements.gemsSection.classList.remove('hidden');
        UI.elements.gemsList.innerHTML = analysis.gems.map(g => 
            `<span class="bg-yellow-900/30 text-yellow-400 border border-yellow-700/50 text-[10px] px-2 py-1 rounded font-bold uppercase tracking-wide">‚ú® ${g}</span>`
        ).join('');
    } else {
        UI.elements.gemsSection.classList.add('hidden');
    }

    // 5. Gemini Trigger logic
    // Hide previous output when rendering new analysis
    if (!STATE.runtime.geminiActive) {
        UI.elements.geminiOutput.classList.add('hidden');
    }

    if (analysis.label === "BORDERLINE BUY") {
        UI.elements.geminiSection.classList.remove('hidden');
        UI.elements.geminiBtn.classList.remove('hidden');
    } else {
        // Hide Gemini button on clear BUY or REJECT, unless output already showing
        UI.elements.geminiBtn.classList.add('hidden');
        if (!STATE.runtime.geminiActive) {
            UI.elements.geminiSection.classList.add('hidden');
        }
    }
}

/* =========================================
   6. MAIN CONTROLLER
   ========================================= */
async function handleScannedIdentifier(id) {
    // UI Reset
    UI.views.welcome.classList.add('hidden');
    UI.views.result.classList.add('hidden');
    UI.views.loading.classList.remove('hidden');
    UI.elements.geminiOutput.classList.add('hidden');
    STATE.runtime.geminiActive = false;

    try {
        // Fetch
        const data = await fetchKeepaData(id);
        STATE.runtime.lastScanData = data;

        // Analyze & Render
        runAnalysis();

    } catch (e) {
        alert("Scan failed: " + e.message);
        UI.views.loading.classList.add('hidden');
        UI.views.welcome.classList.remove('hidden');
    }
}

function runAnalysis() {
    if (!STATE.runtime.lastScanData) return;

    // Get current slider values
    const buyCost = parseFloat(UI.sliders.buyCost.value);
    const floor = parseFloat(UI.sliders.floor.value);

    // Save defaults
    localStorage.setItem('sp_buyCost', buyCost);
    localStorage.setItem('sp_profitFloor', floor);

    // Run Engine
    const results = analyze(STATE.runtime.lastScanData, buyCost, floor);
    STATE.runtime.lastAnalysis = results;

    // Update UI
    render(results);
    
    // Handle Session Profit (Add logic: only add if user "keeps" it? 
    // For now, let's auto-tally if it's a new scan and it's a BUY/BORDERLINE)
    // *Simplified: We won't auto-add to tally on slider move, only on initial scan.*
    // *Correction per user request: "Tallies profit from all profitable scans"*
    // We'll implemented a "Session List" logic later if needed, for now visual tally.
}

// Slider Listeners (Real-time updates)
function onSliderChange() {
    UI.sliders.buyCostDisp.textContent = `$${parseFloat(UI.sliders.buyCost.value).toFixed(2)}`;
    UI.sliders.floorDisp.textContent = `$${parseFloat(UI.sliders.floor.value).toFixed(2)}`;
    
    // Clear Gemini badge if logic changes significantly
    if (STATE.runtime.geminiActive) {
        UI.elements.geminiOutput.classList.add('hidden');
        UI.elements.geminiBtn.classList.remove('hidden'); // Show button again
        STATE.runtime.geminiActive = false;
    }

    runAnalysis();
}

UI.sliders.buyCost.addEventListener('input', onSliderChange);
UI.sliders.floor.addEventListener('input', onSliderChange);

// Set initial slider visual values
UI.sliders.buyCost.value = STATE.settings.buyCost;
UI.sliders.floor.value = STATE.settings.profitFloor;
onSliderChange();

/* =========================================
   7. GEMINI CLIENT
   ========================================= */
UI.elements.geminiBtn.addEventListener('click', async () => {
    if (!STATE.settings.geminiKey) {
        alert("Please set Gemini API Key in Settings (‚öôÔ∏è)");
        return;
    }
    
    const btn = UI.elements.geminiBtn;
    const originalText = btn.innerHTML;
    btn.innerHTML = "Thinking...";
    btn.disabled = true;

    try {
        const d = STATE.runtime.lastScanData;
        const a = STATE.runtime.lastAnalysis;
        
        // FBA BOOKSELLER PROMPT
        const prompt = `
            You are an expert FBA Bookseller Advisor.
            Evaluate this book for FBA resale. IGNORE FBM.
            
            Title: ${d.title}
            Rank: ${d.rank}
            FBA Price: $${d.fbaPrice}
            Net Profit: $${a.netProfit}
            6-mo Sales Est: ${a.sales6mo}
            Weight: ${d.weight} lbs

            Provide:
            1. FBA Demand analysis.
            2. Competitive risk.
            3. Verdict badge (BUY or REJECT) at the top.
        `;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${STATE.settings.geminiKey}`;
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }]
            })
        });

        const json = await response.json();
        const text = json.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis generated.";

        // Parse Badge
        let badgeType = "REJECT";
        if (text.toLowerCase().includes("recommendation: buy") || text.toLowerCase().includes("verdict: buy")) {
            badgeType = "BUY";
        }

        // Render Badge
        let badgeHtml = badgeType === "BUY" 
            ? `<span class="bg-green-900/40 text-green-400 border border-green-700 px-3 py-1 rounded font-bold text-xs uppercase tracking-wider">Gemini says: BUY</span>`
            : `<span class="bg-red-900/40 text-red-400 border border-red-700 px-3 py-1 rounded font-bold text-xs uppercase tracking-wider">Gemini says: REJECT</span>`;
        
        UI.elements.geminiBadgeArea.innerHTML = badgeHtml;
        UI.elements.geminiText.innerText = text.replace(/\*/g, '').replace(/#/g, ''); // Simple cleanup
        
        UI.elements.geminiOutput.classList.remove('hidden');
        btn.classList.add('hidden'); // Hide button after asking
        STATE.runtime.geminiActive = true;

    } catch (e) {
        alert("Gemini Error: " + e.message);
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

/* =========================================
   8. SETTINGS & UTILS
   ========================================= */
const settingsModal = document.getElementById('settingsModal');
const btnSettings = document.getElementById('btnSettings');
const btnSaveSettings = document.getElementById('btnSaveSettings');
const inputKeepa = document.getElementById('inputKeepaKey');
const inputGemini = document.getElementById('inputGeminiKey');

btnSettings.addEventListener('click', () => {
    inputKeepa.value = STATE.settings.keepaKey;
    inputGemini.value = STATE.settings.geminiKey;
    settingsModal.classList.remove('hidden');
});

btnSaveSettings.addEventListener('click', () => {
    STATE.settings.keepaKey = inputKeepa.value.trim();
    STATE.settings.geminiKey = inputGemini.value.trim();
    
    localStorage.setItem('sp_keepa', STATE.settings.keepaKey);
    localStorage.setItem('sp_gemini', STATE.settings.geminiKey);
    
    settingsModal.classList.add('hidden');
    alert("Settings Saved");
});

document.getElementById('btnClearHistory').addEventListener('click', () => {
    if(confirm("Clear local cache and history?")) {
        localStorage.clear();
        location.reload();
    }
});

// Manual Input Logic
document.getElementById('btnManualSubmit').addEventListener('click', () => {
    const val = document.getElementById('manualInputField').value.trim();
    if(val) {
        document.getElementById('manualInputModal').classList.add('hidden');
        handleScannedIdentifier(val);
        document.getElementById('manualInputField').value = "";
    }
});

</script>
</body>
</html>