<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="theme-color" content="#0a0e1a" />
<link rel="manifest" href="scoutpro_manifest.json" />
<title>ScoutPro AI ‚Äî FBA Only</title>
<style>
  :root{
    --bg:#0a0e1a; --panel:#111a33; --panel2:#0e1426; --text:#e8eefc; --muted:#a8b3d6;
    --border:#243157; --blue:#3b82f6; --green:#22c55e; --yellow:#eab308; --red:#ef4444;
    });
}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  header{position:sticky;top:0;z-index:5;background:var(--panel2);border-bottom:1px solid var(--border);padding:12px}
  .toprow{display:flex;gap:10px;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
  .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--red)}
  .badge.ok .dot{background:var(--green)}
  .badge.warn .dot{background:var(--yellow)}
  .scanbox{margin-top:10px}
  input[type="text"]{width:100%;font-size:18px;padding:14px;border-radius:12px;border:1px solid var(--border);background:#141b2d;color:var(--text);outline:none}
  main{padding:14px;max-width:820px;margin:0 auto}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-bottom:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:170px}
  .label{font-size:12px;color:var(--muted);margin-bottom:4px}
  .value{font-weight:700}
  .banner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-radius:16px;border:1px solid var(--border);background:#0f172a}
  .banner strong{font-size:16px}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid var(--border);color:var(--muted)}
  .pill.strong{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#d7ffe8}
  .pill.buy{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.35);color:#e5f0ff}
  .pill.border{background:rgba(234,179,8,.12);border-color:rgba(234,179,8,.35);color:#fff7d6}
  .pill.reject{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#ffe1e1}
  .scorebig{font-size:40px;font-weight:900;line-height:1}
  .sub{font-size:12px;color:var(--muted)}
  .reasons{margin-top:10px;font-size:14px;line-height:1.45}
  .reasons .head{font-weight:900;margin-bottom:6px}
  .reasons ul{margin:0;padding-left:18px}
  .actions{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,transparent,rgba(10,14,26,.92) 30%,rgba(10,14,26,.98));}
  .actions .bar{max-width:820px;margin:0 auto;display:flex;gap:10px}
  button{flex:1;padding:12px;border-radius:14px;border:1px solid var(--border);background:#0f172a;color:var(--text);font-weight:800}
  button.primary{background:var(--blue);border-color:rgba(59,130,246,.5)}
  button.good{background:var(--green);color:#08210f;border-color:rgba(34,197,94,.5)}
  button.ghost{background:transparent}
  button:active{transform:translateY(1px)}
  .hidden{display:none !important}
  .tiny{font-size:11px;color:var(--muted)}
  .divider{height:1px;background:var(--border);margin:12px 0}
  .k{color:var(--muted);font-size:12px}
  .v{font-weight:800}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (min-width:740px){ .grid{grid-template-columns:1fr 1fr 1fr 1fr;} }
  .slider{width:100%}
  details summary{cursor:pointer;font-weight:900}
  a{color:var(--blue);text-decoration:none}
</style>
</head>
<body>

<header>
  <div class="toprow">
    <div class="brand">ScoutPro AI <span class="tiny">‚Ä¢ FBA-only</span></div>
    <div style="flex:1"></div>
    <div id="keepaBadge" class="badge warn" title="Keepa key not set (Simulated mode)">
      <span class="dot"></span><span id="keepaBadgeText">Keepa: Simulated</span>
    </div>
  </div>

  <div class="scanbox">
    <input id="scanInput" type="text" placeholder="Scan ISBN/UPC or paste ASIN (FBA-only)" autocomplete="off" inputmode="numeric" />
    <div class="tiny" style="margin-top:6px">Tip: tap once to focus, then just scan. Haptic buzz on scan.</div>
  </div>
</header>

<main>
  <div id="mainPage">
    <div class="card">
      <div class="banner" id="banner">
        <div>
          <div class="sub" id="statusText">Ready</div>
          <strong id="titleText">Scan a book to begin</strong>
        </div>
        <div style="text-align:right">
          <div class="scorebig" id="scoreText">‚Äî</div>
          <div id="verdictPill" class="pill reject">‚õî REJECT</div>
        </div>
      </div>

      <div id="processing" class="tiny" style="margin-top:10px;display:none">Processing‚Ä¶</div>

      <div id="resultCard" class="hidden" style="margin-top:12px">
        <div class="grid">
          <div><div class="k">Sell price (FBA proxy)</div><div class="v" id="sellPrice">$‚Äî</div></div>
          <div><div class="k">Est. profit</div><div class="v" id="profit">$‚Äî</div></div>
          <div><div class="k">Drops (30d)</div><div class="v" id="drops30">‚Äî</div></div>
          <div><div class="k">Avg rank</div><div class="v" id="avgRank">‚Äî</div></div>
          <div><div class="k">Keepa confidence</div><div class="v" id="keepaConfidence">‚Äî</div></div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <div class="col">
            <div class="label">Buy cost</div>
            <div class="value">$<span id="buyCostVal">1.00</span></div>
            <input id="buyCostSlider" class="slider" type="range" min="0" max="20" step="0.25" value="1.00" />
          </div>
          <div class="col">
            <div class="label">Profit floor</div>
            <div class="value">$<span id="profitFloorVal">5.00</span></div>
            <input id="profitFloorSlider" class="slider" type="range" min="0" max="30" step="0.25" value="5.00" />
          </div>
          <div class="col">
            <div class="label">Your condition (FBA)</div>
            <select id="itemConditionSelect" style="width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#141b2d;color:var(--text)">
              <option value="NEW">NEW</option>
              <option value="LIKE_NEW">USED - LIKE NEW</option>
              <option value="VERY_GOOD">USED - VERY GOOD</option>
              <option value="GOOD">USED - GOOD</option>
              <option value="ACCEPTABLE">USED - ACCEPTABLE</option>
            </select>
            <div class="tiny">Used is evaluated as Used-FBA (still Prime). FBM is competition only.</div>
          </div>
        </div>

        <div class="reasons" id="reasonsBlock">
          <div class="head">Why this scored <span id="scoreWhy">‚Äî</span></div>
          <div id="borderlineNote" class="tiny hidden" style="margin-bottom:8px">
            ‚ö†Ô∏è Borderline Buy: acceptable but riskier ‚Äî buy selectively (price pressure / BB dynamics / thin margin).
          </div>
          <ul id="reasonsList"></ul>
        </div>
      </div>
    </div>

    <div id="dupeWarning" class="card hidden" style="border-color:rgba(234,179,8,.35);background:rgba(234,179,8,.08)">
      ‚ö†Ô∏è Duplicate scan ignored.
    </div>
  </div>

  <div id="settingsPage" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:16px">Settings</div>
      <div class="tiny">Stored locally (localStorage)</div>
    </div>
    <div class="divider"></div>
    <details open>
      <summary>üîë Integrations</summary>
      <div style="margin-top:10px">
        <div class="label">Keepa API Key</div>
        <input id="keepaKey" type="text" placeholder="Enter Keepa API key" />
        <div class="tiny" style="margin-top:6px">Uses a lightweight Keepa Product call via a CORS proxy. <a href="https://keepa.com/#!api" target="_blank">Get a key</a>.</div>
      </div>

      <div style="margin-top:12px">
        <div class="label">Daily token budget (auto-protect)</div>
        <input id="dailyBudget" type="text" placeholder="e.g. 800" />
        <div class="tiny" style="margin-top:6px">When exceeded, ScoutPro stops calling Keepa and uses Estimated mode until tomorrow.</div>
      </div>
      <div style="margin-top:12px">
        <label class="tiny" style="display:flex;gap:8px;align-items:center">
          <input id="warmupToggle" type="checkbox" />
          Background warm-up cache for hot ISBNs (uses tokens)
        </label>
        <div class="tiny" style="margin-top:6px">Warms cache only when idle and within budget.</div>
      </div>

    </details>
    <button id="saveSettings" class="good" style="margin-top:12px">Save</button>
    <button id="backFromSettings" class="ghost" style="margin-top:10px">Back</button>
  </div>

  <div id="historyPage" class="card hidden">
    <div style="font-weight:900;font-size:16px">Scan History</div>
    <div class="tiny">Newest first ‚Ä¢ Tap an item to re-display</div>
    <div class="divider"></div>
    <div id="historyList"></div>
    <button id="backFromHistory" class="ghost" style="margin-top:10px">Back</button>
  </div>

  <div style="height:84px"></div>
</main>

<div class="actions">
  <div class="bar">
    <button id="settingsBtn" class="ghost">‚öôÔ∏è</button>
    <button id="historyBtn" class="ghost">History</button>
    <button id="downloadBtn" class="primary">Download</button>
    <button id="clearBtn" class="ghost">Clear</button>
  </div>
</div>

<script>
/* ==================== PWA ==================== */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./scoutpro_sw.js').catch(()=>{});
  });
}

/* ==================== STATE ==================== */
let BUY_COST = 1.00;
let PROFIT_FLOOR = 5.00;

const CONFIG = {
  keepaKey: localStorage.getItem('keepaKey') || '',
  itemCondition: localStorage.getItem('itemCondition') || 'NEW',
  dailyBudget: parseInt(localStorage.getItem('dailyBudget') || '800', 10),
  warmupEnabled: (localStorage.getItem('warmupEnabled') || 'true') === 'true'
};

const seenIdentifiers = new Set();
let scanHistory = JSON.parse(localStorage.getItem('scanHistory') || '[]');
let buyList = JSON.parse(localStorage.getItem('buyList') || '[]');
let lastScanData = null;


/* ==================== KEEPA CACHE (localStorage) ==================== */
const KEEPA_CACHE_KEY = "keepaCache_v1";
let keepaCache = (() => {
  try { return JSON.parse(localStorage.getItem(KEEPA_CACHE_KEY) || "{}"); } catch(e) { return {}; }
})();

function cacheGet(id) {
  const rec = keepaCache[id];
  if (!rec) return null;
  if (Date.now() - rec.ts > 7*24*60*60*1000) return null; // 7-day TTL
  return rec.data;
}

function cacheSet(id, data) {
  keepaCache[id] = { ts: Date.now(), data };
  const keys = Object.keys(keepaCache);
  if (keys.length > 500) {
    keys.sort((a,b)=>keepaCache[a].ts - keepaCache[b].ts);
    for (let i=0;i<keys.length-500;i++) delete keepaCache[keys[i]];
  }
  try { localStorage.setItem(KEEPA_CACHE_KEY, JSON.stringify(keepaCache)); } catch(e) {}
}

/* ==================== DOM ==================== */
const scanInput = document.getElementById("scanInput");
const statusText = document.getElementById("statusText");
const titleText = document.getElementById("titleText");
const processing = document.getElementById("processing");
const resultCard = document.getElementById("resultCard");
const verdictPill = document.getElementById("verdictPill");
const scoreText = document.getElementById("scoreText");

/* ==================== SCANNER (LOCKED, KNOWN-GOOD) ==================== */
let __scanBuffer = '';
let __scanTimer = null;

function onScanComplete(code) {
  try { if (navigator.vibrate) navigator.vibrate(40); } catch(e) {}
  finalizeScanWithValue(code);
}

scanInput.addEventListener('keydown', (e) => {
  if (__scanTimer) clearTimeout(__scanTimer);

  if (e.key === 'Enter') {
    e.preventDefault();
    if (__scanBuffer.length >= 10) onScanComplete(__scanBuffer);
    __scanBuffer = '';
    scanInput.value = '';
    return;
  }

  if (e.key.length === 1) {
    __scanBuffer += e.key;
    __scanTimer = setTimeout(() => {
      if (__scanBuffer.length >= 10) onScanComplete(__scanBuffer);
      __scanBuffer = '';
      scanInput.value = '';
    }, 50);
  }
});

document.body.addEventListener('click', (e) => {
  const t = e.target;
  if (t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.tagName === 'SELECT' || t.tagName === 'BUTTON')) return;
  try { scanInput.focus(); } catch(_) {}
});
setTimeout(()=>{ try{ scanInput.focus(); }catch(e){} }, 80);

/* ==================== UI NAV ==================== */
function showPage(page){
  document.getElementById("mainPage").classList.toggle("hidden", page !== "main");
  document.getElementById("settingsPage").classList.toggle("hidden", page !== "settings");
  document.getElementById("historyPage").classList.toggle("hidden", page !== "history");
  try { scanInput.focus(); } catch(_) {}
}

document.getElementById("settingsBtn").onclick = () => {
  document.getElementById("keepaKey").value = CONFIG.keepaKey;
  document.getElementById("dailyBudget").value = String(CONFIG.dailyBudget || 800);
  document.getElementById("warmupToggle").checked = !!CONFIG.warmupEnabled;
  showPage("settings");
};
document.getElementById("historyBtn").onclick = () => { renderHistory(); showPage("history"); };
document.getElementById("backFromSettings").onclick = () => showPage("main");
document.getElementById("backFromHistory").onclick = () => showPage("main");

document.getElementById("saveSettings").onclick = () => {
  CONFIG.keepaKey = document.getElementById("keepaKey").value.trim();
  CONFIG.dailyBudget = Math.max(0, parseInt(document.getElementById("dailyBudget").value || "800", 10) || 0);
  CONFIG.warmupEnabled = !!document.getElementById("warmupToggle").checked;
  localStorage.setItem("keepaKey", CONFIG.keepaKey);
  localStorage.setItem("dailyBudget", String(CONFIG.dailyBudget));
  localStorage.setItem("warmupEnabled", String(CONFIG.warmupEnabled));
  updateKeepaIndicator();
try{ renderKeepaHealth(); }catch(e){}
  try { renderKeepaHealth(); } catch(e) {}
  alert("‚úÖ Settings saved!");
  showPage("main");
};

/* ==================== SLIDERS ==================== */
const bcSlider = document.getElementById("buyCostSlider");
const pfSlider = document.getElementById("profitFloorSlider");

function scheduleReanalysisAfterAdjust() {
  window.clearTimeout(scheduleReanalysisAfterAdjust._t);
  scheduleReanalysisAfterAdjust._t = window.setTimeout(()=>{
    if (lastScanData) reanalyzeWithNewThresholds();
  }, 140);
}

bcSlider.oninput = () => {
  BUY_COST = parseFloat(bcSlider.value);
  document.getElementById("buyCostVal").textContent = BUY_COST.toFixed(2);
};
bcSlider.onchange = scheduleReanalysisAfterAdjust;
bcSlider.onpointerup = scheduleReanalysisAfterAdjust;

pfSlider.oninput = () => {
  PROFIT_FLOOR = parseFloat(pfSlider.value);
  document.getElementById("profitFloorVal").textContent = PROFIT_FLOOR.toFixed(2);
};
pfSlider.onchange = scheduleReanalysisAfterAdjust;
pfSlider.onpointerup = scheduleReanalysisAfterAdjust;

/* ==================== CONDITION ==================== */
const condSelect = document.getElementById("itemConditionSelect");
condSelect.value = CONFIG.itemCondition;
condSelect.onchange = (e) => {
  CONFIG.itemCondition = e.target.value;
  localStorage.setItem("itemCondition", CONFIG.itemCondition);
  if (lastScanData) reanalyzeWithNewThresholds();
};
function getItemType(){ return (CONFIG.itemCondition === "NEW") ? "NEW" : "USED"; }

/* ==================== KEEP A INDICATOR ==================== */
function updateKeepaIndicator() {
  const b = document.getElementById("keepaBadge");
  const t = document.getElementById("keepaBadgeText");
  if (CONFIG.keepaKey) {
    b.classList.remove("warn"); b.classList.add("ok");
    b.title = "Keepa key set (Live)";
    t.textContent = "Keepa: Live";
  } else {
    b.classList.remove("ok"); b.classList.add("warn");
    b.title = "Keepa key not set (Simulated)";
    t.textContent = "Keepa: Simulated";
  }
}
updateKeepaIndicator();
try{ renderKeepaHealth(); }catch(e){}

/* ==================== INPUT DETECTION ==================== */
function detectInputType(input) {
  const cleaned = input.replace(/[^0-9X]/gi, '');
  if (cleaned.length === 10 || cleaned.length === 13) return cleaned;
  if (cleaned.length >= 12 && cleaned.length <= 14) return cleaned;
  if (/^B[0-9A-Z]{9}$/i.test(input)) return input.toUpperCase();
  return input;
}

/* ==================== DUPLICATE CHECK (non-mutating) ==================== */
function checkDuplicate(identifier) {
  if (seenIdentifiers.has(identifier)) {
    const w = document.getElementById("dupeWarning");
    w.classList.remove("hidden");
    setTimeout(()=>w.classList.add("hidden"), 1500);
    return true;
  }
  return false;
}


/* ==================== KEEPA THROTTLING + HEALTH ==================== */
const KEEPA = {
  queue: [],
  busy: false,
  lastCall: 0,
  spacingMs: 3100, // ~1 call per 3s for 20 TPM plan
  tokensThisMinute: 0,
  minuteStart: Date.now(),
  health: "SIMULATED" // LIVE | THROTTLED | SIMULATED
};

function dayKey() {
  const d = new Date();
  return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
}
const KEEPA_DAILY_KEY = "keepaTokensDaily_v1";
let keepaDaily = (() => {
  try { return JSON.parse(localStorage.getItem(KEEPA_DAILY_KEY) || "{}"); } catch(e) { return {}; }
})();
function getTokensToday() {
  const k = dayKey();
  if (!keepaDaily[k]) keepaDaily[k] = 0;
  return keepaDaily[k];
}
function addTokensToday(t) {
  const k = dayKey();
  if (!keepaDaily[k]) keepaDaily[k] = 0;
  keepaDaily[k] += t;
  const keys = Object.keys(keepaDaily).sort();
  if (keys.length > 10) for (let i=0;i<keys.length-10;i++) delete keepaDaily[keys[i]];
  try { localStorage.setItem(KEEPA_DAILY_KEY, JSON.stringify(keepaDaily)); } catch(e) {}
}
function budgetRemaining() {
  return Math.max(0, (CONFIG.dailyBudget || 0) - getTokensToday());
}


function estimateTokens(params={stats:true, history:false}) {
  let t = 1;
  if (params.stats) t += 1;
  if (params.history) t += 1;
  return t;
}

function updateTokenWindow(tokens) {
  const now = Date.now();
  if (now - KEEPA.minuteStart > 60000) {
    KEEPA.minuteStart = now;
    KEEPA.tokensThisMinute = 0;
  }
  KEEPA.tokensThisMinute += tokens;
  addTokensToday(tokens);
  renderKeepaHealth();
}

function renderKeepaHealth() {
  const badge = document.getElementById("keepaBadge");
  const txt = document.getElementById("keepaBadgeText");
  if (!CONFIG.keepaKey) {
    KEEPA.health = "SIMULATED";
    badge.className = "badge warn";
    txt.textContent = "Keepa: Simulated";
    return;
  }
  if (KEEPA.health === "THROTTLED") {
    badge.className = "badge warn";
    txt.textContent = `Keepa: Throttled (${KEEPA.tokensThisMinute}/20, ${budgetRemaining()}/${CONFIG.dailyBudget} day)`;
  } else {
    badge.className = "badge ok";
    txt.textContent = `Keepa: Live (${KEEPA.tokensThisMinute}/20, ${budgetRemaining()}/${CONFIG.dailyBudget} day)`;
  }
}

async function enqueueKeepa(task) {
  return new Promise((resolve) => {
    KEEPA.queue.push({ task, resolve });
    processKeepaQueue();
  });
}

async function processKeepaQueue() {
  if (KEEPA.busy || !KEEPA.queue.length) return;
  const now = Date.now();
  const wait = Math.max(0, KEEPA.spacingMs - (now - KEEPA.lastCall));
  if (wait > 0) {
    KEEPA.health = "THROTTLED";
    setTimeout(processKeepaQueue, wait);
    return;
  }
  KEEPA.busy = true;
  const { task, resolve } = KEEPA.queue.shift();
  KEEPA.lastCall = Date.now();
  try {
    const result = await task();
    KEEPA.health = "LIVE";
    resolve(result);
  } catch (e) {
    KEEPA.health = "THROTTLED";
    resolve({ _fallback: true, error: e });
  } finally {
    KEEPA.busy = false;
    setTimeout(processKeepaQueue, KEEPA.spacingMs);
  }
}


/* ==================== KEEPA API ==================== */
async function queryKeepa(identifier, rawInput) {
  return enqueueKeepa(async () => {
  if (!CONFIG.keepaKey) return getMockKeepaData(identifier, rawInput);

  const domain = 1;
  let queryParam = '';
  const isNumeric = /^[0-9X]+$/i.test(identifier);

  if (isNumeric) queryParam = `code=${encodeURIComponent(identifier)}`;
  else if (/^B[0-9A-Z]{9}$/i.test(identifier)) queryParam = `asin=${encodeURIComponent(identifier)}`;
  else throw new Error('Title search not implemented. Scan ISBN/UPC or enter ASIN.');

  const stats = 1;
  const history = 0;

  const keepaUrl = `https://api.keepa.com/product?key=${CONFIG.keepaKey}&domain=${domain}&${queryParam}&stats=${stats}&history=${history}`;
  const corsProxy = 'https://corsproxy.io/?';
  const url = corsProxy + encodeURIComponent(keepaUrl);

  const response = await fetch(url);
  if (!response.ok) {
    if (response.status === 429) throw new Error('Rate limit reached. Please wait a moment.');
    throw new Error(`Keepa API error: ${response.status}`);
  }
  const data = await response.json();
  if (!data.products || data.products.length === 0) return Object.assign(getMockKeepaData(identifier, rawInput), {_simulated:true, _reason:'NO_MATCH'});
  updateTokenWindow(estimateTokens({stats:true, history:false}));
    return parseKeepaProduct(data.products[0]);
}

/* ==================== PARSE KEEPA PRODUCT ==================== */
function parseKeepaProduct(product) {
  const toDollars = (v) => (v === -1 || v == null) ? 0 : (v / 100);
  const toCount = (v) => (v === -1 || v == null) ? 0 : v;

  const cur = product.stats && Array.isArray(product.stats.current) ? product.stats.current : null;
  const pAmazon = cur ? toDollars(cur[0]) : 0;
  const pNew = cur ? toDollars(cur[1]) : 0;
  const pUsed = cur ? toDollars(cur[2]) : 0;
  const pFBMShip = cur ? toDollars(cur[7]) : 0;
  const pFBA = cur ? toDollars(cur[10]) : 0;
  const pBuyBox = cur ? toDollars(cur[18]) : 0;

  const salesRank = cur ? toCount(cur[3]) : 999999;
  const countNew = cur ? toCount(cur[11]) : 0;
  const countUsed = cur ? toCount(cur[12]) : 0;

  const drops30 = (product.stats && (product.stats.salesRankDrops30 ?? 0)) || 0;
  const drops90 = (product.stats && (product.stats.salesRankDrops90 ?? 0)) || 0;
  const avg90 = (product.stats && (product.stats.avg90 ?? 0)) || 0;

  let buyBoxWinner = "NONE";
  if (pBuyBox > 0 && pAmazon > 0 && Math.abs(pBuyBox - pAmazon) <= Math.max(0.75, pBuyBox*0.03)) buyBoxWinner = "AMAZON";
  else if (pBuyBox > 0 && pFBA > 0 && Math.abs(pBuyBox - pFBA) <= Math.max(0.75, pBuyBox*0.05)) buyBoxWinner = "FBA";
  else if (pBuyBox > 0) buyBoxWinner = "FBM";

  const competitiveFBA = pFBA > 0 ? pFBA : 0;
  const competitiveFBM = pFBMShip > 0 ? pFBMShip : (pNew > 0 ? pNew : 0);
  let sellPrice = 0;

  if (getItemType() === "USED") {
    sellPrice = pUsed > 0 ? pUsed : (pBuyBox > 0 ? pBuyBox : (competitiveFBA || competitiveFBM || pAmazon));
  } else {
    sellPrice = (competitiveFBA || (pBuyBox > 0 ? pBuyBox : 0) || competitiveFBM || pNew || pAmazon);
  }

  return {
    asin: product.asin || "",
    title: product.title || "Unknown title",
    salesRank: salesRank || 999999,
    avgRank: avg90 || salesRank || 999999,
    drops30: drops30 || 0,
    drops90: drops90 || 0,
    priceAmazon: pAmazon,
    priceNew: pNew,
    priceUsed: pUsed,
    priceFBMShip: pFBMShip,
    priceFBA: pFBA,
    priceBuyBox: pBuyBox,
    buyBoxWinner,
    offerCountFBA: Math.max(0, Math.min(20, countNew)),
    offerCountFBM: Math.max(0, countNew),
    countNew, countUsed,
    sellPrice
  };
}

/* ==================== MOCK KEEPA ==================== */
function getMockKeepaData(identifier, rawInput) {
  const seed = (String(identifier).split("").reduce((a,c)=>a+c.charCodeAt(0),0) % 1000);
  const sell = 14 + (seed % 120)/10;
  const drops30 = Math.max(0, (seed % 34) - 2);
  const drops90 = drops30*3 + (seed % 9);
  const rank = 120000 + (seed*820) % 1200000;

  return {
    asin: /^B[0-9A-Z]{9}$/i.test(identifier) ? identifier : ("B" + String(seed).padStart(9,"0")).slice(0,10),
    title: "Simulated ‚Äî No Keepa key set",
    salesRank: rank,
    avgRank: rank,
    drops30, drops90,
    priceAmazon: 0,
    priceNew: sell + 2.5,
    priceUsed: sell - 2.0,
    priceFBMShip: sell - 1.0,
    priceFBA: sell,
    priceBuyBox: sell,
    buyBoxWinner: (seed%7===0) ? "AMAZON" : ((seed%3===0) ? "FBM" : "FBA"),
    offerCountFBA: 3 + (seed%8),
    offerCountFBM: 4 + (seed%10),
    countNew: 5 + (seed%12),
    countUsed: 2 + (seed%10),
    sellPrice: sell
  };
}

/* ==================== PRICING ==================== */
function estimateFbaFees(price) {
  const referral = price * 0.15;
  const fulfillment = 4.30;
  const closing = 1.80;
  return referral + fulfillment + closing;
}
function computeProfit(sellPrice) {
  const fees = estimateFbaFees(sellPrice);
  const profit = Math.max(-999, sellPrice - fees - BUY_COST);
  return { fees, profit };
}

/* ==================== BUY SCORE ENGINE ==================== */
function getVerdictFromScore(score) {
  if (score >= 85) return { label:"STRONG BUY", icon:"üî•", cls:"strong" };
  if (score >= 70) return { label:"BUY", icon:"‚úÖ", cls:"buy" };
  if (score >= 55) return { label:"BORDERLINE BUY", icon:"‚ö†Ô∏è", cls:"border" };
  return { label:"REJECT", icon:"‚õî", cls:"reject" };
}
function detectBuyBoxRotation(keepa) {
  if (keepa.buyBoxWinner === "AMAZON") return "AMAZON_LOCK";
  if (keepa.buyBoxWinner === "FBM" && keepa.offerCountFBA <= 3) return "ROTATING";
  if (keepa.buyBoxWinner === "FBA" && keepa.offerCountFBA > 5) return "STABLE";
  return "UNKNOWN";
}
function amazonPenalty(keepa, profit, floor) {
  if (keepa.buyBoxWinner !== "AMAZON") return { penalty: 0, reason: null };
  if (profit >= floor * 2) return { penalty: -5, reason: "‚ö†Ô∏è Amazon owns Buy Box but margin provides cushion" };
  return { penalty: -20, reason: "‚õî Amazon controls Buy Box ‚Äî insufficient margin" };
}
function usedConditionMultiplier(cond) {
  switch (cond) {
    case "LIKE_NEW": return 1.10;
    case "VERY_GOOD": return 1.05;
    case "GOOD": return 1.00;
    case "ACCEPTABLE": return 0.90;
    default: return 1.00;
  }
}
function computeBuyScore(keepa, pricing) {
  let score = 0;
  const reasons = [];
  const itemType = getItemType();
  const d30 = keepa.drops30 || 0;
  const d90 = keepa.drops90 || 0;
  const expected30 = d90 / 3 || 0.0001;
  const accelRatio = d30 / Math.max(1, expected30);

  // Velocity ‚Äî hard gate (different curves for NEW vs USED)
  if (itemType === "NEW") {
    if (d30 >= 30) { score += 32; reasons.push("üî• Strong sales velocity (30+ / 30d)"); }
    else if (d30 >= 20) { score += 26; reasons.push("‚úÖ Healthy monthly sales volume"); }
    else if (d30 >= 10) { score += 18; reasons.push("‚úÖ Consistent ongoing demand"); }
    else if (d30 >= 5)  { score += 10; reasons.push("‚ö†Ô∏è Slow but real sales activity"); }
    else if (d30 >= 3)  { score += 6;  reasons.push("‚ö†Ô∏è Very limited sales velocity"); }
    else {
      reasons.push("‚õî No meaningful sales activity detected");
      return { score: 39, reasons: reasons.concat("‚õî Auto-pass: Drops30 < 3"), verdict: getVerdictFromScore(39) };
    }
  } else {
    if (d30 >= 20) { score += 24; reasons.push("‚úÖ Strong used demand (20+ / 30d)"); }
    else if (d30 >= 10) { score += 18; reasons.push("‚úÖ Healthy used demand"); }
    else if (d30 >= 5)  { score += 12; reasons.push("‚ö†Ô∏è Moderate used velocity"); }
    else if (d30 >= 3)  { score += 8;  reasons.push("‚ö†Ô∏è Low but viable used velocity"); }
    else {
      reasons.push("‚õî Insufficient used velocity");
      return { score: 39, reasons: reasons.concat("‚õî Auto-pass: Drops30 < 3"), verdict: getVerdictFromScore(39) };
    }
  }

  // Acceleration (NEW weighted heavier than USED)
  if (itemType === "NEW") {
    if (accelRatio >= 1.5) { score += 15; reasons.push("üìà Sales accelerating"); }
    else if (accelRatio >= 1.1) { score += 10; reasons.push("üìà Sales improving"); }
    else if (accelRatio >= 0.9) { score += 7; reasons.push("‚ûñ Sales stable"); }
    else if (accelRatio >= 0.7) { score += 3; reasons.push("‚ö†Ô∏è Sales slowing"); }
    else reasons.push("‚õî Sales declining");
  } else {
    if (accelRatio >= 1.5) { score += 10; reasons.push("üìà Used sales accelerating"); }
    else if (accelRatio >= 1.1) { score += 7; reasons.push("üìà Used sales improving"); }
    else if (accelRatio >= 0.9) { score += 5; reasons.push("‚ûñ Used sales stable"); }
    else if (accelRatio >= 0.7) { score += 2; reasons.push("‚ö†Ô∏è Used sales slowing"); }
    else reasons.push("‚õî Used sales declining");
  }


  // Profit strength (NEW vs USED curves) ‚Äî hard gate
  let effectiveProfit = pricing.profit;
  let minRatio = 1.0;

  if (itemType === "USED") {
    if (CONFIG.itemCondition === "ACCEPTABLE") minRatio = 1.25;
    else if (CONFIG.itemCondition === "GOOD") minRatio = 1.15;
    else minRatio = 1.05;
    effectiveProfit *= usedConditionMultiplier(CONFIG.itemCondition);
  }

  const profitRatio = effectiveProfit / Math.max(0.01, PROFIT_FLOOR);

  if (profitRatio >= 2.0) { score += (itemType==="USED"?30:25); reasons.push("üí∞ Exceptional profit cushion"); }
  else if (profitRatio >= 1.5) { score += (itemType==="USED"?24:20); reasons.push("üí∞ Strong margin above target"); }
  else if (profitRatio >= 1.2) { score += (itemType==="USED"?18:15); reasons.push("‚úÖ Healthy margin"); }
  else if (profitRatio >= minRatio) { score += (itemType==="USED"?10:8); reasons.push("‚ö†Ô∏è Meets minimum profit"); }
  else {
    reasons.push("‚õî Profit below minimum target");
    return { score: 39, reasons: reasons.concat("‚õî Auto-pass: Below profit floor"), verdict: getVerdictFromScore(39) };
  }

  if (keepa.priceFBA > 0 && keepa.priceBuyBox > 0) { score += 10; reasons.push("üì¶ Clear FBA + Buy Box price signal"); }
  else if (keepa.priceFBA > 0) { score += 7; reasons.push("üì¶ Reliable FBA pricing"); }
  else if (keepa.priceFBMShip > 0) { score += 2; reasons.push("‚ö†Ô∏è Only FBM pricing available (competition pressure)"); }
  else return { score: 39, reasons: reasons.concat("‚õî Auto-pass: No price signal"), verdict: getVerdictFromScore(39) };

  const fbaCount = keepa.offerCountFBA || 0;
  if (fbaCount <= 2) { score += 10; reasons.push("üèÜ Very low FBA competition"); }
  else if (fbaCount <= 5) { score += 7; reasons.push("‚úÖ Manageable FBA competition"); }
  else if (fbaCount <= 10) { score += 4; reasons.push("‚ö†Ô∏è Crowded FBA listing"); }
  else reasons.push("‚õî Highly competitive listing");

  // Rank context (NEW weighted heavier than USED)
  const r = keepa.avgRank || keepa.salesRank || 999999;
  if (itemType === "NEW") {
    if (r < 200000) { score += 10; reasons.push("üìä Strong historical demand"); }
    else if (r < 500000) { score += 7; reasons.push("üìä Healthy long-tail demand"); }
    else if (r < 1000000) { score += 4; reasons.push("‚ö†Ô∏è Moderate historical demand"); }
    else reasons.push("‚ö†Ô∏è Weak historical demand");
  } else {
    if (r < 200000) { score += 6; reasons.push("üìä Strong used demand history"); }
    else if (r < 500000) { score += 4; reasons.push("üìä Solid used demand history"); }
    else if (r < 1000000) { score += 2; reasons.push("‚ö†Ô∏è Moderate used demand history"); }
    else reasons.push("‚ö†Ô∏è Weak used demand history");
  }

const rotation = detectBuyBoxRotation(keepa);
  if (itemType === "NEW") {
    if (keepa.buyBoxWinner === "FBA") { score += 10; reasons.push("üì¶ FBA sellers control Buy Box ‚Äî Prime advantage confirmed"); }
    else if (keepa.buyBoxWinner === "FBM") { score -= 3; reasons.push("‚ö†Ô∏è FBM controls Buy Box ‚Äî price pressure risk"); }
    else if (keepa.buyBoxWinner === "AMAZON") {
      const a = amazonPenalty(keepa, pricing.profit, PROFIT_FLOOR);
      score += a.penalty; if (a.reason) reasons.push(a.reason);
    } else { score -= 8; reasons.push("‚ö†Ô∏è No stable Buy Box"); }
  } else {
    if (keepa.buyBoxWinner === "FBA") { score += 8; reasons.push("üì¶ FBA Buy Box ‚Äî Prime preferred for used"); }
    else if (keepa.buyBoxWinner === "FBM") { score -= 2; reasons.push("‚ö†Ô∏è FBM used sellers may cap price"); }
    else { score -= 6; reasons.push("‚ö†Ô∏è No stable Buy Box for used FBA"); }
  }
  if (rotation === "ROTATING") { score += (itemType === "USED" ? 4 : 2); reasons.push("üîÑ Buy Box rotation detected"); }
  if (rotation === "AMAZON_LOCK") { score -= 6; reasons.push("‚õî Buy Box suppressed by Amazon"); }

  score = Math.max(0, Math.min(100, Math.round(score)));
  let verdict = getVerdictFromScore(score);
  if (keepa.buyBoxWinner === "AMAZON" && verdict.label === "STRONG BUY") {
    verdict = { label:"BUY", icon:"‚ö†Ô∏è", cls:"buy" };
    reasons.push("‚ö†Ô∏è Verdict capped: Amazon owns Buy Box");
  }
  if (getItemType() === "USED" && CONFIG.itemCondition === "ACCEPTABLE" && verdict.label === "STRONG BUY") {
    verdict = { label:"BUY", icon:"‚ö†Ô∏è", cls:"buy" };
    reasons.push("‚ö†Ô∏è Verdict capped: Used condition (Acceptable)");
  }
  return { score, verdict, reasons };
}

/* ==================== CORE FLOW ==================== */
async function finalizeScanWithValue(inputCode) {
  if (!inputCode) return;

  const raw = String(inputCode).trim();
  const identifier = detectInputType(raw);
  if (checkDuplicate(identifier)) return;

  statusText.textContent = `Processing: ${identifier}`;
  titleText.textContent = "‚Ä¶";
  document.getElementById("processing").style.display = "block";
  document.getElementById("resultCard").classList.add("hidden");

  try {
    
    const keepaData = await queryKeepa(identifier, raw);
    if (keepaData && keepaData._fallback) {
      keepaData = Object.assign(getMockKeepaData(identifier, raw), { _simulated:true, _reason:'PROXY_FAIL' });
    }
    
    const pricing = computeProfit(keepaData.sellPrice || 0);
    const scored = computeBuyScore(keepaData, pricing);

    seenIdentifiers.add(identifier);
    lastScanData = { identifier, keepaData };

    
    if (keepaData._simulated) {
      scored.reasons.unshift("‚ö†Ô∏è Keepa unavailable or throttled ‚Äî estimated data used");
    }
    displayResult(scored, keepaData, pricing);
    
    addToHistory(identifier, keepaData, pricing, scored);

    statusText.textContent = keepaData.title;
    titleText.textContent = keepaData.title;
  } catch (error) {
    statusText.textContent = "Error ‚Äî try again";
    titleText.textContent = "Scan failed";
    scoreText.textContent = "‚Äî";
    setVerdictPill({label:"ERROR", icon:"‚ö†Ô∏è", cls:"reject"});
    document.getElementById("reasonsList").innerHTML = `<li>${String(error.message || error)}</li>`;
    document.getElementById("scoreWhy").textContent = "‚Äî";
    document.getElementById("borderlineNote").classList.add("hidden");
    document.getElementById("resultCard").classList.remove("hidden");
  } finally {
    document.getElementById("processing").style.display = "none";
    try { scanInput.focus(); } catch(_) {}
  }
}

function reanalyzeWithNewThresholds() {
  if (!lastScanData) return;
  const keepaData = lastScanData.keepaData;
  const pricing = computeProfit(keepaData.sellPrice || 0);
  const scored = computeBuyScore(keepaData, pricing);
  
    if (keepaData._simulated) {
      scored.reasons.unshift("‚ö†Ô∏è Keepa unavailable or throttled ‚Äî estimated data used");
    }
    displayResult(scored, keepaData, pricing);
    
}


function computeKeepaConfidence(keepaData){
  if (!CONFIG.keepaKey) return { label:"LOW", icon:"üî¥", detail:"No Keepa key" };
  if (keepaData._simulated) return { label:"LOW", icon:"üî¥", detail:(keepaData._reason || "Estimated") };
  if (keepaData._cached) return { label:"MED", icon:"üü°", detail:"Cached" };
  const strong = (keepaData.drops30||0) >= 10 && (keepaData.sellPrice||0) > 0 && (keepaData.avgRank||0) > 0;
  if (typeof KEEPA !== "undefined" && KEEPA.health === "THROTTLED") return { label:"MED", icon:"üü°", detail:"Throttled" };
  return strong ? { label:"HIGH", icon:"üü¢", detail:"Live" } : { label:"MED", icon:"üü°", detail:"Live (weak signal)" };
}

function setVerdictPill(v){
  const pill = document.getElementById("verdictPill");
  pill.className = "pill " + (v.cls || "reject");
  pill.textContent = `${v.icon || ""} ${v.label || ""}`.trim();
}

function displayResult(scored, keepaData, pricing) {
  document.getElementById("resultCard").classList.remove("hidden");

  scoreText.textContent = scored.score;
  setVerdictPill(scored.verdict || getVerdictFromScore(scored.score));

  document.getElementById("sellPrice").textContent = `$${(keepaData.sellPrice||0).toFixed(2)}`;
  document.getElementById("profit").textContent = `$${(pricing.profit||0).toFixed(2)}`;
  document.getElementById("drops30").textContent = String(keepaData.drops30||0);
  document.getElementById("avgRank").textContent = String(Math.round(keepaData.avgRank||keepaData.salesRank||0)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  const kc = computeKeepaConfidence(keepaData);
  document.getElementById("keepaConfidence").textContent = `${kc.icon} ${kc.label}`;

  document.getElementById("scoreWhy").textContent = scored.score;
  const list = document.getElementById("reasonsList");
  list.innerHTML = "";
  (scored.reasons||[]).forEach(r=>{
    const li = document.createElement("li");
    li.textContent = r;
    list.appendChild(li);
  });

  const borderline = document.getElementById("borderlineNote");
  const v = scored.verdict || getVerdictFromScore(scored.score);
  borderline.classList.toggle("hidden", v.label !== "BORDERLINE BUY");
}


/* ==================== WARM-UP CACHE (hot ISBNs) ==================== */
let warmupTimer = null;
function scheduleWarmup() {
  if (!CONFIG.warmupEnabled) return;
  if (warmupTimer) return;
  warmupTimer = setTimeout(async () => {
    warmupTimer = null;
    if (!CONFIG.keepaKey) return;
    if (budgetRemaining() <= 0) return;

    const hot = (buyList || []).slice(0, 30)
      .map(x => x.identifier)
      .filter((v, i, a) => v && a.indexOf(v) === i)
      .filter(id => !cacheGet(id))
      .slice(0, 12);

    for (const id of hot) {
      if (!CONFIG.warmupEnabled) break;
      const est = estimateTokens({stats:true, history:false});
      if (getTokensToday() + est > (CONFIG.dailyBudget || 0)) break;
      try { await queryKeepa(id, id); } catch(e) {}
    }
  }, 2500);
}

/* ==================== HISTORY + EXPORT ==================== */
function addToHistory(identifier, keepaData, pricing, scored){
  const item = {
    ts: Date.now(),
    identifier,
    asin: keepaData.asin || "",
    title: keepaData.title || "",
    itemType: getItemType(),
    condition: CONFIG.itemCondition,
    sellPrice: keepaData.sellPrice || 0,
    profit: pricing.profit || 0,
    drops30: keepaData.drops30 || 0,
    avgRank: keepaData.avgRank || keepaData.salesRank || 0,
    score: scored.score || 0,
    verdict: (scored.verdict && scored.verdict.label) ? scored.verdict.label : getVerdictFromScore(scored.score||0).label
  };
  scanHistory.unshift(item);
  scanHistory = scanHistory.slice(0, 2500);
  localStorage.setItem("scanHistory", JSON.stringify(scanHistory));

  if (item.score >= 55) {
    buyList.unshift(item);
    buyList = buyList.slice(0, 2500);
    localStorage.setItem("buyList", JSON.stringify(buyList));
  }
  try { scheduleWarmup(); } catch(e) {}
}

function renderHistory(){
  const el = document.getElementById("historyList");
  el.innerHTML = "";
  if (!scanHistory.length){
    el.innerHTML = '<div class="tiny">No scans yet.</div>';
    return;
  }
  scanHistory.slice(0,200).forEach((it)=>{
    const div = document.createElement("div");
    div.className = "card";
    div.style.marginBottom = "10px";
    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:10px">
        <div style="flex:1">
          <div style="font-weight:900">${escapeHtml(it.title || it.identifier)}</div>
          <div class="tiny">${new Date(it.ts).toLocaleString()} ‚Ä¢ ${it.itemType} ‚Ä¢ ${it.condition.replaceAll('_',' ')}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:900">${it.score}</div>
          <div class="tiny">${it.verdict}</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="tiny">Sell $${Number(it.sellPrice).toFixed(2)} ‚Ä¢ Profit $${Number(it.profit).toFixed(2)} ‚Ä¢ Drops30 ${it.drops30} ‚Ä¢ Rank ${Math.round(it.avgRank).toLocaleString()}</div>
    `;
    div.onclick = () => {
      scoreText.textContent = it.score;
      setVerdictPill(getVerdictFromScore(it.score));
      statusText.textContent = it.title || it.identifier;
      titleText.textContent = it.title || it.identifier;
      document.getElementById("sellPrice").textContent = `$${Number(it.sellPrice).toFixed(2)}`;
      document.getElementById("profit").textContent = `$${Number(it.profit).toFixed(2)}`;
      document.getElementById("drops30").textContent = String(it.drops30);
      document.getElementById("avgRank").textContent = String(Math.round(it.avgRank)).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      document.getElementById("scoreWhy").textContent = it.score;
      document.getElementById("reasonsList").innerHTML = "<li>History item (reasons not stored in this compact log)</li>";
      document.getElementById("borderlineNote").classList.toggle("hidden", it.score < 55 || it.score >= 70);
      document.getElementById("resultCard").classList.remove("hidden");
      showPage("main");
    };
    el.appendChild(div);
  });
}

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

document.getElementById("downloadBtn").onclick = () => downloadCSV();
document.getElementById("clearBtn").onclick = () => {
  if (!confirm("Clear history + buy list?")) return;
  scanHistory = []; buyList = []; lastScanData = null; seenIdentifiers.clear?.();
  localStorage.removeItem("scanHistory");
  localStorage.removeItem("buyList");
  alert("Cleared.");
};

function downloadCSV(){
  const rows = buyList.length ? buyList : scanHistory;
  if (!rows.length){ alert("No data yet."); return; }
  const header = ["ts","identifier","asin","title","itemType","condition","sellPrice","profit","drops30","avgRank","score","verdict"];
  const csv = [header.join(",")].concat(rows.map(r => header.map(k => csvCell(r[k])).join(","))).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `scoutpro_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1200);
}
function csvCell(v){
  const s = String(v ?? "");
  if (/[,"\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}
</script>

</body>
</html>