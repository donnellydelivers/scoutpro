<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Pretty Good Scouting App (Pro)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
:root {
  --bg: #050505;
  --panel: #121212;
  --card: #1e1e1e;
  --border: #2a2a2a;
  --text: #ffffff;
  --muted: #888;
  --green: #34d399; 
  --red: #f87171;
  --yellow: #fbbf24;
  --blue: #60a5fa;
  --purple: #a78bfa;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  padding-bottom: 140px;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
}

.app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

/* --- SPLASH SCREEN --- */
#splash-screen {
    position: fixed; inset: 0; z-index: 9999;
    background-color: #000;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    transition: opacity 0.8s ease-out, visibility 0.8s;
}
.splash-hidden { opacity: 0; visibility: hidden; pointer-events: none; }

.splash-bg {
    position: absolute; inset: 0; z-index: 0;
}
.splash-bg img {
    width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: blur(2px);
}

.splash-content { position: relative; z-index: 10; text-align: center; width: 100%; padding: 0 20px; }
.big-title {
    font-family: 'Inter', sans-serif; font-weight: 900; 
    text-transform: uppercase; line-height: 0.9; letter-spacing: -0.05em;
    display: flex; flex-direction: column; gap: 0;
    text-shadow: 0 4px 20px rgba(0,0,0,1);
}
.big-title span { font-size: 3.5rem; }
@media(min-width: 400px) { .big-title span { font-size: 4.5rem; } }

/* --- HEADER & SEARCH --- */
header {
  padding: 16px;
  background: transparent;
  margin-top: 60px;
  margin-bottom: 20px;
}

.search-wrapper { position: relative; }

.brand-badges {
  display: flex; gap: 6px; margin-bottom: 8px; justify-content: flex-end;
}
.badge {
  display: flex; align-items: center; gap: 4px;
  padding: 4px 10px; background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1); border-radius: 99px;
  font-size: 10px; font-weight: 700; color: var(--muted);
  transition: all 0.3s;
}
.badge.active { background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3); color: var(--blue); }
.badge.active-gem { background: rgba(167, 139, 250, 0.15); border-color: rgba(167, 139, 250, 0.3); color: var(--purple); }

.status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

.search-container { position: relative; }
.search-icon {
    position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
    color: var(--muted); font-size: 18px;
}
input[type="text"] {
  width: 100%; padding: 18px 16px 18px 48px; border-radius: 16px;
  background: #111; border: 1px solid #333;
  color: white; font-family: 'Inter', sans-serif;
  font-size: 18px; outline: none; transition: all 0.2s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}
input[type="text"]:focus {
  border-color: var(--blue);
  background: #161616;
  box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

#statusText {
  padding: 8px; color: var(--muted); font-size: 13px; 
  text-align: center; min-height: 36px;
  display: flex; align-items: center; justify-content: center;
}

/* Main Card */
.card {
  margin: 0 16px; background: var(--panel);
  border-radius: 20px; border: 1px solid var(--border);
  overflow: hidden; position: relative;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  animation: slideUp 0.4s ease-out;
}
@keyframes slideUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }

.banner { padding: 32px 24px; text-align: center; position: relative; }
.banner.buy { background: radial-gradient(circle at top, rgba(16,185,129,0.12), transparent 70%); }
.banner.reject { background: radial-gradient(circle at top, rgba(239,68,68,0.12), transparent 70%); }
.banner.maybe { background: radial-gradient(circle at top, rgba(251,191,36,0.12), transparent 70%); }
.banner.error { background: radial-gradient(circle at top, rgba(255,255,255,0.05), transparent 70%); }

.gem-icon {
  position: absolute; top: 16px; right: 16px; font-size: 20px;
  animation: float 3s ease-in-out infinite;
}
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }

/* Score */
.score-container {
  position: relative; width: 120px; height: 120px; margin: 0 auto 16px auto;
  display: flex; align-items: center; justify-content: center; flex-direction: column;
}
.score-svg {
  position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg);
}
.score-circle-bg {
  fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 8;
}
.score-circle-fg {
  fill: none; stroke: currentColor; stroke-width: 8; stroke-linecap: round;
  stroke-dasharray: 283; stroke-dashoffset: 283;
  transition: stroke-dashoffset 1s ease-out, stroke 0.3s;
}
.score-num { 
  font-size: 48px; font-weight: 800; line-height: 1; letter-spacing: -0.04em;
  font-variant-numeric: tabular-nums; z-index: 2;
}

.decision-label {
  font-size: 13px; font-weight: 800; letter-spacing: 0.05em;
  text-transform: uppercase; color: #000; background: #fff;
  display: inline-block; padding: 6px 14px; border-radius: 99px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-top: 8px;
}

.condition-toggle {
  display: flex; background: rgba(0,0,0,0.3); 
  border-radius: 99px; padding: 4px; margin: 24px auto 16px auto;
  width: fit-content; border: 1px solid var(--border);
}
.cond-btn {
  padding: 6px 16px; border-radius: 99px; font-size: 12px; font-weight: 700;
  color: var(--muted); cursor: pointer; transition: all 0.2s;
  text-transform: uppercase; letter-spacing: 0.05em;
}
.cond-btn.active {
  background: var(--blue); color: #fff; box-shadow: 0 2px 8px rgba(59,130,246,0.4);
}

.slider-container {
  background: rgba(0,0,0,0.2); border-radius: 12px;
  padding: 16px 12px; margin-bottom: 20px;
  border: 1px solid rgba(255,255,255,0.05);
}
.slider-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.slider-row:last-child { margin-bottom: 0; }
.slider-header {
  display: flex; justify-content: space-between; 
  font-size: 11px; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: 0.05em;
}
.slider-val { color: var(--blue); font-family: 'JetBrains Mono', monospace; }
input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
  background: var(--blue); cursor: pointer; margin-top: -6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}
input[type=range]::-webkit-slider-runnable-track {
  width: 100%; height: 4px; cursor: pointer; background: #333; border-radius: 2px;
}

.profit-display { margin-bottom: 12px; }
.profit-label {
  font-size: 12px; font-weight: 600; color: var(--muted); letter-spacing: 0.1em; margin-bottom: 4px; display: block;
}
.profit-val { font-size: 32px; font-weight: 600; font-family: 'JetBrains Mono', monospace; letter-spacing: -0.02em;}

.item-title {
  margin: 12px 0 8px 0; font-size: 15px; font-weight: 400;
  color: rgba(255,255,255,0.7); line-height: 1.5;
  display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}
.link-row {
  display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;
}
.ext-link {
  font-size: 11px; font-weight: 700; color: var(--muted); text-decoration: none;
  background: rgba(255,255,255,0.05); padding: 8px 16px; border-radius: 8px;
  transition: all 0.2s; border: 1px solid rgba(255,255,255,0.1); cursor: pointer;
}
.ext-link:hover { color: #fff; border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.1); }

.keepa-embed {
  margin-top: 12px;
  background: #fff;
  padding: 8px;
  border-radius: 8px;
  overflow: hidden;
}
.keepa-embed img { width: 100%; height: auto; display: block; }
.graph-legend {
  display: flex; justify-content: center; gap: 12px; margin-top: 8px;
  font-size: 10px; font-weight: 600; color: #333;
}
.dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

.details-panel {
  background: rgba(255,255,255,0.03);
  border-top: 1px solid var(--border);
}
.details-summary {
  width: 100%; padding: 16px; cursor: pointer;
  font-weight: 600; color: rgba(255,255,255,0.9);
  font-size: 14px; text-align: center; list-style: none;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.details-summary::-webkit-details-marker { display: none; }
.details-summary::after { content: '‚Ä∫'; transform: rotate(90deg); font-size: 18px; color: var(--muted); }
.details-panel[open] .details-summary::after { transform: rotate(-90deg); }
.details-body { padding: 0 20px 20px; text-align: left; }

.ai-box {
  margin-bottom: 16px; padding: 12px; border-radius: 8px;
  background: rgba(167, 139, 250, 0.1); border: 1px solid rgba(167, 139, 250, 0.3);
  font-size: 13px; line-height: 1.5; color: #fff; text-align: left;
  cursor: pointer; transition: background 0.2s; position: relative;
}
.ai-box:active { background: rgba(167, 139, 250, 0.15); transform: scale(0.99); }
.ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.ai-title { font-weight: 700; color: var(--purple); text-transform:uppercase; font-size:11px; letter-spacing:0.05em;}
.ai-icon { font-size: 10px; color: var(--purple); transition: transform 0.2s; }
.ai-details {
  margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(167, 139, 250, 0.2);
  font-size: 12px; color: rgba(255,255,255,0.85); line-height: 1.5;
}
.ai-box.expanded .ai-icon { transform: rotate(180deg); }

.insight-grid { display: grid; gap: 12px; margin-bottom: 16px; }
.insight-box {
  background: rgba(255,255,255,0.03); padding: 12px; border-radius: 8px;
  border: 1px solid rgba(255,255,255,0.05); text-align: left;
}
.insight-title { font-size: 11px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px; }
.insight-tags { display: flex; flex-wrap: wrap; gap: 6px; }
.tag {
  font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 4px;
  background: rgba(255,255,255,0.1); color: #fff;
}
.tag.good { background: rgba(16,185,129,0.2); color: var(--green); }
.tag.bad { background: rgba(239,68,68,0.2); color: var(--red); }
.tag.warn { background: rgba(251,191,36,0.2); color: var(--yellow); }

.metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 16px; }
.metric { background: rgba(0,0,0,0.3); padding: 12px; border-radius: 12px; text-align: center; }
.metric-lbl { font-size: 9px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;}
.metric-val { font-size: 13px; font-weight: 600; color: #fff; }

.reason-bullets { margin-left: 16px; color: rgba(255,255,255,0.7); font-size: 13px; line-height: 1.5; }
.reason-bullets li { margin-bottom: 8px; padding-left: 4px; }

/* Settings */
#settingsPage, #historyPage {
  position: fixed; top: 0; bottom: 0;
  left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 480px; 
  background: var(--bg); z-index: 3000; padding: 24px;
  display: flex; flex-direction: column;
  border-left: 1px solid var(--border); border-right: 1px solid var(--border);
}
.settings-header { font-size: 20px; font-weight: 800; margin-bottom: 24px; text-align: center; }
.settings-content { flex: 1; overflow-y: auto; }
.settings-group { margin-bottom: 24px; }
.label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 8px; color: var(--muted); text-transform: uppercase; }
.settings-input { 
  width: 100%; padding: 14px; background: var(--panel); 
  border: 1px solid var(--border); color: white; border-radius: 12px; 
  font-family: 'JetBrains Mono', monospace;
}
.settings-input:focus { border-color: var(--blue); outline: none; }

.btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: auto; }
.btn-main { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 14px; cursor: pointer; }
.btn-save { background: var(--green); color: #000; }
.btn-back { background: var(--panel); color: #fff; border: 1px solid var(--border); }

.toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.toggle-switch {
  position: relative; width: 44px; height: 24px; background: #333; border-radius: 12px; cursor: pointer;
}
.toggle-switch.active { background: var(--green); }
.toggle-switch::after {
  content: ''; position: absolute; left: 2px; top: 2px; width: 20px; height: 20px;
  background: white; border-radius: 50%; transition: left 0.2s;
}
.toggle-switch.active::after { left: 22px; }

.actions {
  position: fixed; bottom: 0; left: 0; right: 0;
  background: rgba(5,5,5,0.9); backdrop-filter: blur(10px);
  padding: 16px; border-top: 1px solid var(--border);
  display: flex; gap: 12px; z-index: 100; max-width: 480px; margin: 0 auto;
}
.act-btn { flex: 1; padding: 14px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 14px; transition: transform 0.1s; }
.act-btn:active { transform: scale(0.96); }
.btn-set { flex: 0 0 50px; background: var(--panel); color: #fff; border: 1px solid var(--border); display: grid; place-items: center; font-size: 20px; }
.btn-hist { background: var(--blue); color: #fff; }
.btn-dl { background: var(--green); color: #fff; } 
.btn-clr { background: var(--red); color: #fff; }

.hidden { display: none !important; }
</style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-bg">
        <img src="https://images.unsplash.com/photo-1521587760476-6c12a4b040da?q=80&w=1000&auto=format&fit=crop" alt="Background">
        <div style="position:absolute; inset:0; bg:black; opacity:0.6;"></div>
    </div>
    <div class="splash-content">
        <h1 class="big-title">
            <span>PRETTY</span>
            <span>GOOD</span>
            <span>SOURCING</span>
            <span>APP</span>
        </h1>
        <div style="margin-top: 2rem; color: #888; letter-spacing: 0.2em; font-size: 0.8rem; font-weight: 600;">INITIALIZING...</div>
    </div>
</div>

<div class="app">

  <div id="mainView">
    <header>
      <div class="search-wrapper">
        <div class="brand-badges">
            <div class="badge" id="keepaBadge"><div class="status-dot"></div>KEEPA</div>
            <div class="badge" id="geminiBadge"><div class="status-dot"></div>GEMINI</div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-barcode search-icon"></i>
            <input id="scanInput" type="text" placeholder="Scan ISBN..." autocomplete="off" />
        </div>
      </div>
    </header>

    <div id="statusText">Ready to scan</div>

    <div id="processing" class="hidden" style="text-align:center; padding:40px;">
      <div class="spinner" style="border:3px solid var(--border); border-top-color:var(--blue); border-radius:50%; width:30px; height:30px; margin:0 auto 16px; animation:spin 1s linear infinite;"></div>
      <div style="color:var(--muted); font-size:14px;">Analyzing market structure...</div>
      <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    </div>

    <div class="card hidden" id="resultCard">
      <div id="banner" class="banner buy">
        
        <div id="gemBadge" class="gem-icon" style="display:none;">üíé</div>

        <div class="score-container">
          <svg class="score-svg" viewBox="0 0 100 100">
            <circle class="score-circle-bg" cx="50" cy="50" r="45" fill="none"></circle>
            <circle class="score-circle-fg" id="scoreRing" cx="50" cy="50" r="45" fill="none"></circle>
          </svg>
          <span id="confidence" class="score-num">‚Äî</span>
        </div>
        
        <div id="decision" class="decision-label">BUY</div>

        <div class="condition-toggle">
          <div id="btnCondUsed" class="cond-btn active" onclick="setCondition('USED')">Used</div>
          <div id="btnCondNew" class="cond-btn" onclick="setCondition('NEW')">New</div>
        </div>

        <div class="slider-container">
          <div class="slider-row">
            <div class="slider-header"><span>Buy Cost</span><span class="slider-val">$<span id="costValDisp">1.00</span></span></div>
            <input type="range" min="0" max="20" step="0.25" id="sliderCost" value="1.00" />
          </div>
          <div class="slider-row">
            <div class="slider-header"><span>Profit Floor</span><span class="slider-val">$<span id="floorValDisp">5.00</span></span></div>
            <input type="range" min="1" max="20" step="1" id="sliderFloor" value="5" />
          </div>
        </div>

        <div class="profit-display">
          <span class="profit-label">NET PROFIT</span>
          <span id="profit" class="profit-val">‚Äî</span>
        </div>

        <div id="itemTitle" class="item-title">‚Äî</div>
        
        <div class="link-row">
          <button id="linkAmz" class="ext-link">Open Offers ‚Üó</button>
          <button id="linkKeepa" class="ext-link" onclick="toggleKeepa()">View Graph üìâ</button>
        </div>

        <div id="keepaGraphContainer" class="keepa-embed hidden">
          <div style="text-align:center; padding:10px; color:#333; font-size:12px;">Loading Graph...</div>
        </div>

        <details class="details-panel">
          <summary class="details-summary">Details &amp; Reasoning</summary>
          <div class="details-body">
            
            <div id="gemSummary" style="background:rgba(251,191,36,0.1); color:#fbbf24; padding:12px; border-radius:8px; font-size:13px; margin-bottom:16px; border:1px solid rgba(251,191,36,0.2); display:none;"></div>

            <div id="aiRecBox" class="ai-box hidden" onclick="toggleAI()">
              <div class="ai-header">
                <span class="ai-title"><i class="fas fa-sparkles"></i> Gemini Insight</span>
                <span class="ai-icon">‚ñº</span>
              </div>
              <div id="aiRecText">Tap to analyze...</div>
              <div id="aiRecDetails" class="ai-details hidden"></div>
            </div>

            <div class="insight-grid">
              <div class="insight-box">
                <div class="insight-title">Is this safe?</div>
                <div class="insight-tags" id="qualityTags"></div>
              </div>
              <div class="insight-box">
                <div class="insight-title">Which way is it trending?</div>
                <div class="insight-tags" id="trendTags"></div>
              </div>
              <div class="insight-box">
                <div class="insight-title">Why buy this?</div>
                <div class="insight-tags" id="oppTags"></div>
              </div>
            </div>

            <div class="metrics-grid">
              <div class="metric"><div class="metric-lbl">Target Price</div><div class="metric-val" id="targetPrice">‚Äî</div></div>
              <div class="metric"><div class="metric-lbl">Avg Rank</div><div class="metric-val" id="rank">‚Äî</div></div>
              <div class="metric"><div class="metric-lbl">30d Activity</div><div class="metric-val" id="drops30">‚Äî</div></div>
              <div class="metric"><div class="metric-lbl">FBA Offers</div><div class="metric-val" id="fbaCount">‚Äî</div></div>
            </div>

            <ul id="reasonBullets" class="reason-bullets"></ul>
          </div>
        </details>
      </div>
    </div>
  </div>

  <div id="settingsPage" class="hidden">
    <div class="settings-header">Settings</div>
    <div class="settings-content">
      <div class="settings-group">
        <span class="label">Keepa API Key</span>
        <input type="password" id="keepaKey" class="settings-input" placeholder="Paste Keepa key..." />
      </div>

      <div class="settings-group">
        <span class="label">Gemini API Key</span>
        <input type="password" id="geminiKey" class="settings-input" placeholder="Paste Gemini API key..." />
      </div>
      
      <div class="settings-group">
        <div class="toggle-row">
          <span class="label" style="margin:0;">Use Proxy Server</span>
          <div id="toggleProxy" class="toggle-switch active" onclick="toggleSetting('useProxy')"></div>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px;">Turn OFF if you have a CORS extension installed. Direct is faster.</div>
      </div>

      <div class="settings-group">
        <div class="toggle-row">
          <span class="label" style="margin:0;">Fast Scan (90 Days)</span>
          <div id="toggleFastScan" class="toggle-switch" onclick="toggleSetting('fastScan')"></div>
        </div>
        <div style="font-size:11px; color:var(--muted); margin-top:4px;">Fetches less data for speed. Good for live scanning.</div>
      </div>

      <div class="settings-group">
        <span class="label">Default Buy Cost ($)</span>
        <input type="number" id="defBuyCost" class="settings-input" value="1.00" step="0.25" />
      </div>
      <div class="settings-group">
        <span class="label">Default Profit Floor ($)</span>
        <input type="number" id="defProfitFloor" class="settings-input" value="5.00" step="0.50" />
      </div>
    </div>
    <div class="btn-grid">
      <button id="closeSettings" class="btn-main btn-back">Cancel</button>
      <button id="saveSettings" class="btn-main btn-save">Save</button>
    </div>
  </div>

  <div id="historyPage" class="hidden">
    <div class="settings-header">Scan History</div>
    <div id="historyList" style="flex:1; overflow-y:auto;"></div>
    <button id="closeHistory" class="btn-main btn-back" style="margin-top:16px;">Back</button>
  </div>

  <div class="actions">
    <button id="btnSettings" class="act-btn btn-set">‚öôÔ∏è</button>
    <button id="btnHist" class="act-btn btn-hist">History</button>
    <button id="btnDl" class="act-btn btn-dl">CSV</button>
    <button id="btnClr" class="act-btn btn-clr">Clear</button>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
let CONFIG = {
  keepaKey: localStorage.getItem('keepaKey') || '',
  geminiKey: localStorage.getItem('geminiKey') || '',
  defaultProfit: parseFloat(localStorage.getItem('defaultProfit')) || 5.00,
  defaultCost: parseFloat(localStorage.getItem('defaultCost')) || 1.00,
  inboundShip: parseFloat(localStorage.getItem('inboundShip')) || 0.30,
  condition: localStorage.getItem('condition') || 'USED',
  useProxy: localStorage.getItem('useProxy') !== 'false', 
  fastScan: localStorage.getItem('fastScan') === 'true' 
};

// State
let currentCost = CONFIG.defaultCost;
let currentFloor = CONFIG.defaultProfit;
let lastData = null; 
let scanTimer = null;
let scanHistory = [];

/* --- SPLASH LOGIC --- */
window.addEventListener('load', () => {
    const splash = document.getElementById('splash-screen');
    setTimeout(() => {
        splash.classList.add('splash-hidden');
    }, 2500);
});

const scanInput = document.getElementById('scanInput');
const costSlider = document.getElementById('sliderCost');
const floorSlider = document.getElementById('sliderFloor');
const costDisp = document.getElementById('costValDisp');
const floorDisp = document.getElementById('floorValDisp');

function init() {
  document.getElementById('keepaKey').value = CONFIG.keepaKey;
  document.getElementById('geminiKey').value = CONFIG.geminiKey;
  document.getElementById('defBuyCost').value = CONFIG.defaultCost;
  document.getElementById('defProfitFloor').value = CONFIG.defaultProfit;
  
  if(CONFIG.keepaKey) document.getElementById('keepaBadge').classList.add('active');
  if(CONFIG.geminiKey) document.getElementById('geminiBadge').classList.add('active-gem');
  
  updateToggleUI('toggleProxy', CONFIG.useProxy);
  updateToggleUI('toggleFastScan', CONFIG.fastScan);

  resetSlidersToDefault();
  updateConditionUI();
  scanInput.focus();
}

function resetSlidersToDefault() {
  currentCost = CONFIG.defaultCost;
  currentFloor = CONFIG.defaultProfit;
  costSlider.value = currentCost;
  floorSlider.value = currentFloor;
  costDisp.innerText = currentCost.toFixed(2);
  floorDisp.innerText = currentFloor.toFixed(2);
}

function updateConditionUI() {
  if(CONFIG.condition === 'NEW') {
    document.getElementById('btnCondNew').classList.add('active');
    document.getElementById('btnCondUsed').classList.remove('active');
  } else {
    document.getElementById('btnCondUsed').classList.add('active');
    document.getElementById('btnCondNew').classList.remove('active');
  }
}

function updateToggleUI(id, state) {
  const el = document.getElementById(id);
  if(state) el.classList.add('active');
  else el.classList.remove('active');
}

function toggleSetting(key) {
  CONFIG[key] = !CONFIG[key];
  updateToggleUI(key === 'useProxy' ? 'toggleProxy' : 'toggleFastScan', CONFIG[key]);
}

init();

function setCondition(mode) {
  CONFIG.condition = mode;
  localStorage.setItem('condition', mode);
  updateConditionUI();
  if(lastData) {
    const result = analyze(lastData);
    render(result, lastData);
  }
}

function toggleKeepa() {
  const container = document.getElementById('keepaGraphContainer');
  const btn = document.getElementById('linkKeepa');
  if(container.classList.contains('hidden')) {
    if(lastData && lastData.asin) {
      container.innerHTML = `
        <img src="https://graph.keepa.com/pricehistory.png?asin=${lastData.asin}&domain=1&t=${Date.now()}" alt="Keepa Graph" />
        <div class="graph-legend">
          <span><span class="dot" style="background:#ff9900;"></span> Amazon</span>
          <span><span class="dot" style="background:#8888ff;"></span> New</span>
          <span><span class="dot" style="background:#000;"></span> Used</span>
          <span><span class="dot" style="background:#44cc44;"></span> Rank</span>
        </div>
      `;
      container.classList.remove('hidden');
      btn.innerText = "Close Graph ‚úñ";
    }
  } else {
    container.classList.add('hidden');
    btn.innerText = "View Graph üìâ";
  }
}

/* ================= NAVIGATION ================= */
const views = {
  main: document.getElementById('mainView'),
  settings: document.getElementById('settingsPage'),
  history: document.getElementById('historyPage')
};

function showView(viewName) {
  Object.values(views).forEach(el => el.classList.add('hidden'));
  if(viewName === 'settings') views.settings.classList.remove('hidden');
  else if(viewName === 'history') views.history.classList.remove('hidden');
  else views.main.classList.remove('hidden');
}

document.getElementById('btnSettings').onclick = () => showView('settings');
document.getElementById('closeSettings').onclick = () => showView('main');
document.getElementById('btnHist').onclick = () => showView('history');
document.getElementById('closeHistory').onclick = () => showView('main');

document.getElementById('saveSettings').onclick = () => {
  CONFIG.keepaKey = document.getElementById('keepaKey').value.trim();
  CONFIG.geminiKey = document.getElementById('geminiKey').value.trim();
  CONFIG.defaultCost = parseFloat(document.getElementById('defBuyCost').value);
  CONFIG.defaultProfit = parseFloat(document.getElementById('defProfitFloor').value);
  
  localStorage.setItem('keepaKey', CONFIG.keepaKey);
  localStorage.setItem('geminiKey', CONFIG.geminiKey);
  localStorage.setItem('defaultCost', CONFIG.defaultCost);
  localStorage.setItem('defaultProfit', CONFIG.defaultProfit);
  localStorage.setItem('useProxy', CONFIG.useProxy);
  localStorage.setItem('fastScan', CONFIG.fastScan);
  
  document.getElementById('keepaBadge').classList.toggle('active', !!CONFIG.keepaKey);
  document.getElementById('geminiBadge').classList.toggle('active-gem', !!CONFIG.geminiKey);
  
  if(lastData) {
    const result = analyze(lastData);
    render(result, lastData);
  }
  showView('main');
};

document.getElementById('btnClr').onclick = () => {
  scanInput.value = '';
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('statusText').classList.remove('hidden');
  scanInput.focus();
  lastData = null;
  resetSlidersToDefault();
};

/* ================= SLIDERS ================= */
function onSliderChange() {
  currentCost = parseFloat(costSlider.value);
  currentFloor = parseFloat(floorSlider.value);
  costDisp.innerText = currentCost.toFixed(2);
  floorDisp.innerText = currentFloor.toFixed(2);
  if(lastData) {
    const result = analyze(lastData);
    render(result, lastData);
  }
}
costSlider.addEventListener('input', onSliderChange);
floorSlider.addEventListener('input', onSliderChange);

/* ================= SCANNER LOGIC ================= */
scanInput.oninput = () => {
  clearTimeout(scanTimer);
  scanTimer = setTimeout(() => {
    const val = scanInput.value.trim();
    if(val.length >= 10) handleScan(val);
  }, 100);
};

scanInput.onkeydown = (e) => {
  if(e.key === 'Enter') {
    e.preventDefault();
    if(scanInput.value.trim().length > 0) handleScan(scanInput.value);
  }
};

async function handleScan(input) {
  const clean = input.replace(/[^0-9X]/gi, '').trim();
  scanInput.value = '';
  if(!clean) return;
  
  resetSlidersToDefault();
  document.getElementById('processing').classList.remove('hidden');
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('statusText').classList.add('hidden');
  
  document.getElementById('aiRecBox').classList.remove('expanded');
  document.getElementById('aiRecDetails').classList.add('hidden');
  document.getElementById('keepaGraphContainer').classList.add('hidden');
  document.getElementById('linkKeepa').innerText = "View Graph üìâ";

  // Reset Gemini Text
  document.getElementById('aiRecText').innerText = "Tap to analyze...";
  // Set to special flag so we know it's empty
  document.getElementById('aiRecDetails').dataset.status = "empty"; 
  document.getElementById('aiRecDetails').innerText = "";

  try {
    const data = await fetchKeepa(clean);
    lastData = data;
    const result = analyze(data);
    
    render(result, data);
    addToHistory(result, data);
    document.getElementById('processing').classList.add('hidden');
  } catch(e) {
    document.getElementById('processing').classList.add('hidden');
    
    const banner = document.getElementById('banner');
    banner.className = 'banner error';
    const ring = document.getElementById('scoreRing');
    ring.style.strokeDashoffset = 283; 
    ring.style.color = 'var(--red)';
    document.getElementById('confidence').innerText = "!";
    document.getElementById('decision').innerText = "ERROR";
    document.getElementById('itemTitle').innerText = "Scan Failed";
    document.getElementById('profit').innerText = "‚Äî";
    
    const ul = document.getElementById('reasonBullets');
    ul.innerHTML = `<li style="color:var(--red); font-weight:700;">${e.message}</li><li>Try disabling proxy in settings if using an extension.</li>`;
    
    document.getElementById('resultCard').classList.remove('hidden');
  }
}

/* ================= ANALYSIS ================= */
function analyze(data) {
  const inboundFee = data.weight * CONFIG.inboundShip;
  const fbaFees = 1.80 + (data.weight > 1 ? 4.00 : 3.20) + inboundFee; 
  const referral = (data.priceFBA || 20) * 0.15;
  const totalFees = fbaFees + referral;

  let market = 0;
  if(CONFIG.condition === 'NEW') {
    // 1. Check current prices
    market = data.priceBuyBox || data.priceAmazon || data.priceFBA || data.priceNew || 0;
    
    // 2. Fallback to 90-day Average if current is $0 (Out of Stock)
    if (market === 0 && data.avgNew90 > 0) {
        market = data.avgNew90;
    }
  } else {
    // USED Logic
    if(data.priceFBA > 0) market = data.priceFBA;
    else if(data.priceBuyBox > 0) market = data.priceBuyBox;
    else if(data.priceUsed > 0) market = data.priceUsed + 4.00; 
    else if(data.priceNew > 0) market = data.priceNew * 0.8; 
    
    // Fallback for Used
    if (market === 0 && data.avgUsed90 > 0) {
        market = data.avgUsed90 + 4.00; // estimated ship
    }
  }

  const profit = market - totalFees - currentCost;
  
  let baseScore = 0;
  if(profit > 0) baseScore += Math.min(30, (profit / currentFloor) * 15);
  
  const weightedDrops = (data.drops30 * 6 + data.drops90 * 3 + data.drops365) / 10;
  if(weightedDrops > 30) baseScore += 30;
  else baseScore += weightedDrops;

  let qualityScore = 0;
  const qualityTags = [];
  if(data.rank < 100000 && weightedDrops > 10) { qualityScore += 5; qualityTags.push({text: "Steady Seller", type: "good"}); }
  if(data.drops30 > 5 && (data.drops30 / (data.drops90/3)) > 0.8) { qualityScore += 5; qualityTags.push({text: "Consistent Demand", type: "good"}); } 
  else if (data.drops30 === 0 && data.drops90 > 10) { qualityScore -= 5; qualityTags.push({text: "Demand Dropping", type: "bad"}); }

  let oppScore = 0;
  const oppTags = [];
  const trendTags = [];
  const monthlyAvg = data.drops365 / 12;
  if(monthlyAvg > 0) {
    const momentum = data.drops30 / monthlyAvg;
    if(momentum > 1.2) { oppScore += 10; trendTags.push({text: "Heating Up", type: "good"}); } 
    else if(momentum < 0.8) { trendTags.push({text: "Cooling Down", type: "bad"}); } 
    else { trendTags.push({text: "Stable", type: "warn"}); }
  }

  if(data.priceUsed < 10 && data.priceFBA > 25) { oppScore += 5; oppTags.push({text: "Prime Price Gap", type: "good"}); }

  let totalScore = baseScore + qualityScore + oppScore;
  let verdict = 'REJECT';

  if(profit < 0) {
    verdict = 'REJECT';
    totalScore = Math.max(0, 49 - Math.abs(profit));
  } else if(profit >= currentFloor && weightedDrops > 1) {
    verdict = 'BUY';
    totalScore = Math.max(75, Math.min(99, totalScore + 20));
  } else {
    verdict = 'MAYBE';
    totalScore = Math.max(50, Math.min(74, totalScore));
  }

  let gemReason = null;
  if(profit > 15 && data.drops30 === 0 && data.drops365 > 4) {
    gemReason = "Long Tail Gem";
    verdict = "BUY"; 
    totalScore = 80;
    oppTags.push({text: "Long Tail Gem", type: "good"});
  }

  if(verdict === 'BUY' && oppTags.length === 0) oppTags.push({text: "Strong Fundamentals", type: "good"});

  return { verdict, profit, score: Math.round(totalScore), gemReason, market, qualityTags, trendTags, oppTags };
}

/* ================= UI INTERACTION ================= */
async function toggleAI() {
  const box = document.getElementById('aiRecBox');
  const details = document.getElementById('aiRecDetails');
  const txt = document.getElementById('aiRecText');
  
  const isExpanded = box.classList.contains('expanded');
  box.classList.toggle('expanded');
  details.classList.toggle('hidden');

  // Trigger if opening AND (empty OR implies fallback text)
  const isFallback = details.innerText.includes("Basic Insight");
  const isEmpty = details.dataset.status === "empty" || !details.dataset.status;
  
  if (!isExpanded && (isEmpty || isFallback)) {
    if(!CONFIG.geminiKey) {
        getSecondOpinionLocal();
        return;
    }
    
    // UI Loading State
    txt.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Asking Gemini...';
    
    // SMART RETRY LOGIC
    // We try models in order of likelihood to succeed
    const models = [
        'gemini-1.5-flash', 
        'gemini-1.5-flash-001',
        'gemini-1.5-pro',
        'gemini-pro'
    ];
    
    const p = lastData;
    const prompt = `Act as an expert Amazon book flipper. 
    Book: "${p.title}"
    Sales Rank: ${p.rank}
    30-Day Sales: ${p.drops30}
    New Price: $${p.priceNew}
    Used Price: $${p.priceUsed}
    Amazon Price: $${p.priceAmazon}
    Avg 90 Days New: $${p.avgNew90}
    
    Is this a good buy for resale? Give a one sentence bold verdict, then a short explanation.`;

    let success = false;
    let finalError = "";

    for (const model of models) {
        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${CONFIG.geminiKey}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const json = await response.json();
            
            if (json.error) throw new Error(json.error.message);
            
            if (json.candidates && json.candidates[0].content) {
                const md = json.candidates[0].content.parts[0].text;
                const formatted = md.replace(/\*\*(.*?)\*\*/g, '<strong style="color:var(--purple)">$1</strong>');
                txt.innerHTML = "Gemini Analysis Complete";
                details.innerHTML = formatted;
                details.dataset.status = "filled"; 
                success = true;
                break; // Stop looping if successful
            }
        } catch(e) {
            console.warn(`Model ${model} failed:`, e);
            finalError = e.message;
        }
    }

    if (!success) {
        txt.innerText = "Error: Check Console/Key";
        details.innerHTML = `<span style="color:var(--red)">API Error: ${finalError}. Tried 4 different models. Check your API key permissions.</span>`;
    }
  }
}

function getSecondOpinionLocal() {
  const txt = document.getElementById('aiRecText');
  const det = document.getElementById('aiRecDetails');
  const res = analyze(lastData);
  let rec = "PASS";
  let why = "Risk profile too high.";
  if(res.profit > 0 && lastData.drops30 > 5) { rec = "BUY"; why = `Profit ($${res.profit.toFixed(2)}) is low, but high velocity.`; }
  
  txt.innerHTML = `Basic Insight (Add Key for AI)`;
  det.innerHTML = `<strong style="color:${rec==='BUY'?'var(--green)':'var(--red)'}">${rec}</strong>: ${why}`;
}

function render(res, data) {
  const banner = document.getElementById('banner');
  banner.className = `banner ${res.verdict.toLowerCase()}`;
  document.getElementById('decision').innerText = res.verdict;
  document.getElementById('confidence').innerText = res.score;
  
  const ring = document.getElementById('scoreRing');
  const offset = 283 - (283 * res.score / 100);
  ring.style.strokeDashoffset = offset;
  
  let color = 'var(--red)';
  if(res.verdict === 'BUY') color = 'var(--green)';
  if(res.verdict === 'MAYBE') color = 'var(--yellow)';
  ring.style.color = color;

  const profitEl = document.getElementById('profit');
  profitEl.innerText = `$${res.profit.toFixed(2)}`;
  profitEl.style.color = res.profit > 0 ? 'var(--green)' : 'var(--red)';

  document.getElementById('itemTitle').innerText = data.title;
  document.getElementById('targetPrice').innerText = `$${res.market.toFixed(2)}`;
  document.getElementById('rank').innerText = (data.rank/1000).toFixed(0) + 'k';
  document.getElementById('drops30').innerText = data.drops30;
  document.getElementById('fbaCount').innerText = data.offerCountFBA;

  document.getElementById('linkAmz').onclick = () => window.open(`https://www.amazon.com/gp/offer-listing/${data.asin}/ref=olp_f_new?ie=UTF8&f_new=true`, '_blank');

  document.getElementById('gemBadge').style.display = res.gemReason ? 'block' : 'none';
  document.getElementById('aiRecBox').classList.remove('hidden');

  renderTags('qualityTags', res.qualityTags);
  renderTags('trendTags', res.trendTags);
  renderTags('oppTags', res.oppTags);

  document.getElementById('resultCard').classList.remove('hidden');
}

function renderTags(id, tags) {
  const container = document.getElementById(id);
  container.innerHTML = '';
  if(!tags.length) { container.innerHTML = '<span style="font-size:11px; color:#555;">No signals</span>'; return; }
  tags.forEach(t => {
    const span = document.createElement('span');
    span.className = `tag ${t.type}`;
    span.innerText = t.text;
    container.appendChild(span);
  });
}

/* ================= DATA FETCH ================= */
async function fetchKeepa(code) {
  if(!CONFIG.keepaKey) return mockKeepa(code);
  const type = (code.length === 10 || code.startsWith('97')) ? 'code' : 'asin';
  const days = CONFIG.fastScan ? 90 : 365; 
  
  let targetUrl = `https://api.keepa.com/product?key=${CONFIG.keepaKey}&domain=1&${type}=${code}&stats=${days}&history=0`;
  
  if(CONFIG.useProxy) {
    targetUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
  }

  const res = await fetch(targetUrl);
  if(!res.ok) throw new Error("Keepa Error: " + res.status);
  const json = await res.json();
  if(!json.products || !json.products.length) throw new Error('Product not found');
  return parseProduct(json.products[0]);
}

function parseProduct(p) {
  const s = p.stats.current;
  const avg90 = p.stats.avg90 || [];
  const toVal = (v) => (v == -1 || v == null) ? 0 : v;
  const toPrice = (v) => toVal(v) / 100;

  return {
    title: p.title || "Unknown Title",
    asin: p.asin,
    rank: toVal(s[3]) || 999999,
    drops30: p.stats.salesRankDrops30 || 0,
    drops90: p.stats.salesRankDrops90 || 0,
    drops365: p.stats.salesRankDrops365 || 0, 
    
    // Current Prices
    priceAmazon: toPrice(s[0]),
    priceNew: toPrice(s[1]),
    priceUsed: toPrice(s[2]),
    priceFBA: toPrice(s[10]),
    priceBuyBox: toPrice(s[18]),
    
    // 90 Day Averages (Indices map to Keepa standard)
    avgNew90: toPrice(avg90[1]),
    avgUsed90: toPrice(avg90[2]),

    offerCountFBA: toVal(s[11]),
    weight: p.packageWeight ? p.packageWeight / 100 : 1.0
  };
}

function mockKeepa(code) {
  return {
    title: "Mock Book (Pro Edition): " + code,
    asin: code,
    rank: 45000,
    drops30: 25,
    drops90: 80,
    drops365: 320,
    priceAmazon: 25.00,
    priceNew: 22.00,
    priceUsed: 15.00,
    priceFBA: 24.99,
    priceBuyBox: 24.99,
    avgNew90: 21.50,
    avgUsed90: 14.00,
    offerCountFBA: 5,
    weight: 1.2
  };
}

function addToHistory(res, data) {
  const item = { ...res, title: data.title };
  scanHistory.unshift(item);
  const list = document.getElementById('historyList');
  const div = document.createElement('div');
  div.style.padding = '12px';
  div.style.borderBottom = '1px solid var(--border)';
  
  let color = 'var(--red)';
  if(res.verdict === 'BUY') color = 'var(--green)';
  if(res.verdict === 'MAYBE') color = 'var(--yellow)';

  div.innerHTML = `
    <div style="display:flex; justify-content:space-between; font-weight:700;">
      <span style="color:${color}">${res.verdict}</span>
      <span>$${res.profit.toFixed(2)}</span>
    </div>
    <div style="font-size:12px; color:var(--muted); margin-top:4px;">${data.title.substring(0,40)}...</div>
  `;
  list.prepend(div);
}
</script>
</body>
</html>